<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
        This file is autogenerated from docs/drvnodedev.rst
        Do not edit this file. Changes will be lost.
      -->
  <!--
        This page was generated at Wed Apr 19 07:14:27 2023 UTC.
      -->
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="manifest" href="/manifest.json"/>
    <meta name="theme-color" content="#ffffff"/>
    <title>libvirt: Host device management</title>
    <meta name="description" content="libvirt, virtualization, virtualization API"/>
    <script type="text/javascript" src="js/main.js">
      <!--// forces non-empty element-->
    </script>
  </head>
  <body onload="pageload()">
    <div id="body">
      <div class="document" id="host-device-management">
<h1>Host device management</h1>

<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#basic-structure-of-a-node-device" id="id1">Basic structure of a node device</a></p></li>
<li><p><a class="reference internal" href="#pci-host-devices" id="id2">PCI host devices</a></p>
<ul>
<li><p><a class="reference internal" href="#sr-iov-capability" id="id3">SR-IOV capability</a></p></li>
<li><p><a class="reference internal" href="#mdev-capability" id="id4">MDEV capability</a></p></li>
<li><p><a class="reference internal" href="#vpd-capability" id="id5">VPD capability</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#mediated-devices-mdevs" id="id6">Mediated devices (MDEVs)</a></p>
<ul>
<li><p><a class="reference internal" href="#example-of-a-mediated-device" id="id7">Example of a mediated device</a></p></li>
</ul>
</li>
</ul>
</div>
<p>Libvirt provides management of both physical and virtual host devices
(historically also referred to as node devices) like USB, PCI, SCSI, and network
devices. This also includes various virtualization capabilities which the
aforementioned devices provide for utilization, for example SR-IOV, NPIV, MDEV,
DRM, etc.</p>
<p>The node device driver provides means to list and show details about host
devices (<span class="docutils literal">virsh <span class="pre">nodedev-list</span></span>, <span class="docutils literal">virsh <span class="pre">nodedev-info</span></span>, and
<span class="docutils literal">virsh <span class="pre">nodedev-dumpxml</span></span>), which are generic and can be used with all devices.
It also provides the means to manage virtual devices. Persistently-defined
virtual devices are only supported for mediated devices, while transient devices
are supported by both mediated devices and NPIV (<a class="reference external" href="https://wiki.libvirt.org/page/NPIV_in_libvirt">more info about
NPIV)</a>).</p>
<p>Persistent virtual devices are managed with <span class="docutils literal">virsh <span class="pre">nodedev-define</span></span> and
<span class="docutils literal">virsh <span class="pre">nodedev-undefine</span></span>. Persistent devices can be configured to start
manually or automatically using <span class="docutils literal">virsh <span class="pre">nodedev-autostart</span></span>. Inactive devices
can be made active with <span class="docutils literal">virsh <span class="pre">nodedev-start</span></span>.</p>
<p>Transient virtual devices are started and stopped with the commands
<span class="docutils literal">virsh <span class="pre">nodedev-create</span></span> and <span class="docutils literal">virsh <span class="pre">nodedev-destroy</span></span>.</p>
<p>Devices on the host system are arranged in a tree-like hierarchy, with the root
node being called <span class="docutils literal">computer</span>. The node device driver supports udev backend
(HAL backend was removed in <span class="docutils literal">6.8.0</span>).</p>
<p>Details of the XML format of a host device can be found
<a class="reference external" href="formatnode.html">here</a>. Of particular interest is the <span class="docutils literal">capability</span>
element, which describes features supported by the device. Some specific device
types are addressed in more detail below.</p>
<div class="section" id="basic-structure-of-a-node-device">
<h1><a class="toc-backref" href="#id1">Basic structure of a node device</a><a class="headerlink" href="#basic-structure-of-a-node-device" title="Link to this headline">¶</a></h1>
<pre class="literal-block">&lt;device&gt;
  &lt;name&gt;pci_0000_00_17_0&lt;/name&gt;
  &lt;path&gt;/sys/devices/pci0000:00/0000:00:17.0&lt;/path&gt;
  &lt;parent&gt;computer&lt;/parent&gt;
  &lt;driver&gt;
    &lt;name&gt;ahci&lt;/name&gt;
  &lt;/driver&gt;
  &lt;capability type='pci'&gt;
...
  &lt;/capability&gt;
&lt;/device&gt;</pre>
</div>
<div class="section" id="pci-host-devices">
<h1><a class="toc-backref" href="#id2">PCI host devices</a><a class="headerlink" href="#pci-host-devices" title="Link to this headline">¶</a></h1>
<dl class="simple">
<dt><span class="docutils literal">capability</span></dt>
<dd><p>When used as top level element, the supported values for the <span class="docutils literal">type</span>
attribute are <span class="docutils literal">pci</span> and <span class="docutils literal">phys_function</span> (see <a class="reference internal" href="#sr-iov-capability">SR-IOV capability</a> below).</p>
</dd>
</dl>
<pre class="literal-block">&lt;device&gt;
  &lt;name&gt;pci_0000_04_00_1&lt;/name&gt;
  &lt;path&gt;/sys/devices/pci0000:00/0000:00:06.0/0000:04:00.1&lt;/path&gt;
  &lt;parent&gt;pci_0000_00_06_0&lt;/parent&gt;
  &lt;driver&gt;
    &lt;name&gt;igb&lt;/name&gt;
  &lt;/driver&gt;
  &lt;capability type='pci'&gt;
    &lt;domain&gt;0&lt;/domain&gt;
    &lt;bus&gt;4&lt;/bus&gt;
    &lt;slot&gt;0&lt;/slot&gt;
    &lt;function&gt;1&lt;/function&gt;
    &lt;product id='0x10c9'&gt;82576 Gigabit Network Connection&lt;/product&gt;
    &lt;vendor id='0x8086'&gt;Intel Corporation&lt;/vendor&gt;
    &lt;iommuGroup number='15'&gt;
      &lt;address domain='0x0000' bus='0x04' slot='0x00' function='0x1'/&gt;
    &lt;/iommuGroup&gt;
    &lt;numa node='0'/&gt;
    &lt;pci-express&gt;
      &lt;link validity='cap' port='1' speed='2.5' width='2'/&gt;
      &lt;link validity='sta' speed='2.5' width='2'/&gt;
    &lt;/pci-express&gt;
  &lt;/capability&gt;
&lt;/device&gt;</pre>
<p>The XML format for a PCI device stays the same for any further capabilities it
supports, a single nested <span class="docutils literal">&lt;capability&gt;</span> element will be included for each
capability the device supports.</p>
<div class="section" id="sr-iov-capability">
<h2><a class="toc-backref" href="#id3">SR-IOV capability</a><a class="headerlink" href="#sr-iov-capability" title="Link to this headline">¶</a></h2>
<p>Single root input/output virtualization (SR-IOV) allows sharing of the PCIe
resources by multiple virtual environments. That is achieved by slicing up a
single full-featured physical resource called physical function (PF) into
multiple devices called virtual functions (VFs) sharing their configuration with
the underlying PF. Despite the SR-IOV specification, the amount of VFs that can
be created on a PF varies among manufacturers.</p>
<p>Suppose the NIC above in <a class="reference internal" href="#pci-host-devices">PCI host devices</a> was also SR-IOV capable, it would
also include a nested <span class="docutils literal">&lt;capability&gt;</span> element enumerating all virtual
functions available on the physical device (physical port) like in the example
below.</p>
<pre class="literal-block">&lt;capability type='pci'&gt;
...
  &lt;capability type='virt_functions' maxCount='7'&gt;
    &lt;address domain='0x0000' bus='0x04' slot='0x10' function='0x1'/&gt;
    &lt;address domain='0x0000' bus='0x04' slot='0x10' function='0x3'/&gt;
    &lt;address domain='0x0000' bus='0x04' slot='0x10' function='0x5'/&gt;
    &lt;address domain='0x0000' bus='0x04' slot='0x10' function='0x7'/&gt;
    &lt;address domain='0x0000' bus='0x04' slot='0x11' function='0x1'/&gt;
    &lt;address domain='0x0000' bus='0x04' slot='0x11' function='0x3'/&gt;
    &lt;address domain='0x0000' bus='0x04' slot='0x11' function='0x5'/&gt;
  &lt;/capability&gt;
...
&lt;/capability&gt;</pre>
<p>A SR-IOV child device on the other hand, would then report its top level
capability type as a <span class="docutils literal">phys_function</span> instead:</p>
<pre class="literal-block">&lt;device&gt;
...
  &lt;capability type='phys_function'&gt;
    &lt;address domain='0x0000' bus='0x04' slot='0x00' function='0x0'/&gt;
  &lt;/capability&gt;
...
&lt;/device&gt;</pre>
</div>
<div class="section" id="mdev-capability">
<h2><a class="toc-backref" href="#id4">MDEV capability</a><a class="headerlink" href="#mdev-capability" title="Link to this headline">¶</a></h2>
<p>A device capable of creating mediated devices will include a nested capability
<span class="docutils literal">mdev_types</span> which enumerates all supported mdev types on the physical device,
along with the type attributes available through sysfs. A detailed description
of the XML format for the <span class="docutils literal">mdev_types</span> capability can be found
<a class="reference external" href="formatnode.html#mdev-types-capability">here</a>.</p>
<p>The following example shows how we might represent an NVIDIA GPU device that
supports mediated devices. See below for more info on
<a class="reference internal" href="#mediated-devices-mdevs">Mediated devices (MDEVs)</a>.</p>
<pre class="literal-block">&lt;device&gt;
...
  &lt;driver&gt;
    &lt;name&gt;nvidia&lt;/name&gt;
  &lt;/driver&gt;
  &lt;capability type='pci'&gt;
...
    &lt;capability type='mdev_types'&gt;
      &lt;type id='nvidia-11'&gt;
        &lt;name&gt;GRID M60-0B&lt;/name&gt;
        &lt;deviceAPI&gt;vfio-pci&lt;/deviceAPI&gt;
        &lt;availableInstances&gt;16&lt;/availableInstances&gt;
      &lt;/type&gt;
      &lt;!-- Here would come the rest of the available mdev types --&gt;
    &lt;/capability&gt;
...
  &lt;/capability&gt;
&lt;/device&gt;</pre>
</div>
<div class="section" id="vpd-capability">
<h2><a class="toc-backref" href="#id5">VPD capability</a><a class="headerlink" href="#vpd-capability" title="Link to this headline">¶</a></h2>
<p>A device that exposes a PCI/PCIe VPD capability will include a nested capability
<span class="docutils literal">vpd</span> which presents data stored in the Vital Product Data (VPD). VPD provides
a device name and a number of other standard-defined read-only fields (change
level, manufacture id, part number, serial number) and vendor-specific read-only
fields. Additionally, if a device supports it, read-write fields (asset tag,
vendor-specific fields or system fields) may also be present. The VPD capability
is optional for PCI/PCIe devices and the set of exposed fields may vary
depending on a device. The XML format follows the binary format described in
"I.3. VPD Definitions" in PCI Local Bus (2.2+) and the identical format in PCIe
4.0+. At the time of writing, the support for exposing this capability is only
present on Linux-based systems (kernel version v2.6.26 is the first one to
expose VPD via sysfs which Libvirt relies on). Reading the VPD contents requires
root privileges, therefore, <span class="docutils literal">virsh <span class="pre">nodedev-dumpxml</span></span> must be executed
accordingly. A description of the XML format for the <span class="docutils literal">vpd</span> capability can be
found <a class="reference external" href="formatnode.html#vpd-capability">here</a>.</p>
<p>The following example shows a VPD representation for a device that exposes the
VPD capability with read-only and read-write fields. Among other things, the VPD
of this particular device includes a unique board serial number.</p>
<pre class="literal-block">&lt;device&gt;
  &lt;name&gt;pci_0000_42_00_0&lt;/name&gt;
  &lt;capability type='pci'&gt;
    &lt;class&gt;0x020000&lt;/class&gt;
    &lt;domain&gt;0&lt;/domain&gt;
    &lt;bus&gt;66&lt;/bus&gt;
    &lt;slot&gt;0&lt;/slot&gt;
    &lt;function&gt;0&lt;/function&gt;
    &lt;product id='0xa2d6'&gt;MT42822 BlueField-2 integrated ConnectX-6 Dx network controller&lt;/product&gt;
    &lt;vendor id='0x15b3'&gt;Mellanox Technologies&lt;/vendor&gt;
    &lt;capability type='virt_functions' maxCount='16'/&gt;
    &lt;capability type='vpd'&gt;
      &lt;name&gt;BlueField-2 DPU 25GbE Dual-Port SFP56, Crypto Enabled, 16GB on-board DDR, 1GbE OOB management, Tall Bracket&lt;/name&gt;
      &lt;fields access='readonly'&gt;
        &lt;change_level&gt;B1&lt;/change_level&gt;
        &lt;manufacture_id&gt;foobar&lt;/manufacture_id&gt;
        &lt;part_number&gt;MBF2H332A-AEEOT&lt;/part_number&gt;
        &lt;serial_number&gt;MT2113X00000&lt;/serial_number&gt;
        &lt;vendor_field index='0'&gt;PCIeGen4 x8&lt;/vendor_field&gt;
        &lt;vendor_field index='2'&gt;MBF2H332A-AEEOT&lt;/vendor_field&gt;
        &lt;vendor_field index='3'&gt;3c53d07eec484d8aab34dabd24fe575aa&lt;/vendor_field&gt;
        &lt;vendor_field index='A'&gt;MLX:MN=MLNX:CSKU=V2:UUID=V3:PCI=V0:MODL=BF2H332A&lt;/vendor_field&gt;
      &lt;/fields&gt;
      &lt;fields access='readwrite'&gt;
        &lt;asset_tag&gt;fooasset&lt;/asset_tag&gt;
        &lt;vendor_field index='0'&gt;vendorfield0&lt;/vendor_field&gt;
        &lt;vendor_field index='2'&gt;vendorfield2&lt;/vendor_field&gt;
        &lt;vendor_field index='A'&gt;vendorfieldA&lt;/vendor_field&gt;
        &lt;system_field index='B'&gt;systemfieldB&lt;/system_field&gt;
        &lt;system_field index='0'&gt;systemfield0&lt;/system_field&gt;
      &lt;/fields&gt;
    &lt;/capability&gt;
    &lt;iommuGroup number='65'&gt;
      &lt;address domain='0x0000' bus='0x42' slot='0x00' function='0x0'/&gt;
    &lt;/iommuGroup&gt;
    &lt;numa node='0'/&gt;
    &lt;pci-express&gt;
      &lt;link validity='cap' port='0' speed='16' width='8'/&gt;
      &lt;link validity='sta' speed='8' width='8'/&gt;
    &lt;/pci-express&gt;
  &lt;/capability&gt;
&lt;/device&gt;</pre>
</div>
</div>
<div class="section" id="mediated-devices-mdevs">
<h1><a class="toc-backref" href="#id6">Mediated devices (MDEVs)</a><a class="headerlink" href="#mediated-devices-mdevs" title="Link to this headline">¶</a></h1>
<p>Mediated devices ( <span class="since">Since 3.2.0</span> ) are software devices defining resource
allocation on the backing physical device which in turn allows the parent
physical device's resources to be divided into several mediated devices, thus
sharing the physical device's performance among multiple guests. Unlike SR-IOV
however, where a PCIe device appears as multiple separate PCIe devices on the
host's PCI bus, mediated devices only appear on the mdev virtual bus. Therefore,
no detach/reattach procedure from/to the host driver procedure is involved even
though mediated devices are used in a direct device assignment manner. A
detailed description of the XML format for the <span class="docutils literal">mdev</span> capability can be found
<a class="reference external" href="formatnode.html#mdev">here</a>.</p>
<div class="section" id="example-of-a-mediated-device">
<h2><a class="toc-backref" href="#id7">Example of a mediated device</a><a class="headerlink" href="#example-of-a-mediated-device" title="Link to this headline">¶</a></h2>
<pre class="literal-block">&lt;device&gt;
  &lt;name&gt;mdev_4b20d080_1b54_4048_85b3_a6a62d165c01&lt;/name&gt;
  &lt;path&gt;/sys/devices/pci0000:00/0000:00:02.0/4b20d080-1b54-4048-85b3-a6a62d165c01&lt;/path&gt;
  &lt;parent&gt;pci_0000_06_00_0&lt;/parent&gt;
  &lt;driver&gt;
    &lt;name&gt;vfio_mdev&lt;/name&gt;
  &lt;/driver&gt;
  &lt;capability type='mdev'&gt;
    &lt;type id='nvidia-11'/&gt;
    &lt;uuid&gt;4b20d080-1b54-4048-85b3-a6a62d165c01&lt;/uuid&gt;
    &lt;iommuGroup number='12'/&gt;
  &lt;/capability&gt;
&lt;/device&gt;</pre>
<p>The support of mediated device's framework in libvirt's node device driver
covers the following features:</p>
<ul class="simple">
<li><p>list available mediated devices on the host ( <span class="since">Since 3.4.0</span> )</p></li>
<li><p>display device details ( <span class="since">Since 3.4.0</span> )</p></li>
<li><p>create transient mediated devices ( <span class="since">Since 6.5.0</span> )</p></li>
<li><p>define persistent mediated devices ( <span class="since">Since 7.3.0</span> )</p></li>
</ul>
<p>Because mediated devices are instantiated from vendor specific templates, simply
called 'types', information describing these types is contained within the
parent device's capabilities (see the example in <a class="reference internal" href="#pci-host-devices">PCI host devices</a>).
To list all devices capable of creating mediated devices, the following command
can be used.</p>
<pre class="literal-block">$ virsh nodedev-list --cap mdev_types</pre>
<p>To see the supported mediated device types on a specific physical device use the
following:</p>
<pre class="literal-block">$ virsh nodedev-dumpxml &lt;device&gt;</pre>
<p>Before creating a mediated device, unbind the device from the respective device
driver, eg. subchannel I/O driver for a CCW device. Then bind the device to the
respective VFIO driver. For a CCW device, also unbind the corresponding
subchannel of the CCW device from the subchannel I/O driver and then bind the
subchannel (instead of the CCW device) to the vfio_ccw driver. The below example
shows the unbinding and binding steps for a CCW device.</p>
<pre class="literal-block">device="0.0.1234"
subchannel="0.0.0123"
echo $device &gt; /sys/bus/ccw/devices/$device/driver/unbind
echo $subchannel &gt; /sys/bus/css/devices/$subchannel/driver/unbind
echo $subchannel &gt; /sys/bus/css/drivers/vfio_ccw/bind</pre>
<p>To instantiate a transient mediated device, create an XML file representing the
device. See above for information about the mediated device xml format.</p>
<pre class="literal-block">$ virsh nodedev-create &lt;xml-file&gt;
Node device '&lt;device-name&gt;' created from '&lt;xml-file&gt;'</pre>
<p>If you would like to persistently define the device so that it will be
maintained across host reboots, use <span class="docutils literal">virsh <span class="pre">nodedev-define</span></span> instead of
<span class="docutils literal"><span class="pre">nodedev-create</span></span>:</p>
<pre class="literal-block">$ virsh nodedev-define &lt;xml-file&gt;
Node device '&lt;device-name&gt;' defined from '&lt;xml-file&gt;'</pre>
<p>To start an instance of this device definition, use the following command:</p>
<pre class="literal-block">$ virsh nodedev-start &lt;device-name&gt;</pre>
<p>Active mediated device instances can be stopped using
<span class="docutils literal">virsh       <span class="pre">nodedev-destroy</span></span>, and persistent device definitions can be
removed using <span class="docutils literal">virsh <span class="pre">nodedev-undefine</span></span>.</p>
<p>If a mediated device is defined persistently, it can also be set to be
automatically started whenever the host reboots or when the parent device
becomes available. In order to autostart a mediated device, use the following
command:</p>
<pre class="literal-block">$ virsh nodedev-autostart &lt;device-name&gt;</pre>
</div>
</div>
</div>
    </div>
    <div id="nav">
      <div id="home">
        <a href="index.html">Home</a>
      </div>
      <div id="jumplinks">
        <ul>
          <li>
            <a href="downloads.html">Download</a>
          </li>
          <li>
            <a href="contribute.html">Contribute</a>
          </li>
          <li>
            <a href="docs.html">Docs</a>
          </li>
        </ul>
      </div>
      <div id="search">
        <form id="simplesearch" action="https://www.google.com/search" enctype="application/x-www-form-urlencoded" method="get">
          <div>
            <input id="searchsite" name="sitesearch" type="hidden" value="libvirt.org"/>
            <input id="searchq" name="q" type="text" size="12" value=""/>
            <input name="submit" type="submit" value="Go"/>
          </div>
        </form>
        <div id="advancedsearch">
          <span>
            <input type="radio" name="what" id="whatwebsite" checked="checked" value="website"/>
            <label for="whatwebsite">Website</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatwiki" value="wiki"/>
            <label for="whatwiki">Wiki</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatdevs" value="devs"/>
            <label for="whatdevs">Developers list</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatusers" value="users"/>
            <label for="whatusers">Users list</label>
          </span>
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="contact">
        <h3>Contact</h3>
        <ul>
          <li>
            <a href="contact.html#mailing-lists">email</a>
          </li>
          <li>
            <a href="contact.html#irc">irc</a>
          </li>
        </ul>
      </div>
      <div id="community">
        <h3>Community</h3>
        <ul>
          <li>
            <a href="https://twitter.com/hashtag/libvirt">twitter</a>
          </li>
          <li>
            <a href="https://stackoverflow.com/questions/tagged/libvirt">stackoverflow</a>
          </li>
          <li>
            <a href="https://serverfault.com/questions/tagged/libvirt">serverfault</a>
          </li>
        </ul>
      </div>
      <div id="contribute">
        <h3>Contribute</h3>
        <ul>
          <li>
            <a href="https://gitlab.com/libvirt/libvirt/-/blob/master/docs/drvnodedev.rst">edit this page</a>
          </li>
        </ul>
      </div>
      <div id="conduct">
            Participants in the libvirt project agree to abide by <a href="governance.html#code-of-conduct">the project code of conduct</a></div>
      <br class="clear"/>
    </div>
  </body>
</html>
