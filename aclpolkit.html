<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
        This file is autogenerated from docs/aclpolkit.rst
        Do not edit this file. Changes will be lost.
      -->
  <!--
        This page was generated at Wed Apr 19 07:14:27 2023 UTC.
      -->
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="manifest" href="/manifest.json"/>
    <meta name="theme-color" content="#ffffff"/>
    <title>libvirt: Polkit access control</title>
    <meta name="description" content="libvirt, virtualization, virtualization API"/>
    <script type="text/javascript" src="js/main.js">
      <!--// forces non-empty element-->
    </script>
  </head>
  <body onload="pageload()">
    <div id="body">
      <div class="document" id="polkit-access-control">
<h1>Polkit access control</h1>

<p>Libvirt's client <a class="reference external" href="acl.html">access control framework</a> allows
administrators to setup fine grained permission rules across client
users, managed objects and API operations. This allows client
connections to be locked down to a minimal set of privileges. The polkit
driver provides a simple implementation of the access control framework.</p>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#permission-names" id="id2">Permission names</a></p></li>
<li><p><a class="reference internal" href="#object-identity-attributes" id="id3">Object identity attributes</a></p>
<ul>
<li><p><a class="reference internal" href="#virconnectptr" id="id4">virConnectPtr</a></p></li>
<li><p><a class="reference internal" href="#virdomainptr" id="id5">virDomainPtr</a></p></li>
<li><p><a class="reference internal" href="#virinterfaceptr" id="id6">virInterfacePtr</a></p></li>
<li><p><a class="reference internal" href="#virnetworkptr" id="id7">virNetworkPtr</a></p></li>
<li><p><a class="reference internal" href="#virnodedeviceptr" id="id8">virNodeDevicePtr</a></p></li>
<li><p><a class="reference internal" href="#virnwfilterptr" id="id9">virNWFilterPtr</a></p></li>
<li><p><a class="reference internal" href="#virsecretptr" id="id10">virSecretPtr</a></p></li>
<li><p><a class="reference internal" href="#virstoragepoolptr" id="id11">virStoragePoolPtr</a></p></li>
<li><p><a class="reference internal" href="#virstoragevolptr" id="id12">virStorageVolPtr</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#hypervisor-driver-connect-driver" id="id13">Hypervisor Driver connect_driver</a></p>
<ul>
<li><p><a class="reference internal" href="#connection-driver-name" id="id14">Connection Driver Name</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#user-identity-attributes" id="id15">User identity attributes</a></p></li>
<li><p><a class="reference internal" href="#writing-access-control-policies" id="id16">Writing access control policies</a></p>
<ul>
<li><p><a class="reference internal" href="#example-restricting-ability-to-connect-to-drivers" id="id17">Example: restricting ability to connect to drivers</a></p></li>
<li><p><a class="reference internal" href="#example-restricting-access-to-a-single-domain" id="id18">Example: restricting access to a single domain</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h1><a class="toc-backref" href="#id1">Introduction</a><a class="headerlink" href="#introduction" title="Link to this headline">¶</a></h1>
<p>A default install of libvirt will typically use
<a class="reference external" href="https://www.freedesktop.org/wiki/Software/polkit/">polkit</a> to
authenticate the initial user connection to libvirtd. This is a very
coarse grained check though, either allowing full read-write access to
all APIs, or just read-only access. The polkit access control driver in
libvirt builds on this capability to allow for fine grained control over
the operations a user may perform on an object.</p>
</div>
<div class="section" id="permission-names">
<h1><a class="toc-backref" href="#id2">Permission names</a><a class="headerlink" href="#permission-names" title="Link to this headline">¶</a></h1>
<p>The libvirt <a class="reference external" href="acl.html#perms">object names and permission names</a> are
mapped onto polkit action names using the simple pattern:</p>
<pre class="literal-block">org.libvirt.api.$object.$permission</pre>
<p>The only caveat is that any underscore characters in the object or
permission names are converted to hyphens. So, for example, the
<span class="docutils literal">search_storage_vols</span> permission on the <span class="docutils literal">storage_pool</span> object maps
to the polkit action:</p>
<pre class="literal-block">org.libvirt.api.storage-pool.search-storage-vols</pre>
<p>The default policy for any permission which corresponds to a "read only"
operation, is to allow access. All other permissions default to deny
access.</p>
</div>
<div class="section" id="object-identity-attributes">
<h1><a class="toc-backref" href="#id3">Object identity attributes</a><a class="headerlink" href="#object-identity-attributes" title="Link to this headline">¶</a></h1>
<p>To allow polkit authorization rules to be written to match against
individual object instances, libvirt provides a number of authorization
detail attributes when performing a permission check. The set of
attributes varies according to the type of object being checked</p>
<div class="section" id="virconnectptr">
<h2><a class="toc-backref" href="#id4">virConnectPtr</a><a class="headerlink" href="#virconnectptr" title="Link to this headline">¶</a></h2>
<table>
<colgroup>
<col style="width: 27%"/>
<col style="width: 73%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>connect_driver</p></td>
<td><p>Name of the libvirt connection driver</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="virdomainptr">
<h2><a class="toc-backref" href="#id5">virDomainPtr</a><a class="headerlink" href="#virdomainptr" title="Link to this headline">¶</a></h2>
<table>
<colgroup>
<col style="width: 24%"/>
<col style="width: 76%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>connect_driver</p></td>
<td><p>Name of the libvirt connection driver</p></td>
</tr>
<tr><td><p>domain_name</p></td>
<td><p>Name of the domain, unique to the local host</p></td>
</tr>
<tr><td><p>domain_uuid</p></td>
<td><p>UUID of the domain, globally unique</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="virinterfaceptr">
<h2><a class="toc-backref" href="#id6">virInterfacePtr</a><a class="headerlink" href="#virinterfaceptr" title="Link to this headline">¶</a></h2>
<table>
<colgroup>
<col style="width: 25%"/>
<col style="width: 75%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>connect_driver</p></td>
<td><p>Name of the libvirt connection driver</p></td>
</tr>
<tr><td><p>interface_name</p></td>
<td><p>Name of the network interface, unique to the local host</p></td>
</tr>
<tr><td><p>interface_macaddr</p></td>
<td><p>MAC address of the network interface, not unique</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="virnetworkptr">
<h2><a class="toc-backref" href="#id7">virNetworkPtr</a><a class="headerlink" href="#virnetworkptr" title="Link to this headline">¶</a></h2>
<table>
<colgroup>
<col style="width: 24%"/>
<col style="width: 76%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>connect_driver</p></td>
<td><p>Name of the libvirt connection driver</p></td>
</tr>
<tr><td><p>network_name</p></td>
<td><p>Name of the network, unique to the local host</p></td>
</tr>
<tr><td><p>network_uuid</p></td>
<td><p>UUID of the network, globally unique</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="virnodedeviceptr">
<h2><a class="toc-backref" href="#id8">virNodeDevicePtr</a><a class="headerlink" href="#virnodedeviceptr" title="Link to this headline">¶</a></h2>
<table>
<colgroup>
<col style="width: 25%"/>
<col style="width: 75%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>connect_driver</p></td>
<td><p>Name of the libvirt connection driver</p></td>
</tr>
<tr><td><p>node_device_name</p></td>
<td><p>Name of the node device, unique to the local host</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="virnwfilterptr">
<h2><a class="toc-backref" href="#id9">virNWFilterPtr</a><a class="headerlink" href="#virnwfilterptr" title="Link to this headline">¶</a></h2>
<table>
<colgroup>
<col style="width: 21%"/>
<col style="width: 79%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>connect_driver</p></td>
<td><p>Name of the libvirt connection driver</p></td>
</tr>
<tr><td><p>nwfilter_name</p></td>
<td><p>Name of the network filter, unique to the local host</p></td>
</tr>
<tr><td><p>nwfilter_uuid</p></td>
<td><p>UUID of the network filter, globally unique</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="virsecretptr">
<h2><a class="toc-backref" href="#id10">virSecretPtr</a><a class="headerlink" href="#virsecretptr" title="Link to this headline">¶</a></h2>
<table>
<colgroup>
<col style="width: 31%"/>
<col style="width: 69%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>connect_driver</p></td>
<td><p>Name of the libvirt connection driver</p></td>
</tr>
<tr><td><p>secret_uuid</p></td>
<td><p>UUID of the secret, globally unique</p></td>
</tr>
<tr><td><p>secret_usage_volume</p></td>
<td><p>Name of the associated volume, if any</p></td>
</tr>
<tr><td><p>secret_usage_ceph</p></td>
<td><p>Name of the associated Ceph server, if any</p></td>
</tr>
<tr><td><p>secret_usage_target</p></td>
<td><p>Name of the associated iSCSI target, if any</p></td>
</tr>
<tr><td><p>secret_usage_name</p></td>
<td><p>Name of the associated TLS secret, if any</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="virstoragepoolptr">
<h2><a class="toc-backref" href="#id11">virStoragePoolPtr</a><a class="headerlink" href="#virstoragepoolptr" title="Link to this headline">¶</a></h2>
<table>
<colgroup>
<col style="width: 22%"/>
<col style="width: 78%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>connect_driver</p></td>
<td><p>Name of the libvirt connection driver</p></td>
</tr>
<tr><td><p>pool_name</p></td>
<td><p>Name of the storage pool, unique to the local host</p></td>
</tr>
<tr><td><p>pool_uuid</p></td>
<td><p>UUID of the storage pool, globally unique</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="virstoragevolptr">
<h2><a class="toc-backref" href="#id12">virStorageVolPtr</a><a class="headerlink" href="#virstoragevolptr" title="Link to this headline">¶</a></h2>
<table>
<colgroup>
<col style="width: 22%"/>
<col style="width: 78%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>connect_driver</p></td>
<td><p>Name of the libvirt connection driver</p></td>
</tr>
<tr><td><p>pool_name</p></td>
<td><p>Name of the storage pool, unique to the local host</p></td>
</tr>
<tr><td><p>pool_uuid</p></td>
<td><p>UUID of the storage pool, globally unique</p></td>
</tr>
<tr><td><p>vol_name</p></td>
<td><p>Name of the storage volume, unique to the pool</p></td>
</tr>
<tr><td><p>vol_key</p></td>
<td><p>Key of the storage volume, globally unique</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="hypervisor-driver-connect-driver">
<h1><a class="toc-backref" href="#id13">Hypervisor Driver connect_driver</a><a class="headerlink" href="#hypervisor-driver-connect-driver" title="Link to this headline">¶</a></h1>
<p>The <span class="docutils literal">connect_driver</span> parameter describes the client's <a class="reference external" href="remote.html">remote
Connection Driver</a> name based on the <a class="reference external" href="uri.html">URI</a>
used for the connection.</p>
<p><span class="since">Since 4.1.0</span>, when calling an API outside the scope of the primary
connection driver, the primary driver will attempt to open a secondary
connection to the specific API driver in order to process the API. For
example, when hypervisor domain processing needs to make an API call
within the storage driver or the network filter driver an attempt to
open a connection to the "storage" or "nwfilter" driver will be made.
Similarly, a "storage" primary connection may need to create a
connection to the "secret" driver in order to process secrets for the
API. If successful, then calls to those API's will occur in the
<span class="docutils literal">connect_driver</span> context of the secondary connection driver rather
than in the context of the primary driver. This affects the
<span class="docutils literal">connect_driver</span> returned from rule generation from the
<span class="docutils literal">action.loookup</span> function. The following table provides a list of the
various connection drivers and the <span class="docutils literal">connect_driver</span> name used by each
regardless of primary or secondary connection. The access denied error
message from libvirt will list the connection driver by name that denied
the access.</p>
<div class="section" id="connection-driver-name">
<h2><a class="toc-backref" href="#id14">Connection Driver Name</a><a class="headerlink" href="#connection-driver-name" title="Link to this headline">¶</a></h2>
<table>
<colgroup>
<col style="width: 43%"/>
<col style="width: 58%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Connection Driver</p></th>
<th class="head"><p><span class="docutils literal">connect_driver</span> name</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>bhyve</p></td>
<td><p>bhyve</p></td>
</tr>
<tr><td><p>esx</p></td>
<td><p>ESX</p></td>
</tr>
<tr><td><p>hyperv</p></td>
<td><p>Hyper-V</p></td>
</tr>
<tr><td><p>interface</p></td>
<td><p>interface</p></td>
</tr>
<tr><td><p>xen</p></td>
<td><p>Xen</p></td>
</tr>
<tr><td><p>lxc</p></td>
<td><p>LXC</p></td>
</tr>
<tr><td><p>network</p></td>
<td><p>network</p></td>
</tr>
<tr><td><p>nodedev</p></td>
<td><p>nodedev</p></td>
</tr>
<tr><td><p>nwfilter</p></td>
<td><p>NWFilter</p></td>
</tr>
<tr><td><p>openvz</p></td>
<td><p>OPENVZ</p></td>
</tr>
<tr><td><p>qemu</p></td>
<td><p>QEMU</p></td>
</tr>
<tr><td><p>secret</p></td>
<td><p>secret</p></td>
</tr>
<tr><td><p>storage</p></td>
<td><p>storage</p></td>
</tr>
<tr><td><p>vbox</p></td>
<td><p>VBOX</p></td>
</tr>
<tr><td><p>vmware</p></td>
<td><p>VMWARE</p></td>
</tr>
<tr><td><p>vz</p></td>
<td><p>vz</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="user-identity-attributes">
<h1><a class="toc-backref" href="#id15">User identity attributes</a><a class="headerlink" href="#user-identity-attributes" title="Link to this headline">¶</a></h1>
<p>At this point in time, the only attribute provided by libvirt to
identify the user invoking the operation is the PID of the client
program. This means that the polkit access control driver is only useful
if connections to libvirt are restricted to its UNIX domain socket. If
connections are being made to a TCP socket, no identifying information
is available and access will be denied. Also note that if the client is
connecting via an SSH tunnel, it is the local SSH user that will be
identified. In future versions, it is expected that more information
about the client user will be provided, including the SASL / Kerberos
username and/or x509 distinguished name obtained from the authentication
provider in use.</p>
</div>
<div class="section" id="writing-access-control-policies">
<h1><a class="toc-backref" href="#id16">Writing access control policies</a><a class="headerlink" href="#writing-access-control-policies" title="Link to this headline">¶</a></h1>
<p>If using versions of polkit prior to 0.106 then it is only possible to
validate (user, permission) pairs via the <span class="docutils literal">.pkla</span> files. Fully
validation of the (user, permission, object) triple requires the new
JavaScript <span class="docutils literal">.rules</span> support that was introduced in version 0.106. The
latter is what will be described here.</p>
<p>Libvirt does not ship any rules files by default. It merely provides a
definition of the default behaviour for each action (permission). As
noted earlier, permissions which correspond to read-only operations in
libvirt will be allowed to all users by default; everything else is
denied by default. Defining custom rules requires creation of a file in
the <span class="docutils literal"><span class="pre">/etc/polkit-1/rules.d</span></span> directory with a name chosen by the
administrator (<span class="docutils literal"><span class="pre">100-libvirt-acl.rules</span></span> would be a reasonable choice).
See the <span class="docutils literal">polkit(8)</span> manual page for a description of how to write
these files in general. The key idea is to create a file containing
something like</p>
<pre class="literal-block">polkit.addRule(function(action, subject) {
  ....logic to check 'action' and 'subject'...
});</pre>
<p>In this code snippet above, the <span class="docutils literal">action</span> object instance will
represent the libvirt permission being checked along with identifying
attributes for the object it is being applied to. The <span class="docutils literal">subject</span>
meanwhile will identify the libvirt client app (with the caveat above
about it only dealing with local clients connected via the UNIX socket).
On the <span class="docutils literal">action</span> object, the permission name is accessible via the
<span class="docutils literal">id</span> attribute, while the object identifying attributes are exposed
via the <span class="docutils literal">lookup</span> method.</p>
<p>See <a class="reference external" href="https://gitlab.com/libvirt/libvirt/-/tree/master/examples/polkit">source
code</a>
for a more complex example.</p>
<div class="section" id="example-restricting-ability-to-connect-to-drivers">
<h2><a class="toc-backref" href="#id17">Example: restricting ability to connect to drivers</a><a class="headerlink" href="#example-restricting-ability-to-connect-to-drivers" title="Link to this headline">¶</a></h2>
<p>Consider a local user <span class="docutils literal">berrange</span> who has been granted permission to
connect to libvirt in full read-write mode. The goal is to only allow
them to use the <span class="docutils literal">QEMU</span> driver and not the Xen or LXC drivers which are
also available in libvirtd. To achieve this we need to write a rule
which checks whether the <span class="docutils literal">connect_driver</span> attribute is <span class="docutils literal">QEMU</span>, and
match on an action name of <span class="docutils literal">org.libvirt.api.connect.getattr</span>. Using
the javascript rules format, this ends up written as</p>
<pre class="literal-block">polkit.addRule(function(action, subject) {
    if (action.id == "org.libvirt.api.connect.getattr" &amp;&amp;
        subject.user == "berrange") {
          if (action.lookup("connect_driver") == 'QEMU') {
            return polkit.Result.YES;
          } else {
            return polkit.Result.NO;
          }
    }
});</pre>
</div>
<div class="section" id="example-restricting-access-to-a-single-domain">
<h2><a class="toc-backref" href="#id18">Example: restricting access to a single domain</a><a class="headerlink" href="#example-restricting-access-to-a-single-domain" title="Link to this headline">¶</a></h2>
<p>Consider a local user <span class="docutils literal">berrange</span> who has been granted permission to
connect to libvirt in full read-write mode. The goal is to only allow
them to see the domain called <span class="docutils literal">demo</span> on the LXC driver. To achieve
this we need to write a rule which checks whether the <span class="docutils literal">connect_driver</span>
attribute is <span class="docutils literal">LXC</span> and the <span class="docutils literal">domain_name</span> attribute is <span class="docutils literal">demo</span>, and
match on an action name of <span class="docutils literal">org.libvirt.api.domain.getattr</span>. Using the
javascript rules format, this ends up written as</p>
<pre class="literal-block">polkit.addRule(function(action, subject) {
    if (action.id == "org.libvirt.api.domain.getattr" &amp;&amp;
        subject.user == "berrange") {
          if (action.lookup("connect_driver") == 'LXC' &amp;&amp;
              action.lookup("domain_name") == 'demo') {
            return polkit.Result.YES;
          } else {
            return polkit.Result.NO;
          }
    }
});</pre>
</div>
</div>
</div>
    </div>
    <div id="nav">
      <div id="home">
        <a href="index.html">Home</a>
      </div>
      <div id="jumplinks">
        <ul>
          <li>
            <a href="downloads.html">Download</a>
          </li>
          <li>
            <a href="contribute.html">Contribute</a>
          </li>
          <li>
            <a href="docs.html">Docs</a>
          </li>
        </ul>
      </div>
      <div id="search">
        <form id="simplesearch" action="https://www.google.com/search" enctype="application/x-www-form-urlencoded" method="get">
          <div>
            <input id="searchsite" name="sitesearch" type="hidden" value="libvirt.org"/>
            <input id="searchq" name="q" type="text" size="12" value=""/>
            <input name="submit" type="submit" value="Go"/>
          </div>
        </form>
        <div id="advancedsearch">
          <span>
            <input type="radio" name="what" id="whatwebsite" checked="checked" value="website"/>
            <label for="whatwebsite">Website</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatwiki" value="wiki"/>
            <label for="whatwiki">Wiki</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatdevs" value="devs"/>
            <label for="whatdevs">Developers list</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatusers" value="users"/>
            <label for="whatusers">Users list</label>
          </span>
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="contact">
        <h3>Contact</h3>
        <ul>
          <li>
            <a href="contact.html#mailing-lists">email</a>
          </li>
          <li>
            <a href="contact.html#irc">irc</a>
          </li>
        </ul>
      </div>
      <div id="community">
        <h3>Community</h3>
        <ul>
          <li>
            <a href="https://twitter.com/hashtag/libvirt">twitter</a>
          </li>
          <li>
            <a href="https://stackoverflow.com/questions/tagged/libvirt">stackoverflow</a>
          </li>
          <li>
            <a href="https://serverfault.com/questions/tagged/libvirt">serverfault</a>
          </li>
        </ul>
      </div>
      <div id="contribute">
        <h3>Contribute</h3>
        <ul>
          <li>
            <a href="https://gitlab.com/libvirt/libvirt/-/blob/master/docs/aclpolkit.rst">edit this page</a>
          </li>
        </ul>
      </div>
      <div id="conduct">
            Participants in the libvirt project agree to abide by <a href="governance.html#code-of-conduct">the project code of conduct</a></div>
      <br class="clear"/>
    </div>
  </body>
</html>
