<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
        This file is autogenerated from docs/formatbackup.rst
        Do not edit this file. Changes will be lost.
      -->
  <!--
        This page was generated at Wed Apr 19 07:14:27 2023 UTC.
      -->
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="manifest" href="/manifest.json"/>
    <meta name="theme-color" content="#ffffff"/>
    <title>libvirt: Backup XML format</title>
    <meta name="description" content="libvirt, virtualization, virtualization API"/>
    <script type="text/javascript" src="js/main.js">
      <!--// forces non-empty element-->
    </script>
  </head>
  <body onload="pageload()">
    <div id="body">
      <div class="document" id="backup-xml-format">
<h1>Backup XML format</h1>

<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#backup-xml" id="id1">Backup XML</a></p></li>
<li><p><a class="reference internal" href="#examples" id="id2">Examples</a></p></li>
</ul>
</div>
<div class="section" id="backup-xml">
<h1><a class="toc-backref" href="#id1">Backup XML</a><a class="headerlink" href="#backup-xml" title="Link to this headline">Â¶</a></h1>
<p>Creating a backup, whether full or incremental, is done via
<span class="docutils literal">virDomainBackupBegin()</span>, which takes an XML description of the actions to
perform, as well as an optional second XML document <a class="reference external" href="formatcheckpoint.html">describing a
checkpoint</a> to create at the same point in time. See
also <a class="reference external" href="kbase/domainstatecapture.html">a comparison</a> between the various state
capture APIs.</p>
<p>There are two general modes for backups: a push mode (where the hypervisor
writes out the data to the destination file, which may be local or remote), and
a pull mode (where the hypervisor creates an NBD server that a third-party
client can then read as needed, and which requires the use of temporary storage,
typically local, until the backup is complete).</p>
<p>The instructions for beginning a backup job are provided as attributes and
elements of the top-level <span class="docutils literal">domainbackup</span> element. This element includes an
optional attribute <span class="docutils literal">mode</span> which can be either "push" or "pull" (default push).
<span class="docutils literal">virDomainBackupGetXMLDesc()</span> can be used to see the actual values selected
for elements omitted during creation (for example, learning which port the NBD
server is using in the pull model or what file names libvirt generated when none
were supplied). The following child elements and attributes are supported:</p>
<dl>
<dt><span class="docutils literal">incremental</span></dt>
<dd><p>An optional element giving the name of an existing checkpoint of the domain,
which will be used to make this backup an incremental one. In the push model,
only changes since the named checkpoint are written to the destination. In
the pull model, the NBD server uses the NBD_OPT_SET_META_CONTEXT extension to
advertise to the client which portions of the export contain changes since
the named checkpoint. If omitted, a full backup is performed.</p>
</dd>
<dt><span class="docutils literal">server</span></dt>
<dd><p>Present only for a pull mode backup. Contains the same attributes as the
<span class="docutils literal">`protocol</span> element of a disk &lt;formatdomain.html#hard-drives-floppy-disks-cdroms&gt;`__ attached
via NBD in the domain (such as transport, socket, name, port, or tls),
necessary to set up an NBD server that exposes the content of each disk at
the time the backup is started.</p>
<p>Note that for the QEMU hypervisor the TLS environment in controlled using
<span class="docutils literal">backup_tls_x509_cert_dir</span>, <span class="docutils literal">backup_tls_x509_verify</span>, and
<span class="docutils literal">backup_tls_x509_secret_uuid</span> properties in <span class="docutils literal">/etc/libvirt/qemu.conf</span>.</p>
</dd>
<dt><span class="docutils literal">disks</span></dt>
<dd><p>An optional listing of instructions for disks participating in the backup (if
omitted, all disks participate and libvirt attempts to generate filenames by
appending the current timestamp as a suffix). If the entire element was
omitted on input, then all disks participate in the backup, otherwise, only
the disks explicitly listed which do not also use <span class="docutils literal"><span class="pre">backup='no'</span></span> will
participate. On output, this is the state of each of the domain's disk in
relation to the backup operation.</p>
<dl>
<dt><span class="docutils literal">disk</span></dt>
<dd><p>This sub-element describes the backup properties of a specific disk, with
the following attributes and child elements:</p>
<dl>
<dt><span class="docutils literal">name</span></dt>
<dd><p>A mandatory attribute which must match the <span class="docutils literal">&lt;target <span class="pre">dev='name'/&gt;</span></span> of
one of the <a class="reference external" href="formatdomain.html#hard-drives-floppy-disks-cdroms">disk devices</a> specified
for the domain at the time of the checkpoint.</p>
</dd>
<dt><span class="docutils literal">backup</span></dt>
<dd><p>Setting this attribute to <span class="docutils literal">yes</span>(default) specifies that the disk
should take part in the backup and using <span class="docutils literal">no</span> excludes the disk from
the backup.</p>
</dd>
<dt><span class="docutils literal">backupmode</span></dt>
<dd><blockquote>
<p>This attribute overrides the implied backup mode inherited from the
definition of the backup itself. Value <span class="docutils literal">full</span> forces a full backup
even if the backup calls for an incremental backup, and <span class="docutils literal">incremental</span>
coupled with the attribute <span class="docutils literal"><span class="pre">incremental='CHECKPOINTNAME</span></span> for the disk
forces an incremental backup from <span class="docutils literal">CHECKPOINTNAME</span>.</p>
</blockquote>
<dl class="simple">
<dt><span class="docutils literal">incremental</span></dt>
<dd><p>An optional attribute giving the name of an existing checkpoint of the
domain which overrides the one set by the <span class="docutils literal">&lt;incremental&gt;</span> element.</p>
</dd>
</dl>
</dd>
<dt><span class="docutils literal">exportname</span></dt>
<dd><p>Allows modification of the NBD export name for the given disk. By
default equal to disk target. Valid only for pull mode backups.</p>
</dd>
<dt><span class="docutils literal">exportbitmap</span></dt>
<dd><p>Allows modification of the name of the bitmap describing dirty blocks
for an incremental backup exported via NBD export name for the given
disk. Valid only for pull mode backups.</p>
</dd>
<dt><span class="docutils literal">type</span></dt>
<dd><p>A mandatory attribute to describe the type of the disk, except when
<span class="docutils literal"><span class="pre">backup='no'</span></span> is used. Valid values include <span class="docutils literal">file</span>, or <span class="docutils literal">block</span>.
Similar to a disk declaration for a domain, the choice of type controls
what additional sub-elements are needed to describe the destination.</p>
</dd>
<dt><span class="docutils literal">index</span></dt>
<dd><p>Output only. The value can be used to refer to the scratch or output
file of the backup in APIs such as <span class="docutils literal">virDomainSetBlockThreshold</span>.</p>
</dd>
<dt><span class="docutils literal">target</span></dt>
<dd><p>Valid only for push mode backups, this is the primary sub-element that
describes the file name of the backup destination, similar to the
<span class="docutils literal">source</span> sub-element of a domain disk. An optional sub-element
<span class="docutils literal">driver</span> can also be used, with an attribute <span class="docutils literal">type</span> to specify a
destination format different from qcow2. See documentation for
<span class="docutils literal">scratch</span> below for additional configuration.</p>
</dd>
<dt><span class="docutils literal">scratch</span></dt>
<dd><p>Valid only for pull mode backups, this is the primary sub-element that
describes the file name of the local scratch file to be used in
facilitating the backup, and is similar to the <span class="docutils literal">source</span> sub-element
of a domain disk. Currently only <span class="docutils literal">file</span> and <span class="docutils literal">block</span> scratch storage
is supported. The <span class="docutils literal">file</span> scratch file is created and deleted by
libvirt in the given location. A <span class="docutils literal">block</span> scratch device must exist
prior to starting the backup and is formatted. The block device must
have enough space for the corresponding disk data including format
overhead. If <span class="docutils literal">VIR_DOMAIN_BACKUP_BEGIN_REUSE_EXTERNAL</span> flag is used
the file for a scratch of <span class="docutils literal">file</span> type must exist with the correct
format and size to hold the copy and is used without modification. The
file is not deleted after the backup but the contents of the file don't
make sense outside of the backup. The same applies for the block device
which must be formatted appropriately. Similarly to the domain
<span class="docutils literal">`disk</span> &lt;formatdomain.html#hard-drives-floppy-disks-cdroms&gt;`__ definition <span class="docutils literal">scratch</span>
and <span class="docutils literal">target</span> can contain <span class="docutils literal">seclabel</span> and/or <span class="docutils literal">encryption</span>
subelements to configure the corresponding properties.</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</div>
<div class="section" id="examples">
<h1><a class="toc-backref" href="#id2">Examples</a><a class="headerlink" href="#examples" title="Link to this headline">Â¶</a></h1>
<p>Use <span class="docutils literal">virDomainBackupBegin()</span> to perform a full backup using push mode. The
example lets libvirt pick the destination and format for 'vda', fully specifies
that we want a raw backup of 'vdb', and omits 'vdc' from the operation.</p>
<pre class="literal-block">&lt;domainbackup&gt;
  &lt;disks&gt;
    &lt;disk name='vda' backup='yes'/&gt;
    &lt;disk name='vdb' type='file'&gt;
      &lt;target file='/path/to/vdb.backup'/&gt;
      &lt;driver type='raw'/&gt;
    &lt;/disk&gt;
    &lt;disk name='vdc' backup='no'/&gt;
  &lt;/disks&gt;
&lt;/domainbackup&gt;</pre>
<p>If the previous full backup also passed a parameter describing <a class="reference external" href="formatcheckpoint.html">checkpoint
XML</a> that resulted in a checkpoint named
<span class="docutils literal">1525889631</span>, we can make another call to <span class="docutils literal">virDomainBackupBegin()</span> to
perform an incremental backup of just the data changed since that checkpoint,
this time using the following XML to start a pull model export of the 'vda' and
'vdb' disks, where a third-party NBD client connecting to '/path/to/server'
completes the backup (omitting 'vdc' from the explicit list has the same effect
as the backup='no' from the previous example):</p>
<pre class="literal-block">&lt;domainbackup mode="pull"&gt;
  &lt;incremental&gt;1525889631&lt;/incremental&gt;
  &lt;server transport="unix" socket="/path/to/server"/&gt;
  &lt;disks&gt;
    &lt;disk name='vda' backup='yes' type='file'&gt;
      &lt;scratch file='/path/to/file1.scratch'/&gt;
    &lt;/disk&gt;
  &lt;/disks&gt;
&lt;/domainbackup&gt;</pre>
</div>
</div>
    </div>
    <div id="nav">
      <div id="home">
        <a href="index.html">Home</a>
      </div>
      <div id="jumplinks">
        <ul>
          <li>
            <a href="downloads.html">Download</a>
          </li>
          <li>
            <a href="contribute.html">Contribute</a>
          </li>
          <li>
            <a href="docs.html">Docs</a>
          </li>
        </ul>
      </div>
      <div id="search">
        <form id="simplesearch" action="https://www.google.com/search" enctype="application/x-www-form-urlencoded" method="get">
          <div>
            <input id="searchsite" name="sitesearch" type="hidden" value="libvirt.org"/>
            <input id="searchq" name="q" type="text" size="12" value=""/>
            <input name="submit" type="submit" value="Go"/>
          </div>
        </form>
        <div id="advancedsearch">
          <span>
            <input type="radio" name="what" id="whatwebsite" checked="checked" value="website"/>
            <label for="whatwebsite">Website</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatwiki" value="wiki"/>
            <label for="whatwiki">Wiki</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatdevs" value="devs"/>
            <label for="whatdevs">Developers list</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatusers" value="users"/>
            <label for="whatusers">Users list</label>
          </span>
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="contact">
        <h3>Contact</h3>
        <ul>
          <li>
            <a href="contact.html#mailing-lists">email</a>
          </li>
          <li>
            <a href="contact.html#irc">irc</a>
          </li>
        </ul>
      </div>
      <div id="community">
        <h3>Community</h3>
        <ul>
          <li>
            <a href="https://twitter.com/hashtag/libvirt">twitter</a>
          </li>
          <li>
            <a href="https://stackoverflow.com/questions/tagged/libvirt">stackoverflow</a>
          </li>
          <li>
            <a href="https://serverfault.com/questions/tagged/libvirt">serverfault</a>
          </li>
        </ul>
      </div>
      <div id="contribute">
        <h3>Contribute</h3>
        <ul>
          <li>
            <a href="https://gitlab.com/libvirt/libvirt/-/blob/master/docs/formatbackup.rst">edit this page</a>
          </li>
        </ul>
      </div>
      <div id="conduct">
            Participants in the libvirt project agree to abide by <a href="governance.html#code-of-conduct">the project code of conduct</a></div>
      <br class="clear"/>
    </div>
  </body>
</html>
