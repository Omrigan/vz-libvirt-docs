<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
        This file is autogenerated from docs/kbase/qemu-passthrough-security.rst
        Do not edit this file. Changes will be lost.
      -->
  <!--
        This page was generated at Wed Apr 19 07:14:27 2023 UTC.
      -->
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" type="text/css" href="../css/main.css"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="manifest" href="/manifest.json"/>
    <meta name="theme-color" content="#ffffff"/>
    <title>libvirt: QEMU command-line passthrough</title>
    <meta name="description" content="libvirt, virtualization, virtualization API"/>
    <script type="text/javascript" src="../js/main.js">
      <!--// forces non-empty element-->
    </script>
  </head>
  <body onload="pageload()">
    <div id="body">
      <div class="document" id="qemu-command-line-passthrough">
<h1>QEMU command-line passthrough</h1>

<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#xml-document-additions" id="id1">XML document additions</a></p></li>
<li><p><a class="reference internal" href="#security-confinement-sandboxing" id="id2">Security confinement / sandboxing</a></p>
<ul>
<li><p><a class="reference internal" href="#granting-access-per-vm" id="id3">Granting access per VM</a></p></li>
<li><p><a class="reference internal" href="#disabling-security-protection-per-vm" id="id4">Disabling security protection per VM</a></p></li>
<li><p><a class="reference internal" href="#disabling-security-protection-host-wide" id="id5">Disabling security protection host-wide</a></p></li>
<li><p><a class="reference internal" href="#private-monunt-namespace" id="id6">Private monunt namespace</a></p></li>
</ul>
</li>
</ul>
</div>
<p>Libvirt aims to provide explicit modelling of virtualization features in
the domain XML document schema. QEMU has a very broad range of features
and not all of these can be mapped to elements in the domain XML. Libvirt
would like to reduce the gap to QEMU, however, with finite resources there
will always be cases which aren't covered by the domain XML schema.</p>
<div class="section" id="xml-document-additions">
<h1><a class="toc-backref" href="#id1">XML document additions</a><a class="headerlink" href="#xml-document-additions" title="Link to this headline">¶</a></h1>
<p>To deal with the problem, libvirt introduced support for command-line
passthrough of QEMU arguments. This is achieved by supporting a custom
XML namespace, under which some QEMU driver specific elements are defined.</p>
<p>The canonical place to declare the namespace is on the top level <span class="docutils literal">&lt;domain&gt;</span>
element. At the very end of the document, arbitrary command-line arguments
can now be added, using the namespace prefix <span class="docutils literal">qemu:</span></p>
<pre class="literal-block">&lt;domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'&gt;
  &lt;name&gt;QEMUGuest1&lt;/name&gt;
  &lt;uuid&gt;c7a5fdbd-edaf-9455-926a-d65c16db1809&lt;/uuid&gt;
  ...
  &lt;qemu:commandline&gt;
    &lt;qemu:arg value='-newarg'/&gt;
    &lt;qemu:arg value='parameter'/&gt;
    &lt;qemu:env name='ID' value='wibble'/&gt;
    &lt;qemu:env name='BAR'/&gt;
  &lt;/qemu:commandline&gt;
&lt;/domain&gt;</pre>
<p>Note that when an argument takes a value eg <span class="docutils literal"><span class="pre">-newarg</span> parameter</span>, the argument
and the value must be passed as separate <span class="docutils literal">&lt;qemu:arg&gt;</span> entries.</p>
<p>Instead of declaring the XML namespace on the top level <span class="docutils literal">&lt;domain&gt;</span> it is also
possible to declare it at time of use, which is more convenient for humans
writing the XML documents manually. So the following example is functionally
identical:</p>
<pre class="literal-block">&lt;domain type='kvm'&gt;
  &lt;name&gt;QEMUGuest1&lt;/name&gt;
  &lt;uuid&gt;c7a5fdbd-edaf-9455-926a-d65c16db1809&lt;/uuid&gt;
  ...
  &lt;commandline xmlns="http://libvirt.org/schemas/domain/qemu/1.0"&gt;
    &lt;arg value='-newarg'/&gt;
    &lt;arg value='parameter'/&gt;
    &lt;env name='ID' value='wibble'/&gt;
    &lt;env name='BAR'/&gt;
  &lt;/commandline&gt;
&lt;/domain&gt;</pre>
<p>Note that when querying the XML from libvirt, it will have been translated into
the canonical syntax once more with the namespace on the top level element.</p>
</div>
<div class="section" id="security-confinement-sandboxing">
<h1><a class="toc-backref" href="#id2">Security confinement / sandboxing</a><a class="headerlink" href="#security-confinement-sandboxing" title="Link to this headline">¶</a></h1>
<p>When libvirt launches a QEMU process it makes use of a number of security
technologies to confine QEMU and thus protect the host from malicious VM
breakouts.</p>
<p>When configuring security protection, however, libvirt generally needs to know
exactly which host resources the VM is permitted to access. It gets this
information from the domain XML document. This only works for elements in the
regular schema, the arguments used with command-line passthrough are completely
opaque to libvirt.</p>
<p>As a result, if command-line passthrough is used to expose a file on the host
to QEMU, the security protections will activate and either kill QEMU or deny it
access.</p>
<p>There are two strategies for dealing with this problem, either figure out what
steps are needed to grant QEMU access to the device, or disable the security
protections.  The former is harder, but more secure, while the latter is simple.</p>
<div class="section" id="granting-access-per-vm">
<h2><a class="toc-backref" href="#id3">Granting access per VM</a><a class="headerlink" href="#granting-access-per-vm" title="Link to this headline">¶</a></h2>
<ul class="simple">
<li><p>SELinux - the file on the host needs an SELinux label that will grant access
to QEMU's <span class="docutils literal">svirt_t</span> policy.</p>
<ul>
<li><p>Read-only access - use the <span class="docutils literal">virt_content_t</span> label</p></li>
<li><p>Shared, write access - use the <span class="docutils literal">svirt_image_t:s0</span> label (ie no Multi-
Category Security (MCS) value appended)</p></li>
<li><p>Exclusive, write access - use the <span class="docutils literal">svirt_image_t:s0:MCS</span> label for the VM.
The MCS is auto-generatd at boot time, so this may require re-configuring
the VM to have a fixed MCS label</p></li>
</ul>
</li>
<li><p>Discretionary Access Control (DAC) - the file on the host needs to be
readable/writable to the <span class="docutils literal">qemu</span> user or <span class="docutils literal">qemu</span> group. This can be done
by changing the file ownership to <span class="docutils literal">qemu</span>, or relaxing the permissions to
allow world read, or adding file ACLs to allow access to <span class="docutils literal">qemu</span>.</p></li>
<li><p>Namespaces - a private <span class="docutils literal">mount</span> namespace is used for QEMU by default
which populates a new <span class="docutils literal">/dev</span> with only the device nodes needed by QEMU.
There is no way to augment the set of device nodes ahead of time.</p></li>
<li><p>Seccomp - libvirt launches QEMU with its built-in seccomp policy enabled with
<span class="docutils literal">obsolete=deny</span>, <span class="docutils literal">elevateprivileges=deny</span>, <span class="docutils literal">spawn=deny</span> and
<span class="docutils literal">resourcecontrol=deny</span> settings active. There is no way to change this
policy on a per VM basis.</p></li>
<li><p>Cgroups - a custom cgroup is created per VM and this will either use the
<span class="docutils literal">devices</span> controller or an <span class="docutils literal">BPF</span> rule to define an access control list
for the set of device nodes.
There is no way to change this policy on a per VM basis.</p></li>
</ul>
</div>
<div class="section" id="disabling-security-protection-per-vm">
<h2><a class="toc-backref" href="#id4">Disabling security protection per VM</a><a class="headerlink" href="#disabling-security-protection-per-vm" title="Link to this headline">¶</a></h2>
<p>Some of the security protections can be disabled per-VM:</p>
<ul class="simple">
<li><p>SELinux - in the domain XML the <span class="docutils literal">&lt;seclabel&gt;</span> model can be changed to
<span class="docutils literal">none</span> instead of <span class="docutils literal">selinux</span>, which will make the VM run unconfined.</p></li>
<li><p>DAC - in the domain XML an <span class="docutils literal">&lt;seclabel&gt;</span> element with the <span class="docutils literal">dac</span> model can
be added, configured with a user / group account of <span class="docutils literal">root</span> to make QEMU run
with full privileges.</p></li>
<li><p>Namespaces - there is no way to disable this per VM.</p></li>
<li><p>Seccomp - there is no way to disable this per VM.</p></li>
<li><p>Cgroups - there is no way to disable this per VM.</p></li>
</ul>
</div>
<div class="section" id="disabling-security-protection-host-wide">
<h2><a class="toc-backref" href="#id5">Disabling security protection host-wide</a><a class="headerlink" href="#disabling-security-protection-host-wide" title="Link to this headline">¶</a></h2>
<p>As a last resort it is possible to disable security protection host wide which
will affect all virtual machines. These settings are all made in
<span class="docutils literal">/etc/libvirt/qemu.conf</span></p>
<ul class="simple">
<li><p>SELinux - set <span class="docutils literal">security_default_confied = 0</span> to make QEMU run unconfined by
default, while still allowing explicit opt-in to SELinux for VMs.</p></li>
<li><p>DAC - set <span class="docutils literal">user = root</span> and <span class="docutils literal">group = root</span> to make QEMU run as the root
account.</p></li>
<li><p>SELinux, DAC - set <span class="docutils literal">security_driver = []</span> to entirely disable both the
SELinux and DAC security drivers.</p></li>
<li><p>Namespaces - set <span class="docutils literal">namespaces = []</span> to disable use of the <span class="docutils literal">mount</span>
namespaces, causing QEMU to see the normal fully popualated <span class="docutils literal">dev</span>.</p></li>
<li><p>Seccomp - set <span class="docutils literal">seccomp_sandbox = 0</span> to disable use of the Seccomp sandboxing
in QEMU.</p></li>
<li><p>Cgroups - set <span class="docutils literal">cgroup_device_acl</span> to include the desired device node, or
<span class="docutils literal">cgroup_controllers = <span class="pre">[...]</span></span> to exclude the <span class="docutils literal">devices</span> controller.</p></li>
</ul>
</div>
<div class="section" id="private-monunt-namespace">
<h2><a class="toc-backref" href="#id6">Private monunt namespace</a><a class="headerlink" href="#private-monunt-namespace" title="Link to this headline">¶</a></h2>
<p>As mentioned above, libvirt launches each QEMU process in its own <span class="docutils literal">mount</span>
namespace. It's recommended that all mount points are set up prior starting any
guest. For cases when that can't be assured, mount points in the namespace are
marked as slave so that mount events happening in the parent namespace are
propagated into this child namespace. But this may require an additional step:
mounts in the parent namespace need to be marked as shared (if the distribution
doesn't do that by default). This can be achieved by running the following
command before any guest is started:</p>
<pre class="literal-block"># mount --make-rshared /</pre>
</div>
</div>
</div>
    </div>
    <div id="nav">
      <div id="home">
        <a href="../index.html">Home</a>
      </div>
      <div id="jumplinks">
        <ul>
          <li>
            <a href="../downloads.html">Download</a>
          </li>
          <li>
            <a href="../contribute.html">Contribute</a>
          </li>
          <li>
            <a href="../docs.html">Docs</a>
          </li>
        </ul>
      </div>
      <div id="search">
        <form id="simplesearch" action="https://www.google.com/search" enctype="application/x-www-form-urlencoded" method="get">
          <div>
            <input id="searchsite" name="sitesearch" type="hidden" value="libvirt.org"/>
            <input id="searchq" name="q" type="text" size="12" value=""/>
            <input name="submit" type="submit" value="Go"/>
          </div>
        </form>
        <div id="advancedsearch">
          <span>
            <input type="radio" name="what" id="whatwebsite" checked="checked" value="website"/>
            <label for="whatwebsite">Website</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatwiki" value="wiki"/>
            <label for="whatwiki">Wiki</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatdevs" value="devs"/>
            <label for="whatdevs">Developers list</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatusers" value="users"/>
            <label for="whatusers">Users list</label>
          </span>
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="contact">
        <h3>Contact</h3>
        <ul>
          <li>
            <a href="../contact.html#mailing-lists">email</a>
          </li>
          <li>
            <a href="../contact.html#irc">irc</a>
          </li>
        </ul>
      </div>
      <div id="community">
        <h3>Community</h3>
        <ul>
          <li>
            <a href="https://twitter.com/hashtag/libvirt">twitter</a>
          </li>
          <li>
            <a href="https://stackoverflow.com/questions/tagged/libvirt">stackoverflow</a>
          </li>
          <li>
            <a href="https://serverfault.com/questions/tagged/libvirt">serverfault</a>
          </li>
        </ul>
      </div>
      <div id="contribute">
        <h3>Contribute</h3>
        <ul>
          <li>
            <a href="https://gitlab.com/libvirt/libvirt/-/blob/master/docs/kbase/qemu-passthrough-security.rst">edit this page</a>
          </li>
        </ul>
      </div>
      <div id="conduct">
            Participants in the libvirt project agree to abide by <a href="../governance.html#code-of-conduct">the project code of conduct</a></div>
      <br class="clear"/>
    </div>
  </body>
</html>
