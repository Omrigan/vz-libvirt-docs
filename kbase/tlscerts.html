<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
        This file is autogenerated from docs/kbase/tlscerts.rst
        Do not edit this file. Changes will be lost.
      -->
  <!--
        This page was generated at Wed Apr 19 07:14:27 2023 UTC.
      -->
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" type="text/css" href="../css/main.css"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="manifest" href="/manifest.json"/>
    <meta name="theme-color" content="#ffffff"/>
    <title>libvirt: TLS x509 certificate setup</title>
    <meta name="description" content="libvirt, virtualization, virtualization API"/>
    <script type="text/javascript" src="../js/main.js">
      <!--// forces non-empty element-->
    </script>
  </head>
  <body onload="pageload()">
    <div id="body">
      <div class="document" id="tls-x509-certificate-setup">
<h1>TLS x509 certificate setup</h1>

<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#public-key-infrastructure-set-up" id="id1">Public Key Infrastructure set up</a></p></li>
<li><p><a class="reference internal" href="#background-to-tls-certificates" id="id2">Background to TLS certificates</a></p></li>
<li><p><a class="reference internal" href="#setting-up-a-certificate-authority-ca" id="id3">Setting up a Certificate Authority (CA)</a></p></li>
<li><p><a class="reference internal" href="#issuing-server-certificates" id="id4">Issuing server certificates</a></p></li>
<li><p><a class="reference internal" href="#issuing-client-certificates" id="id5">Issuing client certificates</a></p></li>
<li><p><a class="reference internal" href="#troubleshooting-tls-certificate-problems" id="id6">Troubleshooting TLS certificate problems</a></p></li>
</ul>
</div>
<div class="section" id="public-key-infrastructure-set-up">
<h1><a class="toc-backref" href="#id1">Public Key Infrastructure set up</a><a class="headerlink" href="#public-key-infrastructure-set-up" title="Link to this headline">¶</a></h1>
<p>If you are unsure how to create TLS certificates, skip to the next section.</p>
<table>
<colgroup>
<col style="width: 25%"/>
<col style="width: 25%"/>
<col style="width: 25%"/>
<col style="width: 25%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Location</p></th>
<th class="head"><p>Machine</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Required fields</p></th>
</tr>
</thead>
<tbody>
<tr><td><p><span class="docutils literal">/etc/pki/CA/cacert.pem</span></p></td>
<td><p>Installed on the client and server</p></td>
<td><p>CA's certificate</p></td>
<td><p>n/a</p></td>
</tr>
<tr><td><p><span class="docutils literal"><span class="pre">$HOME/.pki/cacert.pem</span></span></p></td>
<td><p>Installed on the client</p></td>
<td><p>CA's certificate</p></td>
<td><p>n/a</p></td>
</tr>
<tr><td><p><span class="docutils literal">/etc/pki/libvirt/private/serverkey.pem</span></p></td>
<td><p>Installed on the server</p></td>
<td><p>Server's private key</p></td>
<td><p>n/a</p></td>
</tr>
<tr><td><p><span class="docutils literal">/etc/pki/libvirt/servercert.pem</span></p></td>
<td><p>Installed on the server</p></td>
<td><p>Server's certificate signed by the CA</p></td>
<td><p>CommonName (CN) must be the hostname of the server as it is seen by
clients. All hostname and IP address variants that might be used to
reach the server should be listed in Subject Alt Name fields.</p></td>
</tr>
<tr><td><p><span class="docutils literal">/etc/pki/libvirt/private/clientkey.pem</span></p></td>
<td><p>Installed on the client</p></td>
<td><p>Client's private key</p></td>
<td><p>n/a</p></td>
</tr>
<tr><td><p><span class="docutils literal">/etc/pki/libvirt/clientcert.pem</span></p></td>
<td><p>Installed on the client</p></td>
<td><p>Client's certificate signed by the CA</p></td>
<td><p>Distinguished Name (DN) can be checked against an access control list
(<span class="docutils literal">tls_allowed_dn_list</span>).</p></td>
</tr>
<tr><td><p><span class="docutils literal"><span class="pre">$HOME/.pki/libvirt/clientkey.pem</span></span></p></td>
<td><p>Installed on the client</p></td>
<td><p>Client's private key</p></td>
<td><p>n/a</p></td>
</tr>
<tr><td><p><span class="docutils literal"><span class="pre">$HOME/.pki/libvirt/clientcert.pem</span></span></p></td>
<td><p>Installed on the client</p></td>
<td><p>Client's certificate signed by the CA
(see <a class="reference internal" href="#issuing-client-certificates">Issuing client certificates</a>)</p></td>
<td><p>Distinguished Name (DN) can be checked against an access control list
(<span class="docutils literal">tls_allowed_dn_list</span>).</p></td>
</tr>
</tbody>
</table>
<p>If 'pkipath' is specified in URI, then all the client certificates must be found
in the path specified, otherwise the connection will fail with a fatal error. If
'pkipath' is not specified:</p>
<ul class="simple">
<li><p>For a non-root user, libvirt tries to find the certificates in
$HOME/.pki/libvirt first. If the required CA certificate cannot be found,
then the global default location (/etc/pki/CA/cacert.pem) will be used.
Likewise, if either the client certificate or the client key cannot be found,
then the global default locations (/etc/pki/libvirt/clientcert.pem,
/etc/pki/libvirt/private/clientkey.pem) will be used.</p></li>
<li><p>For the root user, the global default locations will always be used.</p></li>
</ul>
</div>
<div class="section" id="background-to-tls-certificates">
<h1><a class="toc-backref" href="#id2">Background to TLS certificates</a><a class="headerlink" href="#background-to-tls-certificates" title="Link to this headline">¶</a></h1>
<p>Libvirt supports TLS certificates for verifying the identity of the server and
clients. There are two distinct checks involved:</p>
<ul class="simple">
<li><p>The client should know that it is connecting to the right server. Checking
done by client by matching the certificate that the server sends to the
server's hostname. May be disabled by adding <span class="docutils literal"><span class="pre">?no_verify=1</span></span> to the <a class="reference external" href="../uri.html#tls-transport">remote
URI</a>.</p></li>
<li><p>The server should know that only permitted clients are connecting. This can
be done based on client's IP address, or on client's IP address and client's
certificate. Checking done by the server. May be enabled and disabled in the
<a class="reference external" href="../remote.html#libvirtd-configuration-file">libvirtd.conf file</a>.</p></li>
</ul>
<p>For full certificate checking you will need to have certificates issued by a
recognised <a class="reference external" href="https://en.wikipedia.org/wiki/Certificate_authority">Certificate Authority
(CA)</a> for your server(s)
and all clients. To avoid the expense of getting certificates from a commercial
CA, you can set up your own CA and tell your server(s) and clients to trust
certificates issues by your own CA. Follow the instructions in the next section.</p>
<p>Be aware that the <a class="reference external" href="../remote.html#libvirtd-configuration-file">default configuration for
libvirtd</a> allows any client to
connect provided they have a valid certificate issued by the CA for their own IP
address. You may want to change this to make it less (or more) permissive,
depending on your needs.</p>
</div>
<div class="section" id="setting-up-a-certificate-authority-ca">
<h1><a class="toc-backref" href="#id3">Setting up a Certificate Authority (CA)</a><a class="headerlink" href="#setting-up-a-certificate-authority-ca" title="Link to this headline">¶</a></h1>
<p>You will need the <a class="reference external" href="https://www.gnutls.org/manual/html_node/certtool-Invocation.html">GnuTLS certtool program documented
here</a>. In
Fedora, it is in the <span class="docutils literal"><span class="pre">gnutls-utils</span></span> package.</p>
<p>Create a private key for your CA:</p>
<pre class="literal-block">certtool --generate-privkey &gt; cakey.pem</pre>
<p>and self-sign it by creating a file with the signature details called
<span class="docutils literal">ca.info</span> containing:</p>
<pre class="literal-block">cn = Name of your organization
ca
cert_signing_key</pre>
<pre class="literal-block">certtool --generate-self-signed --load-privkey cakey.pem \
  --template ca.info --outfile cacert.pem</pre>
<p>(You can delete <span class="docutils literal">ca.info</span> file now if you want).</p>
<p>Now you have two files which matter:</p>
<ul class="simple">
<li><p><span class="docutils literal">cakey.pem</span> - Your CA's private key (keep this very secret!)</p></li>
<li><p><span class="docutils literal">cacert.pem</span> - Your CA's certificate (this is public).</p></li>
</ul>
<p><span class="docutils literal">cacert.pem</span> has to be installed on clients and server(s) to let them know
that they can trust certificates issued by your CA.</p>
<p>The normal installation directory for <span class="docutils literal">cacert.pem</span> is
<span class="docutils literal">/etc/pki/CA/cacert.pem</span> on all clients and servers.</p>
<p>To see the contents of this file, do:</p>
<pre class="literal-block">certtool -i --infile cacert.pem

X.509 certificate info:

Version: 3
Serial Number (hex): 00
Subject: CN=Libvirt Project
Issuer: CN=Libvirt Project
Signature Algorithm: RSA-SHA
Validity:
        Not Before: Mon Jun 18 16:22:18 2007
        Not After: Tue Jun 17 16:22:18 2008
[etc]</pre>
<p>This is all that is required to set up your CA. Keep the CA's private key
carefully as you will need it when you come to issue certificates for your
clients and servers.</p>
</div>
<div class="section" id="issuing-server-certificates">
<h1><a class="toc-backref" href="#id4">Issuing server certificates</a><a class="headerlink" href="#issuing-server-certificates" title="Link to this headline">¶</a></h1>
<p>For each server (libvirtd) you need to issue a certificate containing one or
more hostnames and/or IP addresses. Historically the CommonName (CN) field would
contain the hostname of the server and would match the hostname used in the URI
that clients pass to libvirt. In most TLS implementations the CN field is
considered legacy data. The preferential mechanism is to use Subject Alt Name
(SAN) extension fields to validate against. In the future use of the CN field
for validation may be discontinued entirely, so it is strongly recommended to
include the SAN fields.</p>
<p>In the example below, clients will be connecting to the server using a
<a class="reference external" href="../uri.html#remote-uris">URI</a> of <span class="docutils literal"><span class="pre">qemu://compute1.libvirt.org/system</span></span>, so the
CN must be "<span class="docutils literal">compute1.libvirt.org</span>".</p>
<p>Make a private key for the server:</p>
<pre class="literal-block">certtool --generate-privkey &gt; serverkey.pem</pre>
<p>and sign that key with the CA's private key by first creating a template file
called <span class="docutils literal">server.info</span>. The template file will contain a number of fields to
define the server as follows:</p>
<pre class="literal-block">organization = Name of your organization
cn = compute1.libvirt.org
dns_name = compute1
dns_name = compute1.libvirt.org
ip_address = 10.0.0.74
ip_address = 192.168.1.24
ip_address = 2001:cafe::74
ip_address = fe20::24
tls_www_server
encryption_key
signing_key</pre>
<p>The 'cn' field should refer to the fully qualified public hostname of the
server. For the SAN extension data, there must also be one or more 'dns_name'
fields that contain all possible hostnames that can be reasonably used by
clients to reach the server, both with and without domain name qualifiers. If
clients are likely to connect to the server by IP address, then one or more
'ip_address' fields should also be added.</p>
<p>Use the template file as input to a <span class="docutils literal">certtool</span> command to sign the server
certificate:</p>
<pre class="literal-block">certtool --generate-certificate --load-privkey serverkey.pem \
  --load-ca-certificate cacert.pem --load-ca-privkey cakey.pem \
  --template server.info --outfile servercert.pem</pre>
<p>This gives two files:</p>
<ul class="simple">
<li><p><span class="docutils literal">serverkey.pem</span> - The server's private key.</p></li>
<li><p><span class="docutils literal">servercert.pem</span> - The server's public key.</p></li>
</ul>
<p>We can examine this certificate and its signature:</p>
<pre class="literal-block">certtool -i --infile servercert.pem
X.509 certificate info:

Version: 3
Serial Number (hex): 00
Subject: O=Libvirt Project,CN=compute1.libvirt.org
Issuer: CN=Libvirt Project
Signature Algorithm: RSA-SHA
Validity:
        Not Before: Wed Oct 04 09:09:44 UTC 2017
        Not After: Thu Oct 04 09:09:44 UTC 2018
Extensions:
        Basic Constraints (critical):
                Certificate Authority (CA): FALSE
        Subject Alternative Name (not critical):
                DNSname: compute1
                DNSname: compute1.libvirt.org
                IPAddress: 10.0.0.74
                IPAddress: 192.168.1.24
                IPAddress: 2001:cafe::74
                IPAddress: fe20::24</pre>
<p>Note the "Issuer" CN is "Libvirt Project" (the CA) and the "Subject" CN is
"compute1.libvirt.org" (the server). Notice that the hostname listed in the CN
must also be duplicated as a DNSname entry</p>
<p>Finally we have two files to install:</p>
<ul class="simple">
<li><p><span class="docutils literal">serverkey.pem</span> is the server's private key which should be copied to the
server <em>only</em> as <span class="docutils literal">/etc/pki/libvirt/private/serverkey.pem</span>.</p></li>
<li><p><span class="docutils literal">servercert.pem</span> is the server's certificate which can be installed on the
server as <span class="docutils literal">/etc/pki/libvirt/servercert.pem</span>.</p></li>
</ul>
</div>
<div class="section" id="issuing-client-certificates">
<h1><a class="toc-backref" href="#id5">Issuing client certificates</a><a class="headerlink" href="#issuing-client-certificates" title="Link to this headline">¶</a></h1>
<p>For each client (ie. any program linked with libvirt, such as
<a class="reference external" href="https://virt-manager.org/">virt-manager</a>) you need to issue a certificate
with the X.509 Distinguished Name (DN) set to a suitable name. You can decide
this on a company / organisation policy. For example:</p>
<pre class="literal-block">C=GB,ST=London,L=London,O=Libvirt Project,CN=name_of_client</pre>
<p>The process is the same as for <a class="reference internal" href="#issuing-server-certificates">Issuing server certificates</a> so here we just
briefly cover the steps.</p>
<ol class="arabic">
<li><p>Make a private key:</p>
<pre class="literal-block">certtool --generate-privkey &gt; clientkey.pem</pre>
</li>
<li><p>Act as CA and sign the certificate. Create client.info containing:</p>
<pre class="literal-block">country = GB
state = London
locality = London
organization = Libvirt Project
cn = client1
tls_www_client
encryption_key
signing_key</pre>
<p>and sign by doing:</p>
<pre class="literal-block">certtool --generate-certificate --load-privkey clientkey.pem \
  --load-ca-certificate cacert.pem --load-ca-privkey cakey.pem \
  --template client.info --outfile clientcert.pem</pre>
</li>
<li><p>Install the certificates on the client machine:</p>
<pre class="literal-block">cp clientkey.pem /etc/pki/libvirt/private/clientkey.pem
cp clientcert.pem /etc/pki/libvirt/clientcert.pem</pre>
</li>
</ol>
</div>
<div class="section" id="troubleshooting-tls-certificate-problems">
<h1><a class="toc-backref" href="#id6">Troubleshooting TLS certificate problems</a><a class="headerlink" href="#troubleshooting-tls-certificate-problems" title="Link to this headline">¶</a></h1>
<dl class="simple">
<dt>failed to verify client's certificate</dt>
<dd><p>On the server side, run the libvirtd server with the '--listen' and
'--verbose' options while the client is connecting. The verbose log messages
should tell you enough to diagnose the problem.</p>
</dd>
</dl>
<p>You can use the virt-pki-validate shell script to analyze the setup on the
client or server machines, preferably as root. It will try to point out the
possible problems and provide solutions to fix the set up up to a point where
you have secure remote access.</p>
</div>
</div>
    </div>
    <div id="nav">
      <div id="home">
        <a href="../index.html">Home</a>
      </div>
      <div id="jumplinks">
        <ul>
          <li>
            <a href="../downloads.html">Download</a>
          </li>
          <li>
            <a href="../contribute.html">Contribute</a>
          </li>
          <li>
            <a href="../docs.html">Docs</a>
          </li>
        </ul>
      </div>
      <div id="search">
        <form id="simplesearch" action="https://www.google.com/search" enctype="application/x-www-form-urlencoded" method="get">
          <div>
            <input id="searchsite" name="sitesearch" type="hidden" value="libvirt.org"/>
            <input id="searchq" name="q" type="text" size="12" value=""/>
            <input name="submit" type="submit" value="Go"/>
          </div>
        </form>
        <div id="advancedsearch">
          <span>
            <input type="radio" name="what" id="whatwebsite" checked="checked" value="website"/>
            <label for="whatwebsite">Website</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatwiki" value="wiki"/>
            <label for="whatwiki">Wiki</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatdevs" value="devs"/>
            <label for="whatdevs">Developers list</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatusers" value="users"/>
            <label for="whatusers">Users list</label>
          </span>
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="contact">
        <h3>Contact</h3>
        <ul>
          <li>
            <a href="../contact.html#mailing-lists">email</a>
          </li>
          <li>
            <a href="../contact.html#irc">irc</a>
          </li>
        </ul>
      </div>
      <div id="community">
        <h3>Community</h3>
        <ul>
          <li>
            <a href="https://twitter.com/hashtag/libvirt">twitter</a>
          </li>
          <li>
            <a href="https://stackoverflow.com/questions/tagged/libvirt">stackoverflow</a>
          </li>
          <li>
            <a href="https://serverfault.com/questions/tagged/libvirt">serverfault</a>
          </li>
        </ul>
      </div>
      <div id="contribute">
        <h3>Contribute</h3>
        <ul>
          <li>
            <a href="https://gitlab.com/libvirt/libvirt/-/blob/master/docs/kbase/tlscerts.rst">edit this page</a>
          </li>
        </ul>
      </div>
      <div id="conduct">
            Participants in the libvirt project agree to abide by <a href="../governance.html#code-of-conduct">the project code of conduct</a></div>
      <br class="clear"/>
    </div>
  </body>
</html>
