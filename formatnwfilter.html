<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
        This file is autogenerated from docs/formatnwfilter.rst
        Do not edit this file. Changes will be lost.
      -->
  <!--
        This page was generated at Wed Apr 19 07:14:27 2023 UTC.
      -->
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="manifest" href="/manifest.json"/>
    <meta name="theme-color" content="#ffffff"/>
    <title>libvirt: Network Filters</title>
    <meta name="description" content="libvirt, virtualization, virtualization API"/>
    <script type="text/javascript" src="js/main.js">
      <!--// forces non-empty element-->
    </script>
  </head>
  <body onload="pageload()">
    <div id="body">
      <div class="document" id="network-filters">
<h1>Network Filters</h1>

<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#goals-and-background" id="id1">Goals and background</a></p></li>
<li><p><a class="reference internal" href="#concepts" id="id2">Concepts</a></p>
<ul>
<li><p><a class="reference internal" href="#filtering-chains" id="id3">Filtering chains</a></p></li>
<li><p><a class="reference internal" href="#filtering-chain-priorities" id="id4">Filtering chain priorities</a></p></li>
<li><p><a class="reference internal" href="#usage-of-variables-in-filters" id="id5">Usage of variables in filters</a></p></li>
<li><p><a class="reference internal" href="#automatic-ip-address-detection" id="id6">Automatic IP address detection</a></p></li>
<li><p><a class="reference internal" href="#reserved-variables" id="id7">Reserved Variables</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#element-and-attribute-overview" id="id8">Element and attribute overview</a></p>
<ul>
<li><p><a class="reference internal" href="#references-to-other-filters" id="id9">References to other filters</a></p></li>
<li><p><a class="reference internal" href="#filter-rules" id="id10">Filter rules</a></p>
<ul>
<li><p><a class="reference internal" href="#supported-protocols" id="id11">Supported protocols</a></p>
<ul>
<li><p><a class="reference internal" href="#mac-ethernet" id="id12">MAC (Ethernet)</a></p></li>
<li><p><a class="reference internal" href="#vlan-802-1q-since-0-9-8" id="id13">VLAN (802.1Q) <span class="since">(Since 0.9.8)</span></a></p></li>
<li><p><a class="reference internal" href="#stp-spanning-tree-protocol-since-0-9-8" id="id14">STP (Spanning Tree Protocol) (Since 0.9.8)</a></p></li>
<li><p><a class="reference internal" href="#arp-rarp" id="id15">ARP/RARP</a></p></li>
<li><p><a class="reference internal" href="#ipv4" id="id16">IPv4</a></p></li>
<li><p><a class="reference internal" href="#ipv6" id="id17">IPv6</a></p></li>
<li><p><a class="reference internal" href="#tcp-udp-sctp" id="id18">TCP/UDP/SCTP</a></p></li>
<li><p><a class="reference internal" href="#icmp" id="id19">ICMP</a></p></li>
<li><p><a class="reference internal" href="#igmp-esp-ah-udplite-all" id="id20">IGMP, ESP, AH, UDPLITE, 'ALL'</a></p></li>
<li><p><a class="reference internal" href="#tcp-udp-sctp-over-ipv6" id="id21">TCP/UDP/SCTP over IPV6</a></p></li>
<li><p><a class="reference internal" href="#icmpv6" id="id22">ICMPv6</a></p></li>
<li><p><a class="reference internal" href="#esp-ah-udplite-all-over-ipv6" id="id23">ESP, AH, UDPLITE, 'ALL' over IPv6</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#advanced-filter-configuration-topics" id="id24">Advanced Filter Configuration Topics</a></p>
<ul>
<li><p><a class="reference internal" href="#connection-tracking" id="id25">Connection tracking</a></p></li>
<li><p><a class="reference internal" href="#limiting-number-of-connections" id="id26">Limiting Number of Connections</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#command-line-tools" id="id27">Command line tools</a></p></li>
<li><p><a class="reference internal" href="#pre-existing-network-filters" id="id28">Pre-existing network filters</a></p></li>
<li><p><a class="reference internal" href="#writing-your-own-filters" id="id29">Writing your own filters</a></p>
<ul>
<li><p><a class="reference internal" href="#example-custom-filter" id="id30">Example custom filter</a></p></li>
<li><p><a class="reference internal" href="#second-example-custom-filter" id="id31">Second example custom filter</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#limitations" id="id32">Limitations</a></p>
<ul>
<li><p><a class="reference internal" href="#vm-migration" id="id33">VM Migration</a></p></li>
<li><p><a class="reference internal" href="#vlan-filtering-on-linux" id="id34">VLAN filtering on Linux</a></p></li>
</ul>
</li>
</ul>
</div>
<p>This page provides an introduction to libvirt's network filters, their goals,
concepts and XML format.</p>
<div class="section" id="goals-and-background">
<h1><a class="toc-backref" href="#id1">Goals and background</a><a class="headerlink" href="#goals-and-background" title="Link to this headline">¶</a></h1>
<p>The goal of the network filtering XML is to enable administrators of a
virtualized system to configure and enforce network traffic filtering rules on
virtual machines and manage the parameters of network traffic that virtual
machines are allowed to send or receive. The network traffic filtering rules are
applied on the host when a virtual machine is started. Since the filtering rules
cannot be circumvented from within the virtual machine, it makes them mandatory
from the point of view of a virtual machine user.</p>
<p>The network filter subsystem allows each virtual machine's network traffic
filtering rules to be configured individually on a per interface basis. The
rules are applied on the host when the virtual machine is started and can be
modified while the virtual machine is running. The latter can be achieved by
modifying the XML description of a network filter.</p>
<p>Multiple virtual machines can make use of the same generic network filter. When
such a filter is modified, the network traffic filtering rules of all running
virtual machines that reference this filter are updated.</p>
<p>Network filtering support is available <span class="since">since 0.8.1 (QEMU, KVM)</span></p>
</div>
<div class="section" id="concepts">
<h1><a class="toc-backref" href="#id2">Concepts</a><a class="headerlink" href="#concepts" title="Link to this headline">¶</a></h1>
<p>The network traffic filtering subsystem enables configuration of network traffic
filtering rules on individual network interfaces that are configured for certain
types of network configurations. Supported network types are</p>
<ul class="simple">
<li><p><span class="docutils literal">network</span></p></li>
<li><p><span class="docutils literal">ethernet</span> -- must be used in bridging mode</p></li>
<li><p><span class="docutils literal">bridge</span></p></li>
</ul>
<p>The interface XML is used to reference a top-level filter. In the following
example, the interface description references the filter <span class="docutils literal"><span class="pre">clean-traffic</span></span>.</p>
<pre class="literal-block">...
&lt;devices&gt;
  &lt;interface type='bridge'&gt;
    &lt;mac address='00:16:3e:5d:c7:9e'/&gt;
    &lt;filterref filter='clean-traffic'/&gt;
  &lt;/interface&gt;
&lt;/devices&gt;
...</pre>
<p>Network filters are written in XML and may either contain references to other
filters, contain rules for traffic filtering, or hold a combination of both. The
above referenced filter <span class="docutils literal"><span class="pre">clean-traffic</span></span> is a filter that only contains
references to other filters and no actual filtering rules. Since references to
other filters can be used, a <em>tree</em> of filters can be built. The
<span class="docutils literal"><span class="pre">clean-traffic</span></span> filter can be viewed using the command
<span class="docutils literal">virsh <span class="pre">nwfilter-dumpxml</span> <span class="pre">clean-traffic</span></span>.</p>
<p>As previously mentioned, a single network filter can be referenced by multiple
virtual machines. Since interfaces will typically have individual parameters
associated with their respective traffic filtering rules, the rules described in
a filter XML can be parameterized with variables. In this case, the variable
name is used in the filter XML and the name and value are provided at the place
where the filter is referenced. In the following example, the interface
description has been extended with the parameter <span class="docutils literal">IP</span> and a dotted IP address
as value.</p>
<pre class="literal-block">...
&lt;devices&gt;
  &lt;interface type='bridge'&gt;
    &lt;mac address='00:16:3e:5d:c7:9e'/&gt;
    &lt;filterref filter='clean-traffic'&gt;
      &lt;parameter name='IP' value='10.0.0.1'/&gt;
    &lt;/filterref&gt;
  &lt;/interface&gt;
&lt;/devices&gt;
...</pre>
<p>In this particular example, the <span class="docutils literal"><span class="pre">clean-traffic</span></span> network traffic filter will be
instantiated with the IP address parameter 10.0.0.1 and enforce that the traffic
from this interface will always be using 10.0.0.1 as the source IP address,
which is one of the purposes of this particular filter.</p>
<div class="section" id="filtering-chains">
<h2><a class="toc-backref" href="#id3">Filtering chains</a><a class="headerlink" href="#filtering-chains" title="Link to this headline">¶</a></h2>
<p>Filtering rules are organized in filter chains. These chains can be thought of
as having a tree structure with packet filtering rules as entries in individual
chains (branches).</p>
<p>Packets start their filter evaluation in the <span class="docutils literal">root</span> chain and can then
continue their evaluation in other chains, return from those chains back into
the <span class="docutils literal">root</span> chain or be dropped or accepted by a filtering rule in one of the
traversed chains.</p>
<p>Libvirt's network filtering system automatically creates individual <span class="docutils literal">root</span>
chains for every virtual machine's network interface on which the user chooses
to activate traffic filtering. The user may write filtering rules that are
either directly instantiated in the <span class="docutils literal">root</span> chain or may create
protocol-specific filtering chains for efficient evaluation of protocol-specific
rules. The following chains exist:</p>
<ul class="simple">
<li><p>root</p></li>
<li><p>mac <span class="since">(since 0.9.8)</span></p></li>
<li><p>stp (spanning tree protocol) <span class="since">(since 0.9.8)</span></p></li>
<li><p>vlan (802.1Q) <span class="since">(since 0.9.8)</span></p></li>
<li><p>arp, rarp</p></li>
<li><p>ipv4</p></li>
<li><p>ipv6</p></li>
</ul>
<p><span class="since">Since 0.9.8</span> multiple chains evaluating the <span class="docutils literal">mac</span>, <span class="docutils literal">stp</span>, <span class="docutils literal">vlan</span>,
<span class="docutils literal">arp</span>, <span class="docutils literal">rarp</span>, <span class="docutils literal">ipv4</span>, or <span class="docutils literal">ipv6</span> protocol can be created using the
protocol name only as a prefix in the chain's name. This for examples allows
chains with names <span class="docutils literal"><span class="pre">arp-xyz</span></span> or <span class="docutils literal"><span class="pre">arp-test</span></span> to be specified and have ARP
protocol packets evaluated in those chains.</p>
<p>The following filter shows an example of filtering ARP traffic in the <span class="docutils literal">arp</span>
chain.</p>
<pre class="literal-block">&lt;filter name='no-arp-spoofing' chain='arp' priority='-500'&gt;
  &lt;uuid&gt;f88f1932-debf-4aa1-9fbe-f10d3aa4bc95&lt;/uuid&gt;
  &lt;rule action='drop' direction='out' priority='300'&gt;
    &lt;mac match='no' srcmacaddr='$MAC'/&gt;
  &lt;/rule&gt;
  &lt;rule action='drop' direction='out' priority='350'&gt;
    &lt;arp match='no' arpsrcmacaddr='$MAC'/&gt;
  &lt;/rule&gt;
  &lt;rule action='drop' direction='out' priority='400'&gt;
    &lt;arp match='no' arpsrcipaddr='$IP'/&gt;
  &lt;/rule&gt;
  &lt;rule action='drop' direction='in' priority='450'&gt;
    &lt;arp opcode='Reply'/&gt;
    &lt;arp match='no' arpdstmacaddr='$MAC'/&gt;
  &lt;/rule&gt;
  &lt;rule action='drop' direction='in' priority='500'&gt;
    &lt;arp match='no' arpdstipaddr='$IP'/&gt;
  &lt;/rule&gt;
  &lt;rule action='accept' direction='inout' priority='600'&gt;
    &lt;arp opcode='Request'/&gt;
  &lt;/rule&gt;
  &lt;rule action='accept' direction='inout' priority='650'&gt;
    &lt;arp opcode='Reply'/&gt;
  &lt;/rule&gt;
  &lt;rule action='drop' direction='inout' priority='1000'/&gt;
&lt;/filter&gt;</pre>
<p>The consequence of putting ARP-specific rules in the <span class="docutils literal">arp</span> chain, rather than
for example in the <span class="docutils literal">root</span> chain, is that packets for any other protocol than
ARP do not need to be evaluated by ARP protocol-specific rules. This improves
the efficiency of the traffic filtering. However, one must then pay attention to
only put filtering rules for the given protocol into the chain since any other
rules will not be evaluated, i.e., an IPv4 rule will not be evaluated in the ARP
chain since no IPv4 protocol packets will traverse the ARP chain.</p>
</div>
<div class="section" id="filtering-chain-priorities">
<h2><a class="toc-backref" href="#id4">Filtering chain priorities</a><a class="headerlink" href="#filtering-chain-priorities" title="Link to this headline">¶</a></h2>
<p>All chains are connected to the <span class="docutils literal">root</span> chain. The order in which those chains
are accessed is influenced by the priority of the chain. The following table
shows the chains that can be assigned a priority and their default priorities.</p>
<table>
<colgroup>
<col style="width: 47%"/>
<col style="width: 53%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Chain (prefix)</p></th>
<th class="head"><p>Default priority</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>stp</p></td>
<td><p>-810</p></td>
</tr>
<tr><td><p>mac</p></td>
<td><p>-800</p></td>
</tr>
<tr><td><p>vlan</p></td>
<td><p>-750</p></td>
</tr>
<tr><td><p>ipv4</p></td>
<td><p>-700</p></td>
</tr>
<tr><td><p>ipv6</p></td>
<td><p>-600</p></td>
</tr>
<tr><td><p>arp</p></td>
<td><p>-500</p></td>
</tr>
<tr><td><p>rarp</p></td>
<td><p>-400</p></td>
</tr>
</tbody>
</table>
<p>A chain with a lower priority value is accessed before one with a higher value.</p>
<p><span class="since">Since 0.9.8</span> the above listed chains can be assigned custom priorities
by writing a value in the range [-1000, 1000] into the priority (XML) attribute
in the filter node. The above example filter shows the default priority of -500
for <span class="docutils literal">arp</span> chains.</p>
</div>
<div class="section" id="usage-of-variables-in-filters">
<h2><a class="toc-backref" href="#id5">Usage of variables in filters</a><a class="headerlink" href="#usage-of-variables-in-filters" title="Link to this headline">¶</a></h2>
<p>Two variables names have so far been reserved for usage by the network traffic
filtering subsystem: <span class="docutils literal">MAC</span> and <span class="docutils literal">IP</span>.</p>
<p><span class="docutils literal">MAC</span> is the MAC address of the network interface. A filtering rule that
references this variable will automatically be instantiated with the MAC address
of the interface. This works without the user having to explicitly provide the
MAC parameter. Even though it is possible to specify the MAC parameter similar
to the IP parameter above, it is discouraged since libvirt knows what MAC
address an interface will be using.</p>
<p>The parameter <span class="docutils literal">IP</span> represents the IP address that the operating system inside
the virtual machine is expected to use on the given interface. The <span class="docutils literal">IP</span>
parameter is special in so far as the libvirt daemon will try to determine the
IP address (and thus the IP parameter's value) that is being used on an
interface if the parameter is not explicitly provided but referenced. For
current limitations on IP address detection, consult the section on
<a class="reference internal" href="#limitations">Limitations</a> on how to use this feature and what to expect when using it.</p>
<p>The above-shown network filer <span class="docutils literal"><span class="pre">no-arp-spoofing</span></span> is an example of a network
filter XML referencing the <span class="docutils literal">MAC</span> and <span class="docutils literal">IP</span> variables.</p>
<p>Note that referenced variables are always prefixed with the $ (dollar) sign. The
format of the value of a variable must be of the type expected by the filter
attribute in the XML. In the above example, the <span class="docutils literal">IP</span> parameter must hold a
dotted IP address in decimal numbers format. Failure to provide the correct
value type will result in the filter not being instantiatable and will prevent a
virtual machine from starting or the interface from attaching when hotplugging
is used. The types that are expected for each XML attribute are shown below.</p>
<p><span class="since">Since 0.9.8</span> variables can contain lists of elements, e.g., the variable
<span class="docutils literal">IP</span> can contain multiple IP addresses that are valid on a particular
interface. The notation for providing multiple elements for the IP variable is:</p>
<pre class="literal-block">...
&lt;devices&gt;
  &lt;interface type='bridge'&gt;
    &lt;mac address='00:16:3e:5d:c7:9e'/&gt;
    &lt;filterref filter='clean-traffic'&gt;
      &lt;parameter name='IP' value='10.0.0.1'/&gt;
      &lt;parameter name='IP' value='10.0.0.2'/&gt;
      &lt;parameter name='IP' value='10.0.0.3'/&gt;
    &lt;/filterref&gt;
  &lt;/interface&gt;
&lt;/devices&gt;
...</pre>
<p>This then allows filters to enable multiple IP addresses per interface.
Therefore, with the list of IP address shown above, the following rule will
create 3 individual filtering rules, one for each IP address.</p>
<pre class="literal-block">...
&lt;rule action='accept' direction='in' priority='500'&gt;
  &lt;tcp srpipaddr='$IP'/&gt;
&lt;/rule&gt;
...</pre>
<p><span class="since">Since 0.9.10</span> it is possible to access individual elements of a variable
holding a list of elements. A filtering rule like the following accesses the 2nd
element of the variable DSTPORTS.</p>
<pre class="literal-block">...
&lt;rule action='accept' direction='in' priority='500'&gt;
  &lt;udp dstportstart='$DSTPORTS[1]'/&gt;
&lt;/rule&gt;
...</pre>
<p><span class="since">Since 0.9.10</span> it is possible to create filtering rules that instantiate
all combinations of rules from different lists using the notation of
<span class="docutils literal"><span class="pre">$VARIABLE[@&lt;iterator</span> ID&gt;]</span>. The following rule allows a virtual machine to
receive traffic on a set of ports, which are specified in DSTPORTS, from the set
of source IP address specified in SRCIPADDRESSES. The rule generates all
combinations of elements of the variable DSTPORT with those of SRCIPADDRESSES by
using two independent iterators to access their elements.</p>
<pre class="literal-block">...
&lt;rule action='accept' direction='in' priority='500'&gt;
  &lt;ip srcipaddr='$SRCIPADDRESSES[@1]' dstportstart='$DSTPORTS[@2]'/&gt;
&lt;/rule&gt;
...</pre>
<p>In an example we assign concrete values to SRCIPADDRESSES and DSTPORTS</p>
<pre class="literal-block">SRCIPADDRESSES = [ 10.0.0.1, 11.1.2.3 ]
DSTPORTS = [ 80, 8080 ]</pre>
<p>Accessing the variables using $SRCIPADDRESSES[@1] and $DSTPORTS[@2] would then
result in all combinations of addresses and ports being created:</p>
<pre class="literal-block">10.0.0.1, 80
10.0.0.1, 8080
11.1.2.3, 80
11.1.2.3, 8080</pre>
<p>Accessing the same variables using a single iterator, for example by using the
notation $SRCIPADDRESSES[@1] and $DSTPORTS[@1], would result in parallel access
to both lists and result in the following combinations:</p>
<pre class="literal-block">10.0.0.1, 80
11.1.2.3, 8080</pre>
<p>Further, the notation of $VARIABLE is short-hand for $VARIABLE[@0]. The former
notation always assumes the iterator with Id '0'.</p>
</div>
<div class="section" id="automatic-ip-address-detection">
<h2><a class="toc-backref" href="#id6">Automatic IP address detection</a><a class="headerlink" href="#automatic-ip-address-detection" title="Link to this headline">¶</a></h2>
<p>The detection of IP addresses used on a virtual machine's interface is
automatically activated if the variable <span class="docutils literal">IP</span> is referenced but no value has
been assigned to it. <span class="since">Since 0.9.13</span> the variable <span class="docutils literal">CTRL_IP_LEARNING</span> can
be used to specify the IP address learning method to use. Valid values are
<span class="docutils literal">any</span>, <span class="docutils literal">dhcp</span>, or <span class="docutils literal">none</span>.</p>
<p>The value <span class="docutils literal">any</span> means that libvirt may use any packet to determine the address
in use by a virtual machine, which is the default behavior if the variable
<span class="docutils literal">CTRL_IP_LEARNING</span> is not set. This method will only detect a single IP
address on an interface. Once a VM's IP address has been detected, its IP
network traffic will be locked to that address, if for example IP address
spoofing is prevented by one of its filters. In that case the user of the VM
will not be able to change the IP address on the interface inside the VM, which
would be considered IP address spoofing. When a VM is migrated to another host
or resumed after a suspend operation, the first packet sent by the VM will again
determine the IP address it can use on a particular interface.</p>
<p>A value of <span class="docutils literal">dhcp</span> specifies that libvirt should only honor DHCP
server-assigned addresses with valid leases. This method supports the detection
and usage of multiple IP address per interface. When a VM is resumed after a
suspend operation, still valid IP address leases are applied to its filters.
Otherwise the VM is expected to again use DHCP to obtain new IP addresses. The
migration of a VM to another physical host requires that the VM again runs the
DHCP protocol.</p>
<p>Use of <span class="docutils literal">CTRL_IP_LEARNING=dhcp</span> (DHCP snooping) provides additional
anti-spoofing security, especially when combined with a filter allowing only
trusted DHCP servers to assign addresses. To enable this, set the variable
<span class="docutils literal">DHCPSERVER</span> to the IP address of a valid DHCP server and provide filters that
use this variable to filter incoming DHCP responses.</p>
<p>When DHCP snooping is enabled and the DHCP lease expires, the VM will no longer
be able to use the IP address until it acquires a new, valid lease from a DHCP
server. If the VM is migrated, it must get a new valid DHCP lease to use an IP
address (e.g., by bringing the VM interface down and up again).</p>
<p>Note that automatic DHCP detection listens to the DHCP traffic the VM exchanges
with the DHCP server of the infrastructure. To avoid denial-of-service attacks
on libvirt, the evaluation of those packets is rate-limited, meaning that a VM
sending an excessive number of DHCP packets per second on an interface will not
have all of those packets evaluated and thus filters may not get adapted. Normal
DHCP client behavior is assumed to send a low number of DHCP packets per second.
Further, it is important to setup appropriate filters on all VMs in the
infrastructure to avoid them being able to send DHCP packets. Therefore VMs must
either be prevented from sending UDP and TCP traffic from port 67 to port 68 or
the <span class="docutils literal">DHCPSERVER</span> variable should be used on all VMs to restrict DHCP server
messages to only be allowed to originate from trusted DHCP servers. At the same
time anti-spoofing prevention must be enabled on all VMs in the subnet.</p>
<p>If <span class="docutils literal">CTRL_IP_LEARNING</span> is set to <span class="docutils literal">none</span>, libvirt does not do IP address
learning and referencing <span class="docutils literal">IP</span> without assigning it an explicit value is an
error.</p>
<p>The following XML provides an example for the activation of IP address learning
using the DHCP snooping method:</p>
<pre class="literal-block">&lt;interface type='bridge'&gt;
  &lt;source bridge='virbr0'/&gt;
  &lt;filterref filter='clean-traffic'&gt;
    &lt;parameter name='CTRL_IP_LEARNING' value='dhcp'/&gt;
  &lt;/filterref&gt;
&lt;/interface&gt;</pre>
</div>
<div class="section" id="reserved-variables">
<h2><a class="toc-backref" href="#id7">Reserved Variables</a><a class="headerlink" href="#reserved-variables" title="Link to this headline">¶</a></h2>
<p>The following table lists reserved variables in use by libvirt.</p>
<table>
<colgroup>
<col style="width: 24%"/>
<col style="width: 76%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Variable Name</p></th>
<th class="head"><p>Semantics</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>MAC</p></td>
<td><p>The MAC address of the interface</p></td>
</tr>
<tr><td><p>IP</p></td>
<td><p>The list of IP addresses in use by an interface</p></td>
</tr>
<tr><td><p>IPV6</p></td>
<td><p>The list of IPV6 addresses in use by an interface</p></td>
</tr>
<tr><td><p>DHCPSERVER</p></td>
<td><p>The list of IP addresses of trusted DHCP servers</p></td>
</tr>
<tr><td><p>DHCPSERVERV6</p></td>
<td><p>Not currently implemented: The list of IPv6 addresses of
trusted DHCP servers</p></td>
</tr>
<tr><td><p>CTRL_IP_LEARNING</p></td>
<td><p>The choice of the IP address detection mode</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="element-and-attribute-overview">
<h1><a class="toc-backref" href="#id8">Element and attribute overview</a><a class="headerlink" href="#element-and-attribute-overview" title="Link to this headline">¶</a></h1>
<p>The root element required for all network filters is named <span class="docutils literal">filter</span> with two
possible attributes. The <span class="docutils literal">name</span> attribute provides a unique name of the given
filter. The <span class="docutils literal">chain</span> attribute is optional but allows certain filters to be
better organized for more efficient processing by the firewall subsystem of the
underlying host. Currently the system only supports the chains
<span class="docutils literal">root,       ipv4, ipv6, arp and rarp</span>.</p>
<div class="section" id="references-to-other-filters">
<h2><a class="toc-backref" href="#id9">References to other filters</a><a class="headerlink" href="#references-to-other-filters" title="Link to this headline">¶</a></h2>
<p>Any filter may hold references to other filters. Individual filters may be
referenced multiple times in a filter tree but references between filters must
not introduce loops (directed acyclic graph).</p>
<p>The following shows the XML of the <span class="docutils literal"><span class="pre">clean-traffic</span></span> network filter referencing
several other filters.</p>
<pre class="literal-block">&lt;filter name='clean-traffic'&gt;
  &lt;uuid&gt;6ef53069-ba34-94a0-d33d-17751b9b8cb1&lt;/uuid&gt;
  &lt;filterref filter='no-mac-spoofing'/&gt;
  &lt;filterref filter='no-ip-spoofing'/&gt;
  &lt;filterref filter='allow-incoming-ipv4'/&gt;
  &lt;filterref filter='no-arp-spoofing'/&gt;
  &lt;filterref filter='no-other-l2-traffic'/&gt;
  &lt;filterref filter='qemu-announce-self'/&gt;
&lt;/filter&gt;</pre>
<p>To reference another filter, the XML node <span class="docutils literal">filterref</span> needs to be provided
inside a <span class="docutils literal">filter</span> node. This node must have the attribute <span class="docutils literal">filter</span> whose
value contains the name of the filter to be referenced.</p>
<p>New network filters can be defined at any time and may contain references to
network filters that are not known to libvirt, yet. However, once a virtual
machine is started or a network interface referencing a filter is to be
hotplugged, all network filters in the filter tree must be available. Otherwise
the virtual machine will not start or the network interface cannot be attached.</p>
</div>
<div class="section" id="filter-rules">
<h2><a class="toc-backref" href="#id10">Filter rules</a><a class="headerlink" href="#filter-rules" title="Link to this headline">¶</a></h2>
<p>The following XML shows a simple example of a network traffic filter
implementing a rule to drop traffic if the IP address (provided through the
value of the variable IP) in an outgoing IP packet is not the expected one, thus
preventing IP address spoofing by the VM.</p>
<pre class="literal-block">&lt;filter name='no-ip-spoofing' chain='ipv4'&gt;
  &lt;uuid&gt;fce8ae33-e69e-83bf-262e-30786c1f8072&lt;/uuid&gt;
  &lt;rule action='drop' direction='out' priority='500'&gt;
    &lt;ip match='no' srcipaddr='$IP'/&gt;
  &lt;/rule&gt;
&lt;/filter&gt;</pre>
<p>A traffic filtering rule starts with the <span class="docutils literal">rule</span> node. This node may contain up
to three attributes</p>
<ul>
<li><p>action -- mandatory; must either be <span class="docutils literal">drop</span> (matching the rule silently
discards the packet with no further analysis), <span class="docutils literal">reject</span> (matching the rule
generates an ICMP reject message with no further analysis) <span class="since">(since
0.9.0)</span> , <span class="docutils literal">accept</span> (matching the rule accepts the packet with no further
analysis), <span class="docutils literal">return</span> (matching the rule passes this filter, but returns
control to the calling filter for further analysis) <span class="since">(since 0.9.7)</span> ,
or <span class="docutils literal">continue</span> (matching the rule goes on to the next rule for further
analysis) <span class="since">(since 0.9.7)</span> .</p></li>
<li><p>direction -- mandatory; must either be <span class="docutils literal">in</span>, <span class="docutils literal">out</span> or <span class="docutils literal">inout</span> if the
rule is for incoming, outgoing or incoming-and-outgoing traffic</p></li>
<li><p>priority -- optional; the priority of the rule controls the order in which
the rule will be instantiated relative to other rules. Rules with lower value
will be instantiated before rules with higher values. Valid values are in the
range of 0 to 1000. <span class="since">Since 0.9.8</span> this has been extended to cover the
range of -1000 to 1000. If this attribute is not provided, priority 500 will
automatically be assigned.</p>
<p>Note that filtering rules in the <span class="docutils literal">root</span> chain are sorted with filters
connected to the <span class="docutils literal">root</span> chain following their priorities. This allows to
interleave filtering rules with access to filter chains. (See also section on
<a class="reference internal" href="#filtering-chain-priorities">Filtering chain priorities</a> .)</p>
</li>
<li><p>statematch -- optional; possible values are '0' or 'false' to turn the
underlying connection state matching off; default is 'true'</p>
<p>Also read the section on <a class="reference internal" href="#advanced-filter-configuration-topics">Advanced Filter Configuration Topics</a>.</p>
</li>
</ul>
<p>The above example indicates that the traffic of type <span class="docutils literal">ip</span> will be associated
with the chain 'ipv4' and the rule will have priority 500. If for example
another filter is referenced whose traffic of type <span class="docutils literal">ip</span> is also associated
with the chain 'ipv4' then that filter's rules will be ordered relative to the
priority 500 of the shown rule.</p>
<p>A rule may contain a single rule for filtering of traffic. The above example
shows that traffic of type <span class="docutils literal">ip</span> is to be filtered.</p>
<div class="section" id="supported-protocols">
<h3><a class="toc-backref" href="#id11">Supported protocols</a><a class="headerlink" href="#supported-protocols" title="Link to this headline">¶</a></h3>
<p>The following sections enumerate the list of protocols that are supported by the
network filtering subsystem. The type of traffic a rule is supposed to filter on
is provided in the <span class="docutils literal">rule</span> node as a nested node. Depending on the traffic type
a rule is filtering, the attributes are different. The above example showed the
single attribute <span class="docutils literal">srcipaddr</span> that is valid inside the <span class="docutils literal">ip</span> traffic filtering
node. The following sections show what attributes are valid and what type of
data they are expecting. The following datatypes are available:</p>
<ul class="simple">
<li><p>UINT8 : 8 bit integer; range 0-255</p></li>
<li><p>UINT16: 16 bit integer; range 0-65535</p></li>
<li><p>MAC_ADDR: MAC address in dotted decimal format, i.e., 00:11:22:33:44:55</p></li>
<li><p>MAC_MASK: MAC address mask in MAC address format, i.e., FF:FF:FF:FC:00:00</p></li>
<li><p>IP_ADDR: IP address in dotted decimal format, i.e., 10.1.2.3</p></li>
<li><p>IP_MASK: IP address mask in either dotted decimal format (255.255.248.0) or
CIDR mask (0-32)</p></li>
<li><p>IPV6_ADDR: IPv6 address in numbers format, i.e., FFFF::1</p></li>
<li><p>IPV6_MASK: IPv6 mask in numbers format (FFFF:FFFF:FC00::) or CIDR mask
(0-128)</p></li>
<li><p>STRING: A string</p></li>
<li><p>BOOLEAN: 'true', 'yes', '1' or 'false', 'no', '0'</p></li>
<li><p>IPSETFLAGS: The source and destination flags of the ipset described by up to
6 'src' or 'dst' elements selecting features from either the source or
destination part of the packet header; example: src,src,dst. The number of
'selectors' to provide here depends on the type of ipset that is referenced.</p></li>
</ul>
<p>Every attribute except for those of type IP_MASK or IPV6_MASK can be negated
using the <span class="docutils literal">match</span> attribute with value <span class="docutils literal">no</span>. Multiple negated attributes may
be grouped together. The following XML fragment shows such an example using
abstract attributes.</p>
<pre class="literal-block">[...]
&lt;rule action='drop' direction='in'&gt;
  &lt;protocol match='no' attribute1='value1' attribute2='value2'/&gt;
  &lt;protocol attribute3='value3'/&gt;
&lt;/rule&gt;
[...]</pre>
<p>Rules perform a logical AND evaluation on all values of the given protocol
attributes. Thus, if a single attribute's value does not match the one given in
the rule, the whole rule will be skipped during evaluation. Therefore, in the
above example incoming traffic will only be dropped if the protocol property
attribute1 does not match value1 AND the protocol property attribute2 does not
match value2 AND the protocol property attribute3 matches value3.</p>
<div class="section" id="mac-ethernet">
<h4><a class="toc-backref" href="#id12">MAC (Ethernet)</a><a class="headerlink" href="#mac-ethernet" title="Link to this headline">¶</a></h4>
<p>Protocol ID: <span class="docutils literal">mac</span></p>
<p>Note: Rules of this type should go into the <span class="docutils literal">root</span> chain.</p>
<table>
<colgroup>
<col style="width: 33%"/>
<col style="width: 33%"/>
<col style="width: 33%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Datatype</p></th>
<th class="head"><p>Semantics</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>srcmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of sender</p></td>
</tr>
<tr><td><p>srcmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC
address of sender</p></td>
</tr>
<tr><td><p>dstmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of
destination</p></td>
</tr>
<tr><td><p>dstmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC
address of destination</p></td>
</tr>
<tr><td><p>protocolid</p></td>
<td><p>UINT16 (0x600-0xffff),
STRING</p></td>
<td><p>Layer 3 protocol ID</p></td>
</tr>
<tr><td><p>comment <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>text with max. 256
characters</p></td>
</tr>
</tbody>
</table>
<p>Valid Strings for <span class="docutils literal">protocolid</span> are: arp, rarp, ipv4, ipv6</p>
<pre class="literal-block">[...]
&lt;mac match='no' srcmacaddr='$MAC'/&gt;
[...]</pre>
</div>
<div class="section" id="vlan-802-1q-since-0-9-8">
<h4><a class="toc-backref" href="#id13">VLAN (802.1Q) <span class="since">(Since 0.9.8)</span></a><a class="headerlink" href="#vlan-802-1q-since-0-9-8" title="Link to this headline">¶</a></h4>
<p>Protocol ID: <span class="docutils literal">vlan</span></p>
<p>Note: Rules of this type should go either into the <span class="docutils literal">root</span> or <span class="docutils literal">vlan</span> chain.</p>
<table>
<colgroup>
<col style="width: 22%"/>
<col style="width: 39%"/>
<col style="width: 39%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Datatype</p></th>
<th class="head"><p>Semantics</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>srcmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of sender</p></td>
</tr>
<tr><td><p>srcmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC address
of sender</p></td>
</tr>
<tr><td><p>dstmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of destination</p></td>
</tr>
<tr><td><p>dstmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC address
of destination</p></td>
</tr>
<tr><td><p>vlanid</p></td>
<td><p>UINT16 (0x0-0xfff, 0 -
4095)</p></td>
<td><p>VLAN ID</p></td>
</tr>
<tr><td><p>encap-protocol</p></td>
<td><p>UINT16 (0x03c-0xfff),
String</p></td>
<td><p>Encapsulated layer 3
protocol ID</p></td>
</tr>
<tr><td><p>comment</p></td>
<td><p>STRING</p></td>
<td><p>text with max. 256
characters</p></td>
</tr>
</tbody>
</table>
<p>Valid Strings for <span class="docutils literal"><span class="pre">encap-protocol</span></span> are: arp, ipv4, ipv6</p>
</div>
<div class="section" id="stp-spanning-tree-protocol-since-0-9-8">
<h4><a class="toc-backref" href="#id14">STP (Spanning Tree Protocol) (Since 0.9.8)</a><a class="headerlink" href="#stp-spanning-tree-protocol-since-0-9-8" title="Link to this headline">¶</a></h4>
<p>Protocol ID: <span class="docutils literal">stp</span></p>
<p>Note: Rules of this type should go either into the <span class="docutils literal">root</span> or <span class="docutils literal">stp</span> chain.</p>
<table>
<colgroup>
<col style="width: 28%"/>
<col style="width: 16%"/>
<col style="width: 55%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Datatype</p></th>
<th class="head"><p>Semantics</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>srcmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of sender</p></td>
</tr>
<tr><td><p>srcmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC address of sender</p></td>
</tr>
<tr><td><p>type</p></td>
<td><p>UINT8</p></td>
<td><p>Bridge Protocol Data Unit (BPDU) type</p></td>
</tr>
<tr><td><p>flags</p></td>
<td><p>UINT8</p></td>
<td><p>BPDU flag</p></td>
</tr>
<tr><td><p>root-priority</p></td>
<td><p>UINT16</p></td>
<td><p>Root priority (range start)</p></td>
</tr>
<tr><td><p>root-priority-hi</p></td>
<td><p>UINT16</p></td>
<td><p>Root priority range end</p></td>
</tr>
<tr><td><p>root-address</p></td>
<td><p>MAC_ADDRESS</p></td>
<td><p>Root MAC address</p></td>
</tr>
<tr><td><p>root-address-mask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Root MAC address mask</p></td>
</tr>
<tr><td><p>root-cost</p></td>
<td><p>UINT32</p></td>
<td><p>Root path cost (range start)</p></td>
</tr>
<tr><td><p>root-cost-hi</p></td>
<td><p>UINT32</p></td>
<td><p>Root path cost range end</p></td>
</tr>
<tr><td><p>sender-priority</p></td>
<td><p>UINT16</p></td>
<td><p>Sender priority (range start)</p></td>
</tr>
<tr><td><p>sender-priority-hi</p></td>
<td><p>UINT16</p></td>
<td><p>Sender priority range end</p></td>
</tr>
<tr><td><p>sender-address</p></td>
<td><p>MAC_ADDRESS</p></td>
<td><p>BPDU sender MAC address</p></td>
</tr>
<tr><td><p>sender-address-mask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>BPDU sender MAC address mask</p></td>
</tr>
<tr><td><p>port</p></td>
<td><p>UINT16</p></td>
<td><p>Port identifier (range start)</p></td>
</tr>
<tr><td><p>port_hi</p></td>
<td><p>UINT16</p></td>
<td><p>Port identifier range end</p></td>
</tr>
<tr><td><p>msg-age</p></td>
<td><p>UINT16</p></td>
<td><p>Message age timer (range start)</p></td>
</tr>
<tr><td><p>msg-age-hi</p></td>
<td><p>UINT16</p></td>
<td><p>Message age timer range end</p></td>
</tr>
<tr><td><p>max-age</p></td>
<td><p>UINT16</p></td>
<td><p>Maximum age timer (range start)</p></td>
</tr>
<tr><td><p>max-age-hi</p></td>
<td><p>UINT16</p></td>
<td><p>Maximum age timer range end</p></td>
</tr>
<tr><td><p>hello-time</p></td>
<td><p>UINT16</p></td>
<td><p>Hello time timer (range start)</p></td>
</tr>
<tr><td><p>hello-time-hi</p></td>
<td><p>UINT16</p></td>
<td><p>Hello time timer range end</p></td>
</tr>
<tr><td><p>forward-delay</p></td>
<td><p>UINT16</p></td>
<td><p>Forward delay (range start)</p></td>
</tr>
<tr><td><p>forward-delay-hi</p></td>
<td><p>UINT16</p></td>
<td><p>Forward delay range end</p></td>
</tr>
<tr><td><p>comment</p></td>
<td><p>STRING</p></td>
<td><p>text with max. 256 characters</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="arp-rarp">
<h4><a class="toc-backref" href="#id15">ARP/RARP</a><a class="headerlink" href="#arp-rarp" title="Link to this headline">¶</a></h4>
<p>Protocol ID: <span class="docutils literal">arp</span> or <span class="docutils literal">rarp</span></p>
<p>Note: Rules of this type should either go into the <span class="docutils literal">root</span> or <span class="docutils literal">arp/rarp</span>
chain.</p>
<table>
<colgroup>
<col style="width: 39%"/>
<col style="width: 22%"/>
<col style="width: 39%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Datatype</p></th>
<th class="head"><p>Semantics</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>srcmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of sender</p></td>
</tr>
<tr><td><p>srcmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC address
of sender</p></td>
</tr>
<tr><td><p>dstmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of destination</p></td>
</tr>
<tr><td><p>dstmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC address
of destination</p></td>
</tr>
<tr><td><p>hwtype</p></td>
<td><p>UINT16</p></td>
<td><p>Hardware type</p></td>
</tr>
<tr><td><p>protocoltype</p></td>
<td><p>UINT16</p></td>
<td><p>Protocol type</p></td>
</tr>
<tr><td><p>opcode</p></td>
<td><p>UINT16, STRING</p></td>
<td><p>Opcode</p></td>
</tr>
<tr><td><p>arpsrcmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>Source MAC address in
ARP/RARP packet</p></td>
</tr>
<tr><td><p>arpdstmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>Destination MAC address in
ARP/RARP packet</p></td>
</tr>
<tr><td><p>arpsrcipaddr</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Source IP address in
ARP/RARP packet</p></td>
</tr>
<tr><td><p>arpsrcipmask <span class="since">(Since
1.2.3)</span></p></td>
<td><p>IP_MASK</p></td>
<td><p>Source IP mask</p></td>
</tr>
<tr><td><p>arpdstipaddr</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Destination IP address in
ARP/RARP packet</p></td>
</tr>
<tr><td><p>arpdstipmask <span class="since">(Since
1.2.3)</span></p></td>
<td><p>IP_MASK</p></td>
<td><p>Destination IP mask</p></td>
</tr>
<tr><td><p>comment <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>text with max. 256
characters</p></td>
</tr>
<tr><td><p>gratuitous <span class="since">(Since
0.9.2)</span></p></td>
<td><p>BOOLEAN</p></td>
<td><p>boolean indicating whether
to check for gratuitous ARP
packet</p></td>
</tr>
</tbody>
</table>
<p>Valid strings for the <span class="docutils literal">Opcode</span> field are: Request, Reply, Request_Reverse,
Reply_Reverse, DRARP_Request, DRARP_Reply, DRARP_Error, InARP_Request, ARP_NAK</p>
</div>
<div class="section" id="ipv4">
<h4><a class="toc-backref" href="#id16">IPv4</a><a class="headerlink" href="#ipv4" title="Link to this headline">¶</a></h4>
<p>Protocol ID: <span class="docutils literal">ip</span></p>
<p>Note: Rules of this type should either go into the <span class="docutils literal">root</span> or <span class="docutils literal">ipv4</span> chain.</p>
<table>
<colgroup>
<col style="width: 33%"/>
<col style="width: 33%"/>
<col style="width: 33%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Datatype</p></th>
<th class="head"><p>Semantics</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>srcmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of sender</p></td>
</tr>
<tr><td><p>srcmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC
address of sender</p></td>
</tr>
<tr><td><p>dstmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of
destination</p></td>
</tr>
<tr><td><p>dstmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC
address of destination</p></td>
</tr>
<tr><td><p>srcipaddr</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Source IP address</p></td>
</tr>
<tr><td><p>srcipmask</p></td>
<td><p>IP_MASK</p></td>
<td><p>Mask applied to source
IP address</p></td>
</tr>
<tr><td><p>dstipaddr</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Destination IP address</p></td>
</tr>
<tr><td><p>dstipmask</p></td>
<td><p>IP_MASK</p></td>
<td><p>Mask applied to
destination IP address</p></td>
</tr>
<tr><td><p>protocol</p></td>
<td><p>UINT8, STRING</p></td>
<td><p>Layer 4 protocol
identifier</p></td>
</tr>
<tr><td><p>srcportstart</p></td>
<td><p>UINT16</p></td>
<td><p>Start of range of valid
source ports; requires
<span class="docutils literal">protocol</span></p></td>
</tr>
<tr><td><p>srcportend</p></td>
<td><p>UINT16</p></td>
<td><p>End of range of valid
source ports; requires
<span class="docutils literal">protocol</span></p></td>
</tr>
<tr><td><p>dstportstart</p></td>
<td><p>UINT16</p></td>
<td><p>Start of range of valid
destination ports;
requires <span class="docutils literal">protocol</span></p></td>
</tr>
<tr><td><p>dstportend</p></td>
<td><p>UINT16</p></td>
<td><p>End of range of valid
destination ports;
requires <span class="docutils literal">protocol</span></p></td>
</tr>
<tr><td><p>dscp</p></td>
<td><p>UINT8 (0x0-0x3f, 0 -
63)</p></td>
<td><p>Differentiated Services
Code Point</p></td>
</tr>
<tr><td><p>comment <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>text with max. 256
characters</p></td>
</tr>
</tbody>
</table>
<p>Valid strings for <span class="docutils literal">protocol</span> are: tcp, udp, udplite, esp, ah, icmp, igmp, sctp</p>
</div>
<div class="section" id="ipv6">
<h4><a class="toc-backref" href="#id17">IPv6</a><a class="headerlink" href="#ipv6" title="Link to this headline">¶</a></h4>
<p>Protocol ID: <span class="docutils literal">ipv6</span></p>
<p>Note: Rules of this type should either go into the <span class="docutils literal">root</span> or <span class="docutils literal">ipv6</span> chain.</p>
<table>
<colgroup>
<col style="width: 43%"/>
<col style="width: 15%"/>
<col style="width: 43%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Datatype</p></th>
<th class="head"><p>Semantics</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>srcmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of sender</p></td>
</tr>
<tr><td><p>srcmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC address of
sender</p></td>
</tr>
<tr><td><p>dstmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of destination</p></td>
</tr>
<tr><td><p>dstmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC address of
destination</p></td>
</tr>
<tr><td><p>srcipaddr</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Source IPv6 address</p></td>
</tr>
<tr><td><p>srcipmask</p></td>
<td><p>IPV6_MASK</p></td>
<td><p>Mask applied to source IPv6
address</p></td>
</tr>
<tr><td><p>dstipaddr</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Destination IPv6 address</p></td>
</tr>
<tr><td><p>dstipmask</p></td>
<td><p>IPV6_MASK</p></td>
<td><p>Mask applied to destination
IPv6 address</p></td>
</tr>
<tr><td><p>protocol</p></td>
<td><p>UINT8</p></td>
<td><p>Layer 4 protocol identifier</p></td>
</tr>
<tr><td><p>srcportstart</p></td>
<td><p>UINT16</p></td>
<td><p>Start of range of valid source
ports; requires <span class="docutils literal">protocol</span></p></td>
</tr>
<tr><td><p>srcportend</p></td>
<td><p>UINT16</p></td>
<td><p>End of range of valid source
ports; requires <span class="docutils literal">protocol</span></p></td>
</tr>
<tr><td><p>dstportstart</p></td>
<td><p>UINT16</p></td>
<td><p>Start of range of valid
destination ports; requires
<span class="docutils literal">protocol</span></p></td>
</tr>
<tr><td><p>dstportend</p></td>
<td><p>UINT16</p></td>
<td><p>End of range of valid
destination ports; requires
<span class="docutils literal">protocol</span></p></td>
</tr>
<tr><td><p>type <span class="since">(Since 1.2.12)</span></p></td>
<td><p>UINT8</p></td>
<td><p>ICMPv6 type; requires
<span class="docutils literal">protocol</span> to be set to
<span class="docutils literal">icmpv6</span></p></td>
</tr>
<tr><td><p>typeend <span class="since">(Since
1.2.12)</span></p></td>
<td><p>UINT8</p></td>
<td><p>ICMPv6 type end of range;
requires <span class="docutils literal">protocol</span> to be
set to <span class="docutils literal">icmpv6</span></p></td>
</tr>
<tr><td><p>code <span class="since">(Since 1.2.12)</span></p></td>
<td><p>UINT8</p></td>
<td><p>ICMPv6 code; requires
<span class="docutils literal">protocol</span> to be set to
<span class="docutils literal">icmpv6</span></p></td>
</tr>
<tr><td><p>code <span class="since">(Since 1.2.12)</span></p></td>
<td><p>UINT8</p></td>
<td><p>ICMPv6 code end of range;
requires <span class="docutils literal">protocol</span> to be
set to <span class="docutils literal">icmpv6</span></p></td>
</tr>
<tr><td><p>comment <span class="since">(Since 0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>text with max. 256 characters</p></td>
</tr>
</tbody>
</table>
<p>Valid strings for <span class="docutils literal">protocol</span> are: tcp, udp, udplite, esp, ah, icmpv6, sctp</p>
</div>
<div class="section" id="tcp-udp-sctp">
<h4><a class="toc-backref" href="#id18">TCP/UDP/SCTP</a><a class="headerlink" href="#tcp-udp-sctp" title="Link to this headline">¶</a></h4>
<p>Protocol ID: <span class="docutils literal">tcp</span>, <span class="docutils literal">udp</span>, <span class="docutils literal">sctp</span></p>
<p>Note: The chain parameter is ignored for this type of traffic and should either
be omitted or set to <span class="docutils literal">root</span>.</p>
<table>
<colgroup>
<col style="width: 33%"/>
<col style="width: 33%"/>
<col style="width: 33%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Datatype</p></th>
<th class="head"><p>Semantics</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>srcmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of sender</p></td>
</tr>
<tr><td><p>srcipaddr</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Source IP address</p></td>
</tr>
<tr><td><p>srcipmask</p></td>
<td><p>IP_MASK</p></td>
<td><p>Mask applied to source
IP address</p></td>
</tr>
<tr><td><p>dstipaddr</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Destination IP address</p></td>
</tr>
<tr><td><p>dstipmask</p></td>
<td><p>IP_MASK</p></td>
<td><p>Mask applied to
destination IP address</p></td>
</tr>
<tr><td><p>srcipfrom</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Start of range of
source IP address</p></td>
</tr>
<tr><td><p>srcipto</p></td>
<td><p>IP_ADDR</p></td>
<td><p>End of range of source
IP address</p></td>
</tr>
<tr><td><p>dstipfrom</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Start of range of
destination IP address</p></td>
</tr>
<tr><td><p>dstipto</p></td>
<td><p>IP_ADDR</p></td>
<td><p>End of range of
destination IP address</p></td>
</tr>
<tr><td><p>srcportstart</p></td>
<td><p>UINT16</p></td>
<td><p>Start of range of valid
source ports</p></td>
</tr>
<tr><td><p>srcportend</p></td>
<td><p>UINT16</p></td>
<td><p>End of range of valid
source ports</p></td>
</tr>
<tr><td><p>dstportstart</p></td>
<td><p>UINT16</p></td>
<td><p>Start of range of valid
destination ports</p></td>
</tr>
<tr><td><p>dstportend</p></td>
<td><p>UINT16</p></td>
<td><p>End of range of valid
destination ports</p></td>
</tr>
<tr><td><p>dscp</p></td>
<td><p>UINT8 (0x0-0x3f, 0 -
63)</p></td>
<td><p>Differentiated Services
Code Point</p></td>
</tr>
<tr><td><p>comment <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>text with max. 256
characters</p></td>
</tr>
<tr><td><p>state <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>comma separated list of
NEW,ESTA
BLISHED,RELATED,INVALID
or NONE</p></td>
</tr>
<tr><td><p>flags <span class="since">(Since
0.9.1)</span></p></td>
<td><p>STRING</p></td>
<td><p>TCP-only: format of
mask/flags with mask
and flags each being a
comma separated list of
SYN,ACK,URG,PSH,FIN,RST
or NONE or ALL</p></td>
</tr>
<tr><td><p>ipset <span class="since">(Since
0.9.13)</span></p></td>
<td><p>STRING</p></td>
<td><p>The name of an IPSet
managed outside of
libvirt</p></td>
</tr>
<tr><td><p>ipsetflags
<span class="since">(Since 0.9.13)</span></p></td>
<td><p>IPSETFLAGS</p></td>
<td><p>flags for the IPSet;
requires ipset
attribute</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="icmp">
<h4><a class="toc-backref" href="#id19">ICMP</a><a class="headerlink" href="#icmp" title="Link to this headline">¶</a></h4>
<p>Protocol ID: <span class="docutils literal">icmp</span></p>
<p>Note: The chain parameter is ignored for this type of traffic and should either
be omitted or set to <span class="docutils literal">root</span>.</p>
<table>
<colgroup>
<col style="width: 33%"/>
<col style="width: 33%"/>
<col style="width: 33%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Datatype</p></th>
<th class="head"><p>Semantics</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>srcmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of sender</p></td>
</tr>
<tr><td><p>srcmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC
address of sender</p></td>
</tr>
<tr><td><p>dstmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of
destination</p></td>
</tr>
<tr><td><p>dstmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC
address of destination</p></td>
</tr>
<tr><td><p>srcipaddr</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Source IP address</p></td>
</tr>
<tr><td><p>srcipmask</p></td>
<td><p>IP_MASK</p></td>
<td><p>Mask applied to source
IP address</p></td>
</tr>
<tr><td><p>dstipaddr</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Destination IP address</p></td>
</tr>
<tr><td><p>dstipmask</p></td>
<td><p>IP_MASK</p></td>
<td><p>Mask applied to
destination IP address</p></td>
</tr>
<tr><td><p>srcipfrom</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Start of range of
source IP address</p></td>
</tr>
<tr><td><p>srcipto</p></td>
<td><p>IP_ADDR</p></td>
<td><p>End of range of source
IP address</p></td>
</tr>
<tr><td><p>dstipfrom</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Start of range of
destination IP address</p></td>
</tr>
<tr><td><p>dstipto</p></td>
<td><p>IP_ADDR</p></td>
<td><p>End of range of
destination IP address</p></td>
</tr>
<tr><td><p>type</p></td>
<td><p>UINT16</p></td>
<td><p>ICMP type</p></td>
</tr>
<tr><td><p>code</p></td>
<td><p>UINT16</p></td>
<td><p>ICMP code</p></td>
</tr>
<tr><td><p>dscp</p></td>
<td><p>UINT8 (0x0-0x3f, 0 -
63)</p></td>
<td><p>Differentiated Services
Code Point</p></td>
</tr>
<tr><td><p>comment <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>text with max. 256
characters</p></td>
</tr>
<tr><td><p>state <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>comma separated list of
NEW,ESTA
BLISHED,RELATED,INVALID
or NONE</p></td>
</tr>
<tr><td><p>ipset <span class="since">(Since
0.9.13)</span></p></td>
<td><p>STRING</p></td>
<td><p>The name of an IPSet
managed outside of
libvirt</p></td>
</tr>
<tr><td><p>ipsetflags
<span class="since">(Since 0.9.13)</span></p></td>
<td><p>IPSETFLAGS</p></td>
<td><p>flags for the IPSet;
requires ipset
attribute</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="igmp-esp-ah-udplite-all">
<h4><a class="toc-backref" href="#id20">IGMP, ESP, AH, UDPLITE, 'ALL'</a><a class="headerlink" href="#igmp-esp-ah-udplite-all" title="Link to this headline">¶</a></h4>
<p>Protocol ID: <span class="docutils literal">igmp</span>, <span class="docutils literal">esp</span>, <span class="docutils literal">ah</span>, <span class="docutils literal">udplite</span>, <span class="docutils literal">all</span></p>
<p>Note: The chain parameter is ignored for this type of traffic and should either
be omitted or set to <span class="docutils literal">root</span>.</p>
<table>
<colgroup>
<col style="width: 33%"/>
<col style="width: 33%"/>
<col style="width: 33%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Datatype</p></th>
<th class="head"><p>Semantics</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>srcmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of sender</p></td>
</tr>
<tr><td><p>srcmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC
address of sender</p></td>
</tr>
<tr><td><p>dstmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of
destination</p></td>
</tr>
<tr><td><p>dstmacmask</p></td>
<td><p>MAC_MASK</p></td>
<td><p>Mask applied to MAC
address of destination</p></td>
</tr>
<tr><td><p>srcipaddr</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Source IP address</p></td>
</tr>
<tr><td><p>srcipmask</p></td>
<td><p>IP_MASK</p></td>
<td><p>Mask applied to source
IP address</p></td>
</tr>
<tr><td><p>dstipaddr</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Destination IP address</p></td>
</tr>
<tr><td><p>dstipmask</p></td>
<td><p>IP_MASK</p></td>
<td><p>Mask applied to
destination IP address</p></td>
</tr>
<tr><td><p>srcipfrom</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Start of range of
source IP address</p></td>
</tr>
<tr><td><p>srcipto</p></td>
<td><p>IP_ADDR</p></td>
<td><p>End of range of source
IP address</p></td>
</tr>
<tr><td><p>dstipfrom</p></td>
<td><p>IP_ADDR</p></td>
<td><p>Start of range of
destination IP address</p></td>
</tr>
<tr><td><p>dstipto</p></td>
<td><p>IP_ADDR</p></td>
<td><p>End of range of
destination IP address</p></td>
</tr>
<tr><td><p>dscp</p></td>
<td><p>UINT8 (0x0-0x3f, 0 -
63)</p></td>
<td><p>Differentiated Services
Code Point</p></td>
</tr>
<tr><td><p>comment <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>text with max. 256
characters</p></td>
</tr>
<tr><td><p>state <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>comma separated list of
NEW,ESTA
BLISHED,RELATED,INVALID
or NONE</p></td>
</tr>
<tr><td><p>ipset <span class="since">(Since
0.9.13)</span></p></td>
<td><p>STRING</p></td>
<td><p>The name of an IPSet
managed outside of
libvirt</p></td>
</tr>
<tr><td><p>ipsetflags
<span class="since">(Since 0.9.13)</span></p></td>
<td><p>IPSETFLAGS</p></td>
<td><p>flags for the IPSet;
requires ipset
attribute</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="tcp-udp-sctp-over-ipv6">
<h4><a class="toc-backref" href="#id21">TCP/UDP/SCTP over IPV6</a><a class="headerlink" href="#tcp-udp-sctp-over-ipv6" title="Link to this headline">¶</a></h4>
<p>Protocol ID: <span class="docutils literal"><span class="pre">tcp-ipv6</span></span>, <span class="docutils literal"><span class="pre">udp-ipv6</span></span>, <span class="docutils literal"><span class="pre">sctp-ipv6</span></span></p>
<p>Note: The chain parameter is ignored for this type of traffic and should either
be omitted or set to <span class="docutils literal">root</span>.</p>
<table>
<colgroup>
<col style="width: 33%"/>
<col style="width: 33%"/>
<col style="width: 33%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Datatype</p></th>
<th class="head"><p>Semantics</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>srcmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of sender</p></td>
</tr>
<tr><td><p>srcipaddr</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Source IP address</p></td>
</tr>
<tr><td><p>srcipmask</p></td>
<td><p>IPV6_MASK</p></td>
<td><p>Mask applied to source
IP address</p></td>
</tr>
<tr><td><p>dstipaddr</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Destination IP address</p></td>
</tr>
<tr><td><p>dstipmask</p></td>
<td><p>IPV6_MASK</p></td>
<td><p>Mask applied to
destination IP address</p></td>
</tr>
<tr><td><p>srcipfrom</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Start of range of
source IP address</p></td>
</tr>
<tr><td><p>srcipto</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>End of range of source
IP address</p></td>
</tr>
<tr><td><p>dstipfrom</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Start of range of
destination IP address</p></td>
</tr>
<tr><td><p>dstipto</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>End of range of
destination IP address</p></td>
</tr>
<tr><td><p>srcportstart</p></td>
<td><p>UINT16</p></td>
<td><p>Start of range of valid
source ports</p></td>
</tr>
<tr><td><p>srcportend</p></td>
<td><p>UINT16</p></td>
<td><p>End of range of valid
source ports</p></td>
</tr>
<tr><td><p>dstportstart</p></td>
<td><p>UINT16</p></td>
<td><p>Start of range of valid
destination ports</p></td>
</tr>
<tr><td><p>dstportend</p></td>
<td><p>UINT16</p></td>
<td><p>End of range of valid
destination ports</p></td>
</tr>
<tr><td><p>dscp</p></td>
<td><p>UINT8 (0x0-0x3f, 0 -
63)</p></td>
<td><p>Differentiated Services
Code Point</p></td>
</tr>
<tr><td><p>comment <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>text with max. 256
characters</p></td>
</tr>
<tr><td><p>state <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>comma separated list of
NEW,ESTA
BLISHED,RELATED,INVALID
or NONE</p></td>
</tr>
<tr><td><p>flags <span class="since">(Since
0.9.1)</span></p></td>
<td><p>STRING</p></td>
<td><p>TCP-only: format of
mask/flags with mask
and flags each being a
comma separated list of
SYN,ACK,URG,PSH,FIN,RST
or NONE or ALL</p></td>
</tr>
<tr><td><p>ipset <span class="since">(Since
0.9.13)</span></p></td>
<td><p>STRING</p></td>
<td><p>The name of an IPSet
managed outside of
libvirt</p></td>
</tr>
<tr><td><p>ipsetflags
<span class="since">(Since 0.9.13)</span></p></td>
<td><p>IPSETFLAGS</p></td>
<td><p>flags for the IPSet;
requires ipset
attribute</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="icmpv6">
<h4><a class="toc-backref" href="#id22">ICMPv6</a><a class="headerlink" href="#icmpv6" title="Link to this headline">¶</a></h4>
<p>Protocol ID: <span class="docutils literal">icmpv6</span></p>
<p>Note: The chain parameter is ignored for this type of traffic and should either
be omitted or set to <span class="docutils literal">root</span>.</p>
<table>
<colgroup>
<col style="width: 33%"/>
<col style="width: 33%"/>
<col style="width: 33%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Datatype</p></th>
<th class="head"><p>Semantics</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>srcmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of sender</p></td>
</tr>
<tr><td><p>srcipaddr</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Source IPv6 address</p></td>
</tr>
<tr><td><p>srcipmask</p></td>
<td><p>IPV6_MASK</p></td>
<td><p>Mask applied to source
IPv6 address</p></td>
</tr>
<tr><td><p>dstipaddr</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Destination IPv6
address</p></td>
</tr>
<tr><td><p>dstipmask</p></td>
<td><p>IPV6_MASK</p></td>
<td><p>Mask applied to
destination IPv6
address</p></td>
</tr>
<tr><td><p>srcipfrom</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Start of range of
source IP address</p></td>
</tr>
<tr><td><p>srcipto</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>End of range of source
IP address</p></td>
</tr>
<tr><td><p>dstipfrom</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Start of range of
destination IP address</p></td>
</tr>
<tr><td><p>dstipto</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>End of range of
destination IP address</p></td>
</tr>
<tr><td><p>type</p></td>
<td><p>UINT16</p></td>
<td><p>ICMPv6 type</p></td>
</tr>
<tr><td><p>code</p></td>
<td><p>UINT16</p></td>
<td><p>ICMPv6 code</p></td>
</tr>
<tr><td><p>dscp</p></td>
<td><p>UINT8 (0x0-0x3f, 0 -
63)</p></td>
<td><p>Differentiated Services
Code Point</p></td>
</tr>
<tr><td><p>comment <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>text with max. 256
characters</p></td>
</tr>
<tr><td><p>state <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>comma separated list of
NEW,ESTA
BLISHED,RELATED,INVALID
or NONE</p></td>
</tr>
<tr><td><p>ipset <span class="since">(Since
0.9.13)</span></p></td>
<td><p>STRING</p></td>
<td><p>The name of an IPSet
managed outside of
libvirt</p></td>
</tr>
<tr><td><p>ipsetflags
<span class="since">(Since 0.9.13)</span></p></td>
<td><p>IPSETFLAGS</p></td>
<td><p>flags for the IPSet;
requires ipset
attribute</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="esp-ah-udplite-all-over-ipv6">
<h4><a class="toc-backref" href="#id23">ESP, AH, UDPLITE, 'ALL' over IPv6</a><a class="headerlink" href="#esp-ah-udplite-all-over-ipv6" title="Link to this headline">¶</a></h4>
<p>Protocol ID: <span class="docutils literal"><span class="pre">esp-ipv6</span></span>, <span class="docutils literal"><span class="pre">ah-ipv6</span></span>, <span class="docutils literal"><span class="pre">udplite-ipv6</span></span>, <span class="docutils literal"><span class="pre">all-ipv6</span></span></p>
<p>Note: The chain parameter is ignored for this type of traffic and should either
be omitted or set to <span class="docutils literal">root</span>.</p>
<table>
<colgroup>
<col style="width: 33%"/>
<col style="width: 33%"/>
<col style="width: 33%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Attribute</p></th>
<th class="head"><p>Datatype</p></th>
<th class="head"><p>Semantics</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>srcmacaddr</p></td>
<td><p>MAC_ADDR</p></td>
<td><p>MAC address of sender</p></td>
</tr>
<tr><td><p>srcipaddr</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Source IPv6 address</p></td>
</tr>
<tr><td><p>srcipmask</p></td>
<td><p>IPV6_MASK</p></td>
<td><p>Mask applied to source
IPv6 address</p></td>
</tr>
<tr><td><p>dstipaddr</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Destination IPv6
address</p></td>
</tr>
<tr><td><p>dstipmask</p></td>
<td><p>IPV6_MASK</p></td>
<td><p>Mask applied to
destination IPv6
address</p></td>
</tr>
<tr><td><p>srcipfrom</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Start of range of
source IP address</p></td>
</tr>
<tr><td><p>srcipto</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>End of range of source
IP address</p></td>
</tr>
<tr><td><p>dstipfrom</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>Start of range of
destination IP address</p></td>
</tr>
<tr><td><p>dstipto</p></td>
<td><p>IPV6_ADDR</p></td>
<td><p>End of range of
destination IP address</p></td>
</tr>
<tr><td><p>dscp</p></td>
<td><p>UINT8 (0x0-0x3f, 0 -
63)</p></td>
<td><p>Differentiated Services
Code Point</p></td>
</tr>
<tr><td><p>comment <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>text with max. 256
characters</p></td>
</tr>
<tr><td><p>state <span class="since">(Since
0.8.5)</span></p></td>
<td><p>STRING</p></td>
<td><p>comma separated list of
NEW,ESTA
BLISHED,RELATED,INVALID
or NONE</p></td>
</tr>
<tr><td><p>ipset <span class="since">(Since
0.9.13)</span></p></td>
<td><p>STRING</p></td>
<td><p>The name of an IPSet
managed outside of
libvirt</p></td>
</tr>
<tr><td><p>ipsetflags
<span class="since">(Since 0.9.13)</span></p></td>
<td><p>IPSETFLAGS</p></td>
<td><p>flags for the IPSet;
requires ipset
attribute</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="advanced-filter-configuration-topics">
<h2><a class="toc-backref" href="#id24">Advanced Filter Configuration Topics</a><a class="headerlink" href="#advanced-filter-configuration-topics" title="Link to this headline">¶</a></h2>
<p>The following sections discuss advanced filter configuration topics.</p>
<div class="section" id="connection-tracking">
<h3><a class="toc-backref" href="#id25">Connection tracking</a><a class="headerlink" href="#connection-tracking" title="Link to this headline">¶</a></h3>
<p>The network filtering subsystem (on Linux) makes use of the connection tracking
support of iptables. This helps in enforcing the directionality of network
traffic (state match) as well as counting and limiting the number of
simultaneous connections towards a VM. As an example, if a VM has TCP port 8080
open as a server, clients may connect to the VM on port 8080. Connection
tracking and enforcement of directionality then prevents the VM from initiating
a connection from (TCP client) port 8080 to the host back to a remote host. More
importantly, tracking helps to prevent remote attackers from establishing a
connection back to a VM. For example, if the user inside the VM established a
connection to port 80 on an attacker site, then the attacker will not be able to
initiate a connection from TCP port 80 back towards the VM. By default the
connection state match that enables connection tracking and then enforcement of
directionality of traffic is turned on.</p>
<p>The following shows an example XML fragment where this feature has been turned
off for incoming connections to TCP port 12345.</p>
<pre class="literal-block">[...]
&lt;rule direction='in' action='accept' statematch='false'&gt;
  &lt;tcp dstportstart='12345'/&gt;
&lt;/rule&gt;
[...]</pre>
<p>This now allows incoming traffic to TCP port 12345, but would also enable the
initiation from (client) TCP port 12345 within the VM, which may or may not be
desirable.</p>
</div>
<div class="section" id="limiting-number-of-connections">
<h3><a class="toc-backref" href="#id26">Limiting Number of Connections</a><a class="headerlink" href="#limiting-number-of-connections" title="Link to this headline">¶</a></h3>
<p>To limit the number of connections a VM may establish, a rule must be provided
that sets a limit of connections for a given type of traffic. If for example a
VM is supposed to be allowed to only ping one other IP address at a time and is
supposed to have only one active incoming ssh connection at a time, the
following XML fragment can be used to achieve this.</p>
<pre class="literal-block">[...]
&lt;rule action='drop' direction='in' priority='400'&gt;
  &lt;tcp connlimit-above='1'/&gt;
&lt;/rule&gt;
&lt;rule action='accept' direction='in' priority='500'&gt;
  &lt;tcp dstportstart='22'/&gt;
&lt;/rule&gt;
&lt;rule action='drop' direction='out' priority='400'&gt;
  &lt;icmp connlimit-above='1'/&gt;
&lt;/rule&gt;
&lt;rule action='accept' direction='out' priority='500'&gt;
  &lt;icmp/&gt;
&lt;/rule&gt;
&lt;rule action='accept' direction='out' priority='500'&gt;
  &lt;udp dstportstart='53'/&gt;
&lt;/rule&gt;
&lt;rule action='drop' direction='inout' priority='1000'&gt;
  &lt;all/&gt;
&lt;/rule&gt;
[...]</pre>
<p>Note that the rule for the limit has to logically appear before the rule for
accepting the traffic.</p>
<p>An additional rule for letting DNS traffic to port 22 go out the VM has been
added to avoid ssh sessions not getting established for reasons related to DNS
lookup failures by the ssh daemon. Leaving this rule out may otherwise lead to
fun-filled debugging joy (symptom: ssh client seems to hang while trying to
connect).</p>
<p>Lot of care must be taken with timeouts related to tracking of traffic. An ICMP
ping that the user may have terminated inside the VM may have a long timeout in
the host's connection tracking system and therefore not allow another ICMP ping
to go through for a while. Therefore, the timeouts have to be tuned in the
host's sysfs, i.e.,</p>
<pre class="literal-block">echo 3 &gt; /proc/sys/net/netfilter/nf_conntrack_icmp_timeout</pre>
<p>sets the ICMP connection tracking timeout to 3 seconds. The effect of this is
that once one ping is terminated, another one can start after 3 seconds.</p>
<p>Further, we want to point out that a client that for whatever reason has not
properly closed a TCP connection may cause a connection to be held open for a
longer period of time, depending to what timeout the <span class="docutils literal">TCP established</span> state
timeout has been set to on the host. Also, idle connections may time out in the
connection tracking system but can be reactivated once packets are exchanged.
However, a newly initiated connection may force an idle connection into TCP
backoff if the number of allowed connections is set to a too low limit, the new
connection is established and hits (not exceeds) the limit of allowed
connections and for example a key is pressed on the old ssh session, which now
has become unresponsive due to its traffic being dropped. Therefore, the limit
of connections should be rather high so that fluctuations in new TCP connections
don't cause odd traffic behavior in relation to idle connections.</p>
</div>
</div>
</div>
<div class="section" id="command-line-tools">
<h1><a class="toc-backref" href="#id27">Command line tools</a><a class="headerlink" href="#command-line-tools" title="Link to this headline">¶</a></h1>
<p>The libvirt command line tool <span class="docutils literal">virsh</span> has been extended with life-cycle
support for network filters. All commands related to the network filtering
subsystem start with the prefix <span class="docutils literal">nwfilter</span>. The following commands are
available:</p>
<ul class="simple">
<li><p>nwfilter-list : list UUIDs and names of all network filters</p></li>
<li><p>nwfilter-define : define a new network filter or update an existing one</p></li>
<li><p>nwfilter-undefine : delete a network filter given its name; it must not be
currently in use</p></li>
<li><p>nwfilter-dumpxml : display a network filter given its name</p></li>
<li><p>nwfilter-edit : edit a network filter given its name</p></li>
</ul>
</div>
<div class="section" id="pre-existing-network-filters">
<h1><a class="toc-backref" href="#id28">Pre-existing network filters</a><a class="headerlink" href="#pre-existing-network-filters" title="Link to this headline">¶</a></h1>
<p>The following is a list of example network filters that are automatically
installed with libvirt.</p>
<table>
<colgroup>
<col style="width: 28%"/>
<col style="width: 72%"/>
</colgroup>
<thead>
<tr><th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>no-arp-spoofing</p></td>
<td><p>Prevent a VM from spoofing ARP traffic; this filter
only allows ARP request and reply messages and
enforces that those packets contain the MAC and IP
addresses of the VM.</p></td>
</tr>
<tr><td><p>allow-arp</p></td>
<td><p>Allow ARP traffic in both directions</p></td>
</tr>
<tr><td><p>allow-ipv4</p></td>
<td><p>Allow IPv4 traffic in both directions</p></td>
</tr>
<tr><td><p>allow-ipv6</p></td>
<td><p>Allow IPv6 traffic in both directions</p></td>
</tr>
<tr><td><p>allow-incoming-ipv4</p></td>
<td><p>Allow incoming IPv4 traffic</p></td>
</tr>
<tr><td><p>allow-incoming-ipv6</p></td>
<td><p>Allow incoming IPv6 traffic</p></td>
</tr>
<tr><td><p>allow-dhcp</p></td>
<td><p>Allow a VM to request an IP address via DHCP (from
any DHCP server)</p></td>
</tr>
<tr><td><p>allow-dhcpv6</p></td>
<td><p>Similar to allow-dhcp, but for DHCPv6</p></td>
</tr>
<tr><td><p>allow-dhcp-server</p></td>
<td><p>Allow a VM to request an IP address from a specified
DHCP server. The dotted decimal IP address of the
DHCP server must be provided in a reference to this
filter. The name of the variable must be
<em>DHCPSERVER</em>.</p></td>
</tr>
<tr><td><p>allow-dhcpv6-server</p></td>
<td><p>Similar to allow-dhcp-server, but for DHCPv6</p></td>
</tr>
<tr><td><p>no-ip-spoofing</p></td>
<td><p>Prevent a VM from sending of IPv4 packets with a
source IP address different from the one in the
packet.</p></td>
</tr>
<tr><td><p>no-ipv6-spoofing</p></td>
<td><p>Similar to no-ip-spoofing, but for IPv6</p></td>
</tr>
<tr><td><p>no-ip-multicast</p></td>
<td><p>Prevent a VM from sending IP multicast packets.</p></td>
</tr>
<tr><td><p>no-ipv6-multicast</p></td>
<td><p>Similar to no-ip-multicast, but for IPv6</p></td>
</tr>
<tr><td><p>clean-traffic</p></td>
<td><p>Prevent MAC, IP and ARP spoofing. This filter
references several other filters as building blocks.</p></td>
</tr>
</tbody>
</table>
<p>Note that most of the above filters are only building blocks and require a
combination with other filters to provide useful network traffic filtering. The
most useful one in the above list is the <em>clean-traffic</em> filter. This filter
itself can for example be combined with the <em>no-ip-multicast</em> filter to prevent
virtual machines from sending IP multicast traffic on top of the prevention of
packet spoofing.</p>
</div>
<div class="section" id="writing-your-own-filters">
<h1><a class="toc-backref" href="#id29">Writing your own filters</a><a class="headerlink" href="#writing-your-own-filters" title="Link to this headline">¶</a></h1>
<p>Since libvirt only provides a couple of example networking filters, you may
consider writing your own. When planning on doing so there are a couple of
things you may need to know regarding the network filtering subsystem and how it
works internally. Certainly you also have to know and understand the protocols
very well that you want to be filtering on so that no further traffic than what
you want can pass and that in fact the traffic you want to allow does pass.</p>
<p>The network filtering subsystem is currently only available on Linux hosts and
only works for QEMU and KVM type of virtual machines. On Linux it builds upon
the support for <span class="docutils literal">ebtables</span>, <span class="docutils literal">iptables</span> and <span class="docutils literal">ip6tables</span> and makes use of
their features. From the above list of supported protocols the following ones
are implemented using <span class="docutils literal">ebtables</span>:</p>
<ul class="simple">
<li><p>mac</p></li>
<li><p>stp (spanning tree protocol)</p></li>
<li><p>vlan (802.1Q)</p></li>
<li><p>arp, rarp</p></li>
<li><p>ipv4</p></li>
<li><p>ipv6</p></li>
</ul>
<p>All other protocols over IPv4 are supported using iptables, those over IPv6 are
implemented using ip6tables.</p>
<p>On a Linux host, all traffic filtering instantiated by libvirt's network filter
subsystem first passes through the filtering support implemented by ebtables and
only then through iptables or ip6tables filters. If a filter tree has rules with
the protocols <span class="docutils literal">mac</span>, <span class="docutils literal">stp</span>, <span class="docutils literal">vlan</span> <span class="docutils literal">arp</span>, <span class="docutils literal">rarp</span>, <span class="docutils literal">ipv4</span>, or
<span class="docutils literal">ipv6</span> ebtables rules will automatically be instantiated.</p>
<p>The role of the <span class="docutils literal">chain</span> attribute in the network filter XML is that internally
a new user-defined ebtables table is created that then for example receives all
<span class="docutils literal">arp</span> traffic coming from or going to a virtual machine if the chain <span class="docutils literal">arp</span>
has been specified. Further, a rule is generated in an interface's <span class="docutils literal">root</span>
chain that directs all ipv4 traffic into the user-defined chain. Therefore, all
ARP traffic rules should then be placed into filters specifying this chain. This
type of branching into user-defined tables is only supported with filtering on
the ebtables layer.</p>
<p><span class="since">Since 0.9.8</span> multiple chains for the same protocol can be created. For
this the name of the chain must have a prefix of one of the previously
enumerated protocols. To create an additional chain for handling of ARP traffic,
a chain with name <span class="docutils literal"><span class="pre">arp-test</span></span> can be specified.</p>
<p>As an example, it is possible to filter on UDP traffic by source and destination
ports using the <span class="docutils literal">ip</span> protocol filter and specifying attributes for the
protocol, source and destination IP addresses and ports of UDP packets that are
to be accepted. This allows early filtering of UDP traffic with ebtables.
However, once an IP or IPv6 packet, such as a UDP packet, has passed the
ebtables layer and there is at least one rule in a filter tree that instantiates
iptables or ip6tables rules, a rule to let the UDP packet pass will also be
necessary to be provided for those filtering layers. This can be achieved with a
rule containing an appropriate <span class="docutils literal">udp</span> or <span class="docutils literal"><span class="pre">udp-ipv6</span></span> traffic filtering node.</p>
<div class="section" id="example-custom-filter">
<h2><a class="toc-backref" href="#id30">Example custom filter</a><a class="headerlink" href="#example-custom-filter" title="Link to this headline">¶</a></h2>
<p>As an example we want to now build a filter that fulfills the following list of
requirements:</p>
<ul class="simple">
<li><p>prevents a VM's interface from MAC, IP and ARP spoofing</p></li>
<li><p>opens only TCP ports 22 and 80 of a VM's interface</p></li>
<li><p>allows the VM to send ping traffic from an interface but not let the VM be
pinged on the interface</p></li>
<li><p>allows the VM to do DNS lookups (UDP towards port 53)</p></li>
</ul>
<p>The requirement to prevent spoofing is fulfilled by the existing
<span class="docutils literal"><span class="pre">clean-traffic</span></span> network filter, thus we will reference this filter from our
custom filter.</p>
<p>To enable traffic for TCP ports 22 and 80 we will add 2 rules to enable this
type of traffic. To allow the VM to send ping traffic we will add a rule for
ICMP traffic. For simplicity reasons we allow general ICMP traffic to be
initiated from the VM, not just ICMP echo request and response messages. To then
disallow all other traffic to reach or be initiated by the VM we will then need
to add a rule that drops all other traffic. Assuming our VM is called <em>test</em> and
the interface we want to associate our filter with is called <em>eth0</em>, we name our
filter <em>test-eth0</em>. The result of these considerations is the following network
filter XML:</p>
<pre class="literal-block">&lt;filter name='test-eth0'&gt;
  &lt;!-- reference the clean traffic filter to prevent
       MAC, IP and ARP spoofing. By not providing
       and IP address parameter, libvirt will detect the
       IP address the VM is using. --&gt;
  &lt;filterref filter='clean-traffic'/&gt;

  &lt;!-- enable TCP ports 22 (ssh) and 80 (http) to be reachable --&gt;
  &lt;rule action='accept' direction='in'&gt;
    &lt;tcp dstportstart='22'/&gt;
  &lt;/rule&gt;

  &lt;rule action='accept' direction='in'&gt;
    &lt;tcp dstportstart='80'/&gt;
  &lt;/rule&gt;

  &lt;!-- enable general ICMP traffic to be initiated by the VM;
       this includes ping traffic --&gt;
  &lt;rule action='accept' direction='out'&gt;
    &lt;icmp/&gt;
  &lt;/rule&gt;

  &lt;!-- enable outgoing DNS lookups using UDP --&gt;
  &lt;rule action='accept' direction='out'&gt;
    &lt;udp dstportstart='53'/&gt;
  &lt;/rule&gt;

  &lt;!-- drop all other traffic --&gt;
  &lt;rule action='drop' direction='inout'&gt;
    &lt;all/&gt;
  &lt;/rule&gt;

&lt;/filter&gt;</pre>
<p>Note that none of the rules in the above XML contain the IP address of the VM as
either source or destination address, yet the filtering of the traffic works
correctly. The reason is that the evaluation of the rules internally happens on
a per-interface basis and the rules are evaluated based on the knowledge about
which (tap) interface has sent or will receive the packet rather than what their
source or destination IP address may be.</p>
<p>An XML fragment for a possible network interface description inside the domain
XML of the <span class="docutils literal">test</span> VM could then look like this:</p>
<pre class="literal-block">[...]
&lt;interface type='bridge'&gt;
  &lt;source bridge='mybridge'/&gt;
  &lt;filterref filter='test-eth0'/&gt;
&lt;/interface&gt;
[...]</pre>
<p>To more strictly control the ICMP traffic and enforce that only ICMP echo
requests can be sent from the VM and only ICMP echo responses be received by the
VM, the above <span class="docutils literal">ICMP</span> rule can be replaced with the following two rules:</p>
<pre class="literal-block">&lt;!-- enable outgoing ICMP echo requests--&gt;
&lt;rule action='accept' direction='out'&gt;
  &lt;icmp type='8'/&gt;
&lt;/rule&gt;

&lt;!-- enable incoming ICMP echo replies--&gt;
&lt;rule action='accept' direction='in'&gt;
  &lt;icmp type='0'/&gt;
&lt;/rule&gt;</pre>
</div>
<div class="section" id="second-example-custom-filter">
<h2><a class="toc-backref" href="#id31">Second example custom filter</a><a class="headerlink" href="#second-example-custom-filter" title="Link to this headline">¶</a></h2>
<p>In this example we now want to build a similar filter as in the example above,
but extend the list of requirements with an ftp server located inside the VM.
Further, we will be using features that have been added in <span class="since">version
0.8.5</span> . The requirements for this filter are:</p>
<ul class="simple">
<li><p>prevents a VM's interface from MAC, IP and ARP spoofing</p></li>
<li><p>opens only TCP ports 22 and 80 of a VM's interface</p></li>
<li><p>allows the VM to send ping traffic from an interface but not let the VM be
pinged on the interface</p></li>
<li><p>allows the VM to do DNS lookups (UDP towards port 53)</p></li>
<li><p>enable an ftp server (in active mode) to be run inside the VM</p></li>
</ul>
<p>The additional requirement of allowing an ftp server to be run inside the VM
maps into the requirement of allowing port 21 to be reachable for ftp control
traffic as well as enabling the VM to establish an outgoing tcp connection
originating from the VM's TCP port 20 back to the ftp client (ftp active mode).
There are several ways of how this filter can be written and we present 2
solutions.</p>
<p>The 1st solution makes use of the <span class="docutils literal">state</span> attribute of the TCP protocol that
gives us a hook into the connection tracking framework of the Linux host. For
the VM-initiated ftp data connection (ftp active mode) we use the <span class="docutils literal">RELATED</span>
state that allows us to detect that the VM-initiated ftp data connection is a
consequence of ( or 'has a relationship with' ) an existing ftp control
connection, thus we want to allow it to let packets pass the firewall. The
<span class="docutils literal">RELATED</span> state, however, is only valid for the very first packet of the
outgoing TCP connection for the ftp data path. Afterwards, the state to compare
against is <span class="docutils literal">ESTABLISHED</span>, which then applies equally to the incoming and
outgoing direction. All this is related to the ftp data traffic originating from
TCP port 20 of the VM. This then leads to the following solution <span class="since">(since
0.8.5 (QEMU, KVM))</span> :</p>
<pre class="literal-block">&lt;filter name='test-eth0'&gt;
  &lt;!-- reference the clean traffic filter to prevent
       MAC, IP and ARP spoofing. By not providing
       and IP address parameter, libvirt will detect the
       IP address the VM is using. --&gt;
  &lt;filterref filter='clean-traffic'/&gt;

  &lt;!-- enable TCP port 21 (ftp-control) to be reachable --&gt;
  &lt;rule action='accept' direction='in'&gt;
    &lt;tcp dstportstart='21'/&gt;
  &lt;/rule&gt;

  &lt;!-- enable TCP port 20 for VM-initiated ftp data connection
       related to an existing ftp control connection --&gt;
  &lt;rule action='accept' direction='out'&gt;
    &lt;tcp srcportstart='20' state='RELATED,ESTABLISHED'/&gt;
  &lt;/rule&gt;

  &lt;!-- accept all packets from client on the ftp data connection --&gt;
  &lt;rule action='accept' direction='in'&gt;
    &lt;tcp dstportstart='20' state='ESTABLISHED'/&gt;
  &lt;/rule&gt;

  &lt;!-- enable TCP ports 22 (ssh) and 80 (http) to be reachable --&gt;
  &lt;rule action='accept' direction='in'&gt;
    &lt;tcp dstportstart='22'/&gt;
  &lt;/rule&gt;

  &lt;rule action='accept' direction='in'&gt;
    &lt;tcp dstportstart='80'/&gt;
  &lt;/rule&gt;

  &lt;!-- enable general ICMP traffic to be initiated by the VM;
       this includes ping traffic --&gt;
  &lt;rule action='accept' direction='out'&gt;
    &lt;icmp/&gt;
  &lt;/rule&gt;

  &lt;!-- enable outgoing DNS lookups using UDP --&gt;
  &lt;rule action='accept' direction='out'&gt;
    &lt;udp dstportstart='53'/&gt;
  &lt;/rule&gt;

  &lt;!-- drop all other traffic --&gt;
  &lt;rule action='drop' direction='inout'&gt;
    &lt;all/&gt;
  &lt;/rule&gt;

&lt;/filter&gt;</pre>
<p>Before trying out a filter using the <span class="docutils literal">RELATED</span> state, you have to make sure
that the appropriate connection tracking module has been loaded into the host's
kernel. Depending on the version of the kernel, you must run either one of the
following two commands before the ftp connection with the VM is established.</p>
<pre class="literal-block">modprobe nf_conntrack_ftp   # where available  or

modprobe ip_conntrack_ftp   # if above is not available</pre>
<p>If other protocols than ftp are to be used in conjunction with the <span class="docutils literal">RELATED</span>
state, their corresponding module must be loaded. Modules exist at least for the
protocols ftp, tftp, irc, sip, sctp, and amanda.</p>
<p>The 2nd solution makes uses the state flags of connections more than the
previous solution did. In this solution we take advantage of the fact that the
<span class="docutils literal">NEW</span> state of a connection is valid when the very first packet of a traffic
flow is seen. Subsequently, if the very first packet of a flow is accepted, the
flow becomes a connection and enters the <span class="docutils literal">ESTABLISHED</span> state. This allows us
to write a general rule for allowing packets of <span class="docutils literal">ESTABLISHED</span> connections to
reach the VM or be sent by the VM. We write specific rules for the very first
packets identified by the <span class="docutils literal">NEW</span> state and for which ports they are acceptable.
All packets for ports that are not explicitly accepted will be dropped and
therefore the connection will not go into the <span class="docutils literal">ESTABLISHED</span> state and any
subsequent packets be dropped.</p>
<pre class="literal-block">&lt;filter name='test-eth0'&gt;
  &lt;!-- reference the clean traffic filter to prevent
       MAC, IP and ARP spoofing. By not providing
       and IP address parameter, libvirt will detect the
       IP address the VM is using. --&gt;
  &lt;filterref filter='clean-traffic'/&gt;

  &lt;!-- let the packets of all previously accepted connections reach the VM --&gt;
  &lt;rule action='accept' direction='in'&gt;
    &lt;all state='ESTABLISHED'/&gt;
  &lt;/rule&gt;

  &lt;!-- let the packets of all previously accepted and related connections be sent from the VM --&gt;
  &lt;rule action='accept' direction='out'&gt;
    &lt;all state='ESTABLISHED,RELATED'/&gt;
  &lt;/rule&gt;

  &lt;!-- enable traffic towards port 21 (ftp), 22 (ssh) and 80 (http) --&gt;
  &lt;rule action='accept' direction='in'&gt;
    &lt;tcp dstportstart='21' dstportend='22' state='NEW'/&gt;
  &lt;/rule&gt;

  &lt;rule action='accept' direction='in'&gt;
    &lt;tcp dstportstart='80' state='NEW'/&gt;
  &lt;/rule&gt;

  &lt;!-- enable general ICMP traffic to be initiated by the VM;
       this includes ping traffic --&gt;
  &lt;rule action='accept' direction='out'&gt;
    &lt;icmp state='NEW'/&gt;
  &lt;/rule&gt;

  &lt;!-- enable outgoing DNS lookups using UDP --&gt;
  &lt;rule action='accept' direction='out'&gt;
    &lt;udp dstportstart='53' state='NEW'/&gt;
  &lt;/rule&gt;

  &lt;!-- drop all other traffic --&gt;
  &lt;rule action='drop' direction='inout'&gt;
    &lt;all/&gt;
  &lt;/rule&gt;

&lt;/filter&gt;</pre>
</div>
</div>
<div class="section" id="limitations">
<h1><a class="toc-backref" href="#id32">Limitations</a><a class="headerlink" href="#limitations" title="Link to this headline">¶</a></h1>
<p>The following sections list (current) limitations of the network filtering
subsystem.</p>
<div class="section" id="vm-migration">
<h2><a class="toc-backref" href="#id33">VM Migration</a><a class="headerlink" href="#vm-migration" title="Link to this headline">¶</a></h2>
<p>VM migration is only supported if the whole filter tree that is referenced by a
virtual machine's top level filter is also available on the target host. The
network filter <em>clean-traffic</em> for example should be available on all libvirt
installations of version 0.8.1 or later and thus enable migration of VMs that
for example reference this filter. All other custom filters must be migrated
using higher layer software. It is outside the scope of libvirt to ensure that
referenced filters on the source system are equivalent to those on the target
system and vice versa.</p>
<p>Migration must occur between libvirt installations of version 0.8.1 or later in
order not to lose the network traffic filters associated with an interface.</p>
</div>
<div class="section" id="vlan-filtering-on-linux">
<h2><a class="toc-backref" href="#id34">VLAN filtering on Linux</a><a class="headerlink" href="#vlan-filtering-on-linux" title="Link to this headline">¶</a></h2>
<p>VLAN (802.1Q) packets, if sent by a virtual machine, cannot be filtered with
rules for protocol IDs <span class="docutils literal">arp</span>, <span class="docutils literal">rarp</span>, <span class="docutils literal">ipv4</span> and <span class="docutils literal">ipv6</span> but only with
protocol IDs <span class="docutils literal">mac</span> and <span class="docutils literal">vlan</span>. Therefore, the example filter
<span class="docutils literal"><span class="pre">clean-traffic</span></span> will not work as expected.</p>
</div>
</div>
</div>
    </div>
    <div id="nav">
      <div id="home">
        <a href="index.html">Home</a>
      </div>
      <div id="jumplinks">
        <ul>
          <li>
            <a href="downloads.html">Download</a>
          </li>
          <li>
            <a href="contribute.html">Contribute</a>
          </li>
          <li>
            <a href="docs.html">Docs</a>
          </li>
        </ul>
      </div>
      <div id="search">
        <form id="simplesearch" action="https://www.google.com/search" enctype="application/x-www-form-urlencoded" method="get">
          <div>
            <input id="searchsite" name="sitesearch" type="hidden" value="libvirt.org"/>
            <input id="searchq" name="q" type="text" size="12" value=""/>
            <input name="submit" type="submit" value="Go"/>
          </div>
        </form>
        <div id="advancedsearch">
          <span>
            <input type="radio" name="what" id="whatwebsite" checked="checked" value="website"/>
            <label for="whatwebsite">Website</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatwiki" value="wiki"/>
            <label for="whatwiki">Wiki</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatdevs" value="devs"/>
            <label for="whatdevs">Developers list</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatusers" value="users"/>
            <label for="whatusers">Users list</label>
          </span>
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="contact">
        <h3>Contact</h3>
        <ul>
          <li>
            <a href="contact.html#mailing-lists">email</a>
          </li>
          <li>
            <a href="contact.html#irc">irc</a>
          </li>
        </ul>
      </div>
      <div id="community">
        <h3>Community</h3>
        <ul>
          <li>
            <a href="https://twitter.com/hashtag/libvirt">twitter</a>
          </li>
          <li>
            <a href="https://stackoverflow.com/questions/tagged/libvirt">stackoverflow</a>
          </li>
          <li>
            <a href="https://serverfault.com/questions/tagged/libvirt">serverfault</a>
          </li>
        </ul>
      </div>
      <div id="contribute">
        <h3>Contribute</h3>
        <ul>
          <li>
            <a href="https://gitlab.com/libvirt/libvirt/-/blob/master/docs/formatnwfilter.rst">edit this page</a>
          </li>
        </ul>
      </div>
      <div id="conduct">
            Participants in the libvirt project agree to abide by <a href="governance.html#code-of-conduct">the project code of conduct</a></div>
      <br class="clear"/>
    </div>
  </body>
</html>
