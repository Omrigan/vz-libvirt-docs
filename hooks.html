<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
        This file is autogenerated from docs/hooks.rst
        Do not edit this file. Changes will be lost.
      -->
  <!--
        This page was generated at Wed Apr 19 07:14:27 2023 UTC.
      -->
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="manifest" href="/manifest.json"/>
    <meta name="theme-color" content="#ffffff"/>
    <title>libvirt: Hooks for specific system management</title>
    <meta name="description" content="libvirt, virtualization, virtualization API"/>
    <script type="text/javascript" src="js/main.js">
      <!--// forces non-empty element-->
    </script>
  </head>
  <body onload="pageload()">
    <div id="body">
      <div class="document" id="hooks-for-specific-system-management">
<h1>Hooks for specific system management</h1>

<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#custom-event-scripts" id="id1">Custom event scripts</a></p></li>
<li><p><a class="reference internal" href="#script-location" id="id2">Script location</a></p></li>
<li><p><a class="reference internal" href="#script-names" id="id3">Script names</a></p></li>
<li><p><a class="reference internal" href="#script-structure" id="id4">Script structure</a></p></li>
<li><p><a class="reference internal" href="#script-arguments" id="id5">Script arguments</a></p>
<ul>
<li><p><a class="reference internal" href="#specifics" id="id6">Specifics</a></p>
<ul>
<li><p><a class="reference internal" href="#etc-libvirt-hooks-daemon" id="id7">/etc/libvirt/hooks/daemon</a></p></li>
<li><p><a class="reference internal" href="#etc-libvirt-hooks-qemu" id="id8">/etc/libvirt/hooks/qemu</a></p></li>
<li><p><a class="reference internal" href="#etc-libvirt-hooks-lxc" id="id9">/etc/libvirt/hooks/lxc</a></p></li>
<li><p><a class="reference internal" href="#etc-libvirt-hooks-libxl" id="id10">/etc/libvirt/hooks/libxl</a></p></li>
<li><p><a class="reference internal" href="#etc-libvirt-hooks-network" id="id11">/etc/libvirt/hooks/network</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#script-execution" id="id12">Script execution</a></p></li>
<li><p><a class="reference internal" href="#qemu-guest-migration" id="id13">QEMU guest migration</a></p></li>
<li><p><a class="reference internal" href="#calling-libvirt-functions-from-within-a-hook-script" id="id14">Calling libvirt functions from within a hook script</a></p></li>
<li><p><a class="reference internal" href="#return-codes-and-logging" id="id15">Return codes and logging</a></p></li>
</ul>
</div>
<div class="section" id="custom-event-scripts">
<h1><a class="toc-backref" href="#id1">Custom event scripts</a><a class="headerlink" href="#custom-event-scripts" title="Link to this headline">¶</a></h1>
<p>Beginning with libvirt 0.8.0, specific events on a host system will trigger
custom scripts.</p>
<p>These custom <strong>hook</strong> scripts are executed when any of the following actions
occur:</p>
<ul class="simple">
<li><p>The libvirt daemon starts, stops, or reloads its configuration (
<span class="since">since 0.8.0</span> )</p></li>
<li><p>A QEMU guest is started or stopped ( <span class="since">since 0.8.0</span> )</p></li>
<li><p>An LXC guest is started or stopped ( <span class="since">since 0.8.0</span> )</p></li>
<li><p>A libxl-handled Xen guest is started or stopped ( <span class="since">since 2.1.0</span> )</p></li>
<li><p>A network is started or stopped or an interface is plugged/unplugged to/from
the network ( <span class="since">since 1.2.2</span> )</p></li>
</ul>
</div>
<div class="section" id="script-location">
<h1><a class="toc-backref" href="#id2">Script location</a><a class="headerlink" href="#script-location" title="Link to this headline">¶</a></h1>
<p>The libvirt hook scripts are located in the directory
<span class="docutils literal">$SYSCONFDIR/libvirt/hooks/</span>.</p>
<ul class="simple">
<li><p>In Linux distributions such as Fedora and RHEL, this is
<span class="docutils literal">/etc/libvirt/hooks/</span>. Other Linux distributions may do this differently.</p></li>
<li><p>If your installation of libvirt has instead been compiled from source, it is
likely to be <span class="docutils literal">/usr/local/etc/libvirt/hooks/</span>.</p></li>
<li><p><span class="since">Since 6.5.0</span> , you can also place several hook scripts in the
directories <span class="docutils literal"><span class="pre">/etc/libvirt/hooks/&lt;driver&gt;.d/</span></span>.</p></li>
</ul>
<p>To use hook scripts, you will need to create this <span class="docutils literal">hooks</span> directory manually,
place the desired hook scripts inside, then make them executable.</p>
</div>
<div class="section" id="script-names">
<h1><a class="toc-backref" href="#id3">Script names</a><a class="headerlink" href="#script-names" title="Link to this headline">¶</a></h1>
<p>At present, there are five hook scripts that can be called:</p>
<ul class="simple">
<li><p><span class="docutils literal">/etc/libvirt/hooks/daemon</span>
Executed when the libvirt daemon is started, stopped, or reloads its
configuration</p></li>
<li><p><span class="docutils literal">/etc/libvirt/hooks/qemu</span>
Executed when a QEMU guest is started, stopped, or migrated</p></li>
<li><p><span class="docutils literal">/etc/libvirt/hooks/lxc</span>
Executed when an LXC guest is started or stopped</p></li>
<li><p><span class="docutils literal">/etc/libvirt/hooks/libxl</span>
Executed when a libxl-handled Xen guest is started, stopped, or migrated</p></li>
<li><p><span class="docutils literal">/etc/libvirt/hooks/network</span>
Executed when a network is started or stopped or an interface is
plugged/unplugged to/from the network</p></li>
</ul>
<p><span class="since">Since 6.5.0</span> , you can also have several scripts with any name in the
directories <span class="docutils literal"><span class="pre">/etc/libvirt/hooks/&lt;driver&gt;.d/</span></span>. They are executed in
alphabetical order after main script.</p>
</div>
<div class="section" id="script-structure">
<h1><a class="toc-backref" href="#id4">Script structure</a><a class="headerlink" href="#script-structure" title="Link to this headline">¶</a></h1>
<p>The hook scripts are executed using standard Linux process creation functions.
Therefore, they must begin with the declaration of the command interpreter to
use.</p>
<p>For example:</p>
<pre class="literal-block">#!/bin/bash</pre>
<p>or:</p>
<pre class="literal-block">#!/usr/bin/python</pre>
<p>Other command interpreters are equally valid, as is any executable binary, so
you are welcome to use your favourite languages.</p>
</div>
<div class="section" id="script-arguments">
<h1><a class="toc-backref" href="#id5">Script arguments</a><a class="headerlink" href="#script-arguments" title="Link to this headline">¶</a></h1>
<p>The hook scripts are called with specific command line arguments, depending upon
the script, and the operation being performed.</p>
<p>The guest hook scripts, qemu and lxc, are also given the <strong>full</strong> XML
description for the domain on their stdin. This includes items such the UUID of
the domain and its storage information, and is intended to provide all the
libvirt information the script needs.</p>
<p>For all cases, stdin of the network hook script is provided with the full XML
description of the network status in the following form:</p>
<pre class="literal-block">&lt;hookData&gt;
  &lt;network&gt;
     &lt;name&gt;$network_name&lt;/name&gt;
     &lt;uuid&gt;afca425a-2c3a-420c-b2fb-dd7b4950d722&lt;/uuid&gt;
     ...
  &lt;/network&gt;
&lt;/hookData&gt;</pre>
<p>In the case of an network port being created / deleted, the network XML will be
followed with the full XML description of the port:</p>
<pre class="literal-block">&lt;hookData&gt;
  &lt;network&gt;
     &lt;name&gt;$network_name&lt;/name&gt;
     &lt;uuid&gt;afca425a-2c3a-420c-b2fb-dd7b4950d722&lt;/uuid&gt;
     ...
  &lt;/network&gt;
  &lt;networkport&gt;
    &lt;uuid&gt;5d744f21-ba4a-4d6e-bdb2-30a35ff3207d&lt;/uuid&gt;
    ...
    &lt;plug type='direct' dev='ens3' mode='vepa'/&gt;
  &lt;/networkport&gt;
&lt;/hookData&gt;</pre>
<p>Please note that this approach is different from other cases such as <span class="docutils literal">daemon</span>,
<span class="docutils literal">qemu</span> or <span class="docutils literal">lxc</span> hook scripts, because two XMLs may be passed here, while in
the other cases only a single XML is passed.</p>
<p>The command line arguments take this approach:</p>
<ol class="arabic simple">
<li><p>The first argument is the name of the <strong>object</strong> involved in the operation,
or '-' if there is none.
For example, the name of a guest being started.</p></li>
<li><p>The second argument is the name of the <strong>operation</strong> being performed.
For example, "start" if a guest is being started.</p></li>
<li><p>The third argument is a <strong>sub-operation</strong> indication, or '-' if there is
none.</p></li>
<li><p>The last argument is an <strong>extra argument</strong> string, or '-' if there is none.</p></li>
</ol>
<div class="section" id="specifics">
<h2><a class="toc-backref" href="#id6">Specifics</a><a class="headerlink" href="#specifics" title="Link to this headline">¶</a></h2>
<p>This translates to the following specifics for each hook script:</p>
<div class="section" id="etc-libvirt-hooks-daemon">
<h3><a class="toc-backref" href="#id7">/etc/libvirt/hooks/daemon</a><a class="headerlink" href="#etc-libvirt-hooks-daemon" title="Link to this headline">¶</a></h3>
<ul>
<li><div class="line-block">
<div class="line">When the libvirt daemon is started, this script is called as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/daemon - start - start</pre>
</li>
<li><div class="line-block">
<div class="line">When the libvirt daemon is shut down, this script is called as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/daemon - shutdown - shutdown</pre>
</li>
<li><div class="line-block">
<div class="line">When the libvirt daemon receives the SIGHUP signal, it reloads its
configuration and triggers the hook script as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/daemon - reload begin SIGHUP</pre>
</li>
</ul>
<p>Please note that when the libvirt daemon is restarted, the <em>daemon</em> hook script
is called once with the "shutdown" operation, and then once with the "start"
operation. There is no specific operation to indicate a "restart" is occurring.</p>
</div>
<div class="section" id="etc-libvirt-hooks-qemu">
<h3><a class="toc-backref" href="#id8">/etc/libvirt/hooks/qemu</a><a class="headerlink" href="#etc-libvirt-hooks-qemu" title="Link to this headline">¶</a></h3>
<ul>
<li><div class="line-block">
<div class="line">Before a QEMU guest is started, the qemu hook script is called in three
locations; if any location fails, the guest is not started. The first
location, <span class="since">since 0.9.0</span> , is before libvirt performs any resource
labeling, and the hook can allocate resources not managed by libvirt such
as DRBD or missing bridges. This is called as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/qemu guest_name prepare begin -</pre>
<div class="line-block">
<div class="line">The second location, available <span class="since">Since 0.8.0</span> , occurs after libvirt
has finished labeling all resources, but has not yet started the guest,
called as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/qemu guest_name start begin -</pre>
<div class="line-block">
<div class="line">The third location, <span class="since">0.9.13</span> , occurs after the QEMU process has
successfully started up:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/qemu guest_name started begin -</pre>
</li>
<li><div class="line-block">
<div class="line">When a QEMU guest is stopped, the qemu hook script is called in two
locations, to match the startup. First, <span class="since">since 0.8.0</span> , the hook is
called before libvirt restores any labels:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/qemu guest_name stopped end -</pre>
<div class="line-block">
<div class="line">Then, after libvirt has released all resources, the hook is called again,
<span class="since">since 0.9.0</span> , to allow any additional resource cleanup:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/qemu guest_name release end -</pre>
</li>
<li><p><span class="since">Since 0.9.11</span> , the qemu hook script is also called at the beginning
of incoming migration. It is called as:</p>
<pre class="literal-block">/etc/libvirt/hooks/qemu guest_name migrate begin -</pre>
<p>with domain XML sent to standard input of the script. In this case, the
script acts as a filter and is supposed to modify the domain XML and print it
out on its standard output. Empty output is identical to copying the input
XML without changing it. In case the script returns failure or the output XML
is not valid, incoming migration will be canceled. This hook may be used,
e.g., to change location of disk images for incoming domains.</p>
</li>
<li><p><span class="since">Since 1.2.9</span> , the qemu hook script is also called when restoring a
saved image either via the API or automatically when restoring a managed save
machine. It is called as:</p>
<pre class="literal-block">/etc/libvirt/hooks/qemu guest_name restore begin -</pre>
<p>with domain XML sent to standard input of the script. In this case, the
script acts as a filter and is supposed to modify the domain XML and print it
out on its standard output. Empty output is identical to copying the input
XML without changing it. In case the script returns failure or the output XML
is not valid, restore of the image will be aborted. This hook may be used,
e.g., to change location of disk images for restored domains.</p>
</li>
<li><p><span class="since">Since 6.5.0</span> , you can also place several hook scripts in the
directory <span class="docutils literal">/etc/libvirt/hooks/qemu.d/</span>. They are executed in alphabetical
order after main script. In this case each script also acts as filter and can
modify the domain XML and print it out on its standard output. This script
output is passed to standard input next script in order. Empty output from
any script is also identical to copying the input XML without changing it. In
case any script returns failure common process will be aborted, but all
scripts from the directory will are executed.</p></li>
<li><p><span class="since">Since 0.9.13</span> , the qemu hook script is also called when the libvirtd
daemon restarts and reconnects to previously running QEMU processes. If the
script fails, the existing QEMU process will be killed off. It is called as:</p>
<pre class="literal-block">/etc/libvirt/hooks/qemu guest_name reconnect begin -</pre>
</li>
<li><p><span class="since">Since 0.9.13</span> , the qemu hook script is also called when the QEMU
driver is told to attach to an externally launched QEMU process. It is called
as:</p>
<pre class="literal-block">/etc/libvirt/hooks/qemu guest_name attach begin -</pre>
</li>
</ul>
</div>
<div class="section" id="etc-libvirt-hooks-lxc">
<h3><a class="toc-backref" href="#id9">/etc/libvirt/hooks/lxc</a><a class="headerlink" href="#etc-libvirt-hooks-lxc" title="Link to this headline">¶</a></h3>
<ul>
<li><div class="line-block">
<div class="line">Before a LXC guest is started, the lxc hook script is called in three
locations; if any location fails, the guest is not started. The first
location, <span class="since">since 0.9.13</span> , is before libvirt performs any resource
labeling, and the hook can allocate resources not managed by libvirt such
as DRBD or missing bridges. This is called as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/lxc guest_name prepare begin -</pre>
<div class="line-block">
<div class="line">The second location, available <span class="since">Since 0.8.0</span> , occurs after libvirt
has finished labeling all resources, but has not yet started the guest,
called as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/lxc guest_name start begin -</pre>
<div class="line-block">
<div class="line">The third location, <span class="since">0.9.13</span> , occurs after the LXC process has
successfully started up:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/lxc guest_name started begin -</pre>
</li>
<li><div class="line-block">
<div class="line">When a LXC guest is stopped, the lxc hook script is called in two
locations, to match the startup. First, <span class="since">since 0.8.0</span> , the hook is
called before libvirt restores any labels:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/lxc guest_name stopped end -</pre>
<div class="line-block">
<div class="line">Then, after libvirt has released all resources, the hook is called again,
<span class="since">since 0.9.0</span> , to allow any additional resource cleanup:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/lxc guest_name release end -</pre>
</li>
<li><p><span class="since">Since 0.9.13</span> , the lxc hook script is also called when the libvirtd
daemon restarts and reconnects to previously running LXC processes. If the
script fails, the existing LXC process will be killed off. It is called as:</p>
<pre class="literal-block">/etc/libvirt/hooks/lxc guest_name reconnect begin -</pre>
</li>
</ul>
</div>
<div class="section" id="etc-libvirt-hooks-libxl">
<h3><a class="toc-backref" href="#id10">/etc/libvirt/hooks/libxl</a><a class="headerlink" href="#etc-libvirt-hooks-libxl" title="Link to this headline">¶</a></h3>
<ul>
<li><div class="line-block">
<div class="line">Before a Xen guest is started using libxl driver, the libxl hook script is
called in three locations; if any location fails, the guest is not started.
The first location, <span class="since">since 2.1.0</span> , is before libvirt performs any
resource labeling, and the hook can allocate resources not managed by
libvirt. This is called as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/libxl guest_name prepare begin -</pre>
<div class="line-block">
<div class="line">The second location, available <span class="since">Since 2.1.0</span> , occurs after libvirt
has finished labeling all resources, but has not yet started the guest,
called as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/libxl guest_name start begin -</pre>
<div class="line-block">
<div class="line">The third location, <span class="since">2.1.0</span> , occurs after the domain has
successfully started up:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/libxl guest_name started begin -</pre>
</li>
<li><div class="line-block">
<div class="line">When a libxl-handled Xen guest is stopped, the libxl hook script is called
in two locations, to match the startup. First, <span class="since">since 2.1.0</span> , the
hook is called before libvirt restores any labels:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/libxl guest_name stopped end -</pre>
<div class="line-block">
<div class="line">Then, after libvirt has released all resources, the hook is called again,
<span class="since">since 2.1.0</span> , to allow any additional resource cleanup:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/libxl guest_name release end -</pre>
</li>
<li><p><span class="since">Since 2.1.0</span> , the libxl hook script is also called at the beginning
of incoming migration. It is called as:</p>
<pre class="literal-block">/etc/libvirt/hooks/libxl guest_name migrate begin -</pre>
<p>with domain XML sent to standard input of the script. In this case, the
script acts as a filter and is supposed to modify the domain XML and print it
out on its standard output. Empty output is identical to copying the input
XML without changing it. In case the script returns failure or the output XML
is not valid, incoming migration will be canceled. This hook may be used,
e.g., to change location of disk images for incoming domains.</p>
</li>
<li><p><span class="since">Since 6.5.0</span> , you can also place several hook scripts in the
directory <span class="docutils literal">/etc/libvirt/hooks/libxl.d/</span>. They are executed in alphabetical
order after main script. In this case each script also acts as filter and can
modify the domain XML and print it out on its standard output. This script
output is passed to standard input next script in order. Empty output from
any script is also identical to copying the input XML without changing it. In
case any script returns failure common process will be aborted, but all
scripts from the directory will are executed.</p></li>
<li><p><span class="since">Since 2.1.0</span> , the libxl hook script is also called when the libvirtd
daemon restarts and reconnects to previously running Xen domains. If the
script fails, the existing Xen domains will be killed off. It is called as:</p>
<pre class="literal-block">/etc/libvirt/hooks/libxl guest_name reconnect begin -</pre>
</li>
</ul>
</div>
<div class="section" id="etc-libvirt-hooks-network">
<h3><a class="toc-backref" href="#id11">/etc/libvirt/hooks/network</a><a class="headerlink" href="#etc-libvirt-hooks-network" title="Link to this headline">¶</a></h3>
<ul>
<li><div class="line-block">
<div class="line"><span class="since">Since 1.2.2</span> , before a network is started, this script is called
as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/network network_name start begin -</pre>
</li>
<li><div class="line-block">
<div class="line">After the network is started, up &amp; running, the script is called as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/network network_name started begin -</pre>
</li>
<li><div class="line-block">
<div class="line">When a network is shut down, this script is called as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/network network_name stopped end -</pre>
</li>
<li><div class="line-block">
<div class="line">Later, when network is started and there's an interface from a domain to be
plugged into the network, the hook script is called as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/network network_name port-created begin -</pre>
<p>Please note, that in this case, the script is passed both network and port
XMLs on its stdin.</p>
</li>
<li><div class="line-block">
<div class="line">When network is updated, the hook script is called as:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/network network_name updated begin -</pre>
</li>
<li><div class="line-block">
<div class="line">When the domain from previous case is shutting down, the interface is
unplugged. This leads to another script invocation:</div>
</div>
<pre class="literal-block">/etc/libvirt/hooks/network network_name port-deleted begin -</pre>
<p>And again, as in previous case, both network and port XMLs are passed onto
script's stdin.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="script-execution">
<h1><a class="toc-backref" href="#id12">Script execution</a><a class="headerlink" href="#script-execution" title="Link to this headline">¶</a></h1>
<ul class="simple">
<li><p>The "start" operation for the guest and network hook scripts, executes
<strong>prior</strong> to the object (guest or network) being created. This allows the
object start operation to be aborted if the script returns indicating
failure.</p></li>
<li><p>The "stopped" operation for the guest and network hook scripts, executes
<strong>after</strong> the object (guest or network) has stopped. If the hook script
indicates failure in its return, the shut down of the object cannot be
aborted because it has already been performed.</p></li>
<li><p>Hook scripts execute in a synchronous fashion. Libvirt waits for them to
return before continuing the given operation.
This is most noticeable with the guest or network start operation, as a
lengthy operation in the hook script can mean an extended wait for the guest
or network to be available to end users.</p></li>
<li><p>For a hook script to be utilised, it must have its execute bit set (e.g.
chmod o+rx <em>qemu</em>), and must be present when the libvirt daemon is started.</p></li>
<li><p>If a hook script is added to a host after the libvirt daemon is already
running, it won't be used until the libvirt daemon next starts.</p></li>
</ul>
</div>
<div class="section" id="qemu-guest-migration">
<h1><a class="toc-backref" href="#id13">QEMU guest migration</a><a class="headerlink" href="#qemu-guest-migration" title="Link to this headline">¶</a></h1>
<p>Migration of a QEMU guest involves running hook scripts on both the source and
destination hosts:</p>
<ol class="arabic simple">
<li><p>At the beginning of the migration, the <em>qemu</em> hook script on the
<strong>destination</strong> host is executed with the "migrate" operation.</p></li>
<li><p>Before QEMU process is spawned, the two operations ("prepare" and "start")
called for domain start are executed on <strong>destination</strong> host.</p></li>
<li><p>If both of these hook script executions exit successfully (exit status 0),
the migration continues. Any other exit code indicates failure, and the
migration is aborted.</p></li>
<li><p>The QEMU guest is then migrated to the destination host.</p></li>
<li><p>Unless an error occurs during the migration process, the <em>qemu</em> hook script
on the <strong>source</strong> host is then executed with the "stopped" and "release"
operations to indicate it is no longer running on this host. Regardless of
the return codes, the migration is not aborted as it has already been
performed.</p></li>
</ol>
</div>
<div class="section" id="calling-libvirt-functions-from-within-a-hook-script">
<h1><a class="toc-backref" href="#id14">Calling libvirt functions from within a hook script</a><a class="headerlink" href="#calling-libvirt-functions-from-within-a-hook-script" title="Link to this headline">¶</a></h1>
<p><strong>DO NOT DO THIS!</strong></p>
<p>A hook script must not call back into libvirt, as the libvirt daemon is already
waiting for the script to exit.</p>
<p>A deadlock is likely to occur.</p>
</div>
<div class="section" id="return-codes-and-logging">
<h1><a class="toc-backref" href="#id15">Return codes and logging</a><a class="headerlink" href="#return-codes-and-logging" title="Link to this headline">¶</a></h1>
<p>If a hook script returns with an exit code of 0, the libvirt daemon regards this
as successful and performs no logging of it.</p>
<p>However, if a hook script returns with a non zero exit code, the libvirt daemon
regards this as a failure, logs its return code, and additionally logs anything
on stderr the hook script returns.</p>
<p>For example, a hook script might use this code to indicate failure, and send a
text string to stderr:</p>
<pre class="literal-block">echo "Could not find required XYZZY" &gt;&amp;2
exit 1</pre>
<p>The resulting entry in the libvirt log will appear as:</p>
<pre class="literal-block">20:02:40.297: error : virHookCall:285 : Hook script execution failed: internal error Child process (LC_ALL=C PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
                       HOME=/root USER=root LOGNAME=root /etc/libvirt/hooks/qemu qemu prepare begin -) unexpected exit status 1: Could not find required XYZZY</pre>
</div>
</div>
    </div>
    <div id="nav">
      <div id="home">
        <a href="index.html">Home</a>
      </div>
      <div id="jumplinks">
        <ul>
          <li>
            <a href="downloads.html">Download</a>
          </li>
          <li>
            <a href="contribute.html">Contribute</a>
          </li>
          <li>
            <a href="docs.html">Docs</a>
          </li>
        </ul>
      </div>
      <div id="search">
        <form id="simplesearch" action="https://www.google.com/search" enctype="application/x-www-form-urlencoded" method="get">
          <div>
            <input id="searchsite" name="sitesearch" type="hidden" value="libvirt.org"/>
            <input id="searchq" name="q" type="text" size="12" value=""/>
            <input name="submit" type="submit" value="Go"/>
          </div>
        </form>
        <div id="advancedsearch">
          <span>
            <input type="radio" name="what" id="whatwebsite" checked="checked" value="website"/>
            <label for="whatwebsite">Website</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatwiki" value="wiki"/>
            <label for="whatwiki">Wiki</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatdevs" value="devs"/>
            <label for="whatdevs">Developers list</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatusers" value="users"/>
            <label for="whatusers">Users list</label>
          </span>
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="contact">
        <h3>Contact</h3>
        <ul>
          <li>
            <a href="contact.html#mailing-lists">email</a>
          </li>
          <li>
            <a href="contact.html#irc">irc</a>
          </li>
        </ul>
      </div>
      <div id="community">
        <h3>Community</h3>
        <ul>
          <li>
            <a href="https://twitter.com/hashtag/libvirt">twitter</a>
          </li>
          <li>
            <a href="https://stackoverflow.com/questions/tagged/libvirt">stackoverflow</a>
          </li>
          <li>
            <a href="https://serverfault.com/questions/tagged/libvirt">serverfault</a>
          </li>
        </ul>
      </div>
      <div id="contribute">
        <h3>Contribute</h3>
        <ul>
          <li>
            <a href="https://gitlab.com/libvirt/libvirt/-/blob/master/docs/hooks.rst">edit this page</a>
          </li>
        </ul>
      </div>
      <div id="conduct">
            Participants in the libvirt project agree to abide by <a href="governance.html#code-of-conduct">the project code of conduct</a></div>
      <br class="clear"/>
    </div>
  </body>
</html>
