<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
        This file is autogenerated from docs/cgroups.rst
        Do not edit this file. Changes will be lost.
      -->
  <!--
        This page was generated at Wed Apr 19 07:14:27 2023 UTC.
      -->
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="manifest" href="/manifest.json"/>
    <meta name="theme-color" content="#ffffff"/>
    <title>libvirt: Control Groups Resource Management</title>
    <meta name="description" content="libvirt, virtualization, virtualization API"/>
    <script type="text/javascript" src="js/main.js">
      <!--// forces non-empty element-->
    </script>
  </head>
  <body onload="pageload()">
    <div id="body">
      <div class="document" id="control-groups-resource-management">
<h1>Control Groups Resource Management</h1>

<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#required-controllers" id="id1">Required controllers</a></p></li>
<li><p><a class="reference internal" href="#current-cgroups-layout" id="id2">Current cgroups layout</a></p>
<ul>
<li><p><a class="reference internal" href="#systemd-cgroups-integration" id="id3">Systemd cgroups integration</a></p>
<ul>
<li><p><a class="reference internal" href="#systemd-scope-naming" id="id4">Systemd scope naming</a></p></li>
<li><p><a class="reference internal" href="#systemd-slice-naming" id="id5">Systemd slice naming</a></p></li>
<li><p><a class="reference internal" href="#systemd-cgroup-layout" id="id6">Systemd cgroup layout</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#non-systemd-cgroups-layout" id="id7">Non-systemd cgroups layout</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#using-custom-partitions" id="id8">Using custom partitions</a></p>
<ul>
<li><p><a class="reference internal" href="#creating-custom-partitions-systemd" id="id9">Creating custom partitions (systemd)</a></p></li>
<li><p><a class="reference internal" href="#creating-custom-partitions-non-systemd" id="id10">Creating custom partitions (non-systemd)</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#resource-management-apis-commands" id="id11">Resource management APIs/commands</a></p>
<ul>
<li><p><a class="reference internal" href="#scheduler-tuning" id="id12">Scheduler tuning</a></p></li>
<li><p><a class="reference internal" href="#block-i-o-tuning" id="id13">Block I/O tuning</a></p></li>
<li><p><a class="reference internal" href="#memory-tuning" id="id14">Memory tuning</a></p></li>
<li><p><a class="reference internal" href="#network-tuning" id="id15">Network tuning</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#legacy-cgroups-layout" id="id16">Legacy cgroups layout</a></p></li>
</ul>
</div>
<p>The QEMU and LXC drivers make use of the Linux "Control Groups" facility for
applying resource management to their virtual machines and containers.</p>
<div class="section" id="required-controllers">
<h1><a class="toc-backref" href="#id1">Required controllers</a><a class="headerlink" href="#required-controllers" title="Link to this headline">¶</a></h1>
<p>The control groups filesystem supports multiple "controllers". By default the
init system (such as systemd) should mount all controllers compiled into the
kernel at <span class="docutils literal"><span class="pre">/sys/fs/cgroup/$CONTROLLER-NAME</span></span>. Libvirt will never attempt to
mount any controllers itself, merely detect where they are mounted.</p>
<p>The QEMU driver is capable of using the <span class="docutils literal">cpuset</span>, <span class="docutils literal">cpu</span>, <span class="docutils literal">cpuacct</span>,
<span class="docutils literal">memory</span>, <span class="docutils literal">blkio</span> and <span class="docutils literal">devices</span> controllers. None of them are compulsory.
If any controller is not mounted, the resource management APIs which use it will
cease to operate. It is possible to explicitly turn off use of a controller,
even when mounted, via the <span class="docutils literal">/etc/libvirt/qemu.conf</span> configuration file.</p>
<p>The LXC driver is capable of using the <span class="docutils literal">cpuset</span>, <span class="docutils literal">cpu</span>, <span class="docutils literal">cpuacct</span>,
<span class="docutils literal">freezer</span>, <span class="docutils literal">memory</span>, <span class="docutils literal">blkio</span> and <span class="docutils literal">devices</span> controllers. The <span class="docutils literal">cpuacct</span>,
<span class="docutils literal">devices</span> and <span class="docutils literal">memory</span> controllers are compulsory. Without them mounted, no
containers can be started. If any of the other controllers are not mounted, the
resource management APIs which use them will cease to operate.</p>
</div>
<div class="section" id="current-cgroups-layout">
<h1><a class="toc-backref" href="#id2">Current cgroups layout</a><a class="headerlink" href="#current-cgroups-layout" title="Link to this headline">¶</a></h1>
<p>As of libvirt 1.0.5 or later, the cgroups layout created by libvirt has been
simplified, in order to facilitate the setup of resource control policies by
administrators / management applications. The new layout is based on the
concepts of "partitions" and "consumers". A "consumer" is a cgroup which holds
the processes for a single virtual machine or container. A "partition" is a
cgroup which does not contain any processes, but can have resource controls
applied. A "partition" will have zero or more child directories which may be
either "consumer" or "partition".</p>
<p>As of libvirt 1.1.1 or later, the cgroups layout will have some slight
differences when running on a host with systemd 205 or later. The overall tree
structure is the same, but there are some differences in the naming conventions
for the cgroup directories. Thus the following docs split in two, one describing
systemd hosts and the other non-systemd hosts.</p>
<div class="section" id="systemd-cgroups-integration">
<h2><a class="toc-backref" href="#id3">Systemd cgroups integration</a><a class="headerlink" href="#systemd-cgroups-integration" title="Link to this headline">¶</a></h2>
<p>On hosts which use systemd, each consumer maps to a systemd scope unit, while
partitions map to a system slice unit.</p>
<div class="section" id="systemd-scope-naming">
<h3><a class="toc-backref" href="#id4">Systemd scope naming</a><a class="headerlink" href="#systemd-scope-naming" title="Link to this headline">¶</a></h3>
<p>The systemd convention is for the scope name of virtual machines / containers to
be of the general format <span class="docutils literal"><span class="pre">machine-$NAME.scope</span></span>. Libvirt forms the <span class="docutils literal">$NAME</span>
part of this by concatenating the driver type with the id and truncated name of
the guest, and then escaping any systemd reserved characters. So for a guest
<span class="docutils literal">demo</span> running under the <span class="docutils literal">lxc</span> driver, we get a <span class="docutils literal">$NAME</span> of
<span class="docutils literal"><span class="pre">lxc-12345-demo</span></span> which when escaped is <span class="docutils literal">lxc\x2d12345\x2ddemo</span>. So the
complete scope name is <span class="docutils literal"><span class="pre">machine-lxc\x2d12345\x2ddemo.scope</span></span>. The scope names
map directly to the cgroup directory names.</p>
</div>
<div class="section" id="systemd-slice-naming">
<h3><a class="toc-backref" href="#id5">Systemd slice naming</a><a class="headerlink" href="#systemd-slice-naming" title="Link to this headline">¶</a></h3>
<p>The systemd convention for slice naming is that a slice should include the name
of all of its parents prepended on its own name. So for a libvirt partition
<span class="docutils literal">/machine/engineering/testing</span>, the slice name will be
<span class="docutils literal"><span class="pre">machine-engineering-testing.slice</span></span>. Again the slice names map directly to the
cgroup directory names. Systemd creates three top level slices by default,
<span class="docutils literal">system.slice</span> <span class="docutils literal">user.slice</span> and <span class="docutils literal">machine.slice</span>. All virtual machines or
containers created by libvirt will be associated with <span class="docutils literal">machine.slice</span> by
default.</p>
</div>
<div class="section" id="systemd-cgroup-layout">
<h3><a class="toc-backref" href="#id6">Systemd cgroup layout</a><a class="headerlink" href="#systemd-cgroup-layout" title="Link to this headline">¶</a></h3>
<p>Given this, a possible systemd cgroups layout involving 3 qemu guests, 3 lxc
containers and 3 custom child slices, would be:</p>
<pre class="literal-block">$ROOT
  |
  +- system.slice
  |   |
  |   +- libvirtd.service
  |
  +- machine.slice
      |
      +- machine-qemu\x2d1\x2dvm1.scope
      |   |
      |   +- libvirt
      |       |
      |       +- emulator
      |       +- vcpu0
      |       +- vcpu1
      |
      +- machine-qemu\x2d2\x2dvm2.scope
      |   |
      |   +- libvirt
      |       |
      |       +- emulator
      |       +- vcpu0
      |       +- vcpu1
      |
      +- machine-qemu\x2d3\x2dvm3.scope
      |   |
      |   +- libvirt
      |       |
      |       +- emulator
      |       +- vcpu0
      |       +- vcpu1
      |
      +- machine-engineering.slice
      |   |
      |   +- machine-engineering-testing.slice
      |   |   |
      |   |   +- machine-lxc\x2d11111\x2dcontainer1.scope
      |   |
      |   +- machine-engineering-production.slice
      |       |
      |       +- machine-lxc\x2d22222\x2dcontainer2.scope
      |
      +- machine-marketing.slice
          |
          +- machine-lxc\x2d33333\x2dcontainer3.scope</pre>
<p>Prior libvirt 7.1.0 the topology doesn't have extra <span class="docutils literal">libvirt</span> directory.</p>
</div>
</div>
<div class="section" id="non-systemd-cgroups-layout">
<h2><a class="toc-backref" href="#id7">Non-systemd cgroups layout</a><a class="headerlink" href="#non-systemd-cgroups-layout" title="Link to this headline">¶</a></h2>
<p>On hosts which do not use systemd, each consumer has a corresponding cgroup
named <span class="docutils literal"><span class="pre">$VMNAME.libvirt-{qemu,lxc}</span></span>. Each consumer is associated with exactly
one partition, which also have a corresponding cgroup usually named
<span class="docutils literal">$PARTNAME.partition</span>. The exceptions to this naming rule is the top level
default partition for virtual machines and containers <span class="docutils literal">/machine</span>.</p>
<p>Given this, a possible non-systemd cgroups layout involving 3 qemu guests, 3 lxc
containers and 2 custom child slices, would be:</p>
<pre class="literal-block">$ROOT
  |
  +- machine
      |
      +- qemu-1-vm1.libvirt-qemu
      |   |
      |   +- emulator
      |   +- vcpu0
      |   +- vcpu1
      |
      +- qeme-2-vm2.libvirt-qemu
      |   |
      |   +- emulator
      |   +- vcpu0
      |   +- vcpu1
      |
      +- qemu-3-vm3.libvirt-qemu
      |   |
      |   +- emulator
      |   +- vcpu0
      |   +- vcpu1
      |
      +- engineering.partition
      |   |
      |   +- testing.partition
      |   |   |
      |   |   +- lxc-11111-container1.libvirt-lxc
      |   |
      |   +- production.partition
      |       |
      |       +- lxc-22222-container2.libvirt-lxc
      |
      +- marketing.partition
          |
          +- lxc-33333-container3.libvirt-lxc</pre>
</div>
</div>
<div class="section" id="using-custom-partitions">
<h1><a class="toc-backref" href="#id8">Using custom partitions</a><a class="headerlink" href="#using-custom-partitions" title="Link to this headline">¶</a></h1>
<p>If there is a need to apply resource constraints to groups of virtual machines
or containers, then the single default partition <span class="docutils literal">/machine</span> may not be
sufficiently flexible. The administrator may wish to sub-divide the default
partition, for example into "testing" and "production" partitions, and then
assign each guest to a specific sub-partition. This is achieved via a small
element addition to the guest domain XML config, just below the main <span class="docutils literal">domain</span>
element</p>
<pre class="literal-block">...
&lt;resource&gt;
  &lt;partition&gt;/machine/production&lt;/partition&gt;
&lt;/resource&gt;
...</pre>
<p>Note that the partition names in the guest XML are using a generic naming
format, not the low level naming convention required by the underlying host OS.
That is, you should not include any of the <span class="docutils literal">.partition</span> or <span class="docutils literal">.slice</span> suffixes
in the XML config. Given a partition name <span class="docutils literal">/machine/production</span>, libvirt will
automatically apply the platform specific translation required to get
<span class="docutils literal">/machine/production.partition</span> (non-systemd) or
<span class="docutils literal"><span class="pre">/machine.slice/machine-production.slice</span></span> (systemd) as the underlying cgroup
name</p>
<p>Libvirt will not auto-create the cgroups directory to back this partition. In
the future, libvirt / virsh will provide APIs / commands to create custom
partitions, but currently this is left as an exercise for the administrator.</p>
<p><strong>Note:</strong> the ability to place guests in custom partitions is only available
with libvirt &gt;= 1.0.5, using the new cgroup layout. The legacy cgroups layout
described later in this document did not support customization per guest.</p>
<div class="section" id="creating-custom-partitions-systemd">
<h2><a class="toc-backref" href="#id9">Creating custom partitions (systemd)</a><a class="headerlink" href="#creating-custom-partitions-systemd" title="Link to this headline">¶</a></h2>
<p>Given the XML config above, the admin on a systemd based host would need to
create a unit file <span class="docutils literal"><span class="pre">/etc/systemd/system/machine-production.slice</span></span></p>
<pre class="literal-block"># cat &gt; /etc/systemd/system/machine-testing.slice &lt;&lt;EOF
[Unit]
Description=VM testing slice
Before=slices.target
Wants=machine.slice
EOF
# systemctl start machine-testing.slice</pre>
</div>
<div class="section" id="creating-custom-partitions-non-systemd">
<h2><a class="toc-backref" href="#id10">Creating custom partitions (non-systemd)</a><a class="headerlink" href="#creating-custom-partitions-non-systemd" title="Link to this headline">¶</a></h2>
<p>Given the XML config above, the admin on a non-systemd based host would need to
create a cgroup named '/machine/production.partition'</p>
<pre class="literal-block"># cd /sys/fs/cgroup
# for i in blkio cpu,cpuacct cpuset devices freezer memory net_cls perf_event
  do
    mkdir $i/machine/production.partition
  done
# for i in cpuset.cpus  cpuset.mems
  do
    cat cpuset/machine/$i &gt; cpuset/machine/production.partition/$i
  done</pre>
</div>
</div>
<div class="section" id="resource-management-apis-commands">
<h1><a class="toc-backref" href="#id11">Resource management APIs/commands</a><a class="headerlink" href="#resource-management-apis-commands" title="Link to this headline">¶</a></h1>
<p>Since libvirt aims to provide an API which is portable across hypervisors, the
concept of cgroups is not exposed directly in the API or XML configuration. It
is considered to be an internal implementation detail. Instead libvirt provides
a set of APIs for applying resource controls, which are then mapped to
corresponding cgroup tunables</p>
<div class="section" id="scheduler-tuning">
<h2><a class="toc-backref" href="#id12">Scheduler tuning</a><a class="headerlink" href="#scheduler-tuning" title="Link to this headline">¶</a></h2>
<p>Parameters from the "cpu" controller are exposed via the <span class="docutils literal">schedinfo</span> command
in virsh.</p>
<pre class="literal-block"># virsh schedinfo demo
Scheduler      : posix
cpu_shares     : 1024
vcpu_period    : 100000
vcpu_quota     : -1
emulator_period: 100000
emulator_quota : -1</pre>
</div>
<div class="section" id="block-i-o-tuning">
<h2><a class="toc-backref" href="#id13">Block I/O tuning</a><a class="headerlink" href="#block-i-o-tuning" title="Link to this headline">¶</a></h2>
<p>Parameters from the "blkio" controller are exposed via the <span class="docutils literal">bkliotune</span> command
in virsh.</p>
<pre class="literal-block"># virsh blkiotune demo
weight         : 500
device_weight  :</pre>
</div>
<div class="section" id="memory-tuning">
<h2><a class="toc-backref" href="#id14">Memory tuning</a><a class="headerlink" href="#memory-tuning" title="Link to this headline">¶</a></h2>
<p>Parameters from the "memory" controller are exposed via the <span class="docutils literal">memtune</span> command
in virsh.</p>
<pre class="literal-block"># virsh memtune demo
hard_limit     : 580192
soft_limit     : unlimited
swap_hard_limit: unlimited</pre>
</div>
<div class="section" id="network-tuning">
<h2><a class="toc-backref" href="#id15">Network tuning</a><a class="headerlink" href="#network-tuning" title="Link to this headline">¶</a></h2>
<p>The <span class="docutils literal">net_cls</span> is not currently used. Instead traffic filter policies are set
directly against individual virtual network interfaces.</p>
</div>
</div>
<div class="section" id="legacy-cgroups-layout">
<h1><a class="toc-backref" href="#id16">Legacy cgroups layout</a><a class="headerlink" href="#legacy-cgroups-layout" title="Link to this headline">¶</a></h1>
<p>Prior to libvirt 1.0.5, the cgroups layout created by libvirt was different from
that described above, and did not allow for administrator customization. Libvirt
used a fixed, 3-level hierarchy <span class="docutils literal"><span class="pre">libvirt/{qemu,lxc}/$VMNAME</span></span> which was rooted
at the point in the hierarchy where libvirtd itself was located. So if libvirtd
was placed at <span class="docutils literal">/system/libvirtd.service</span> by systemd, the groups for each
virtual machine / container would be located at
<span class="docutils literal"><span class="pre">/system/libvirtd.service/libvirt/{qemu,lxc}/$VMNAME</span></span>. In addition to this,
the QEMU drivers further child groups for each vCPU thread and the emulator
thread(s). This leads to a hierarchy that looked like</p>
<pre class="literal-block">$ROOT
  |
  +- system
      |
      +- libvirtd.service
           |
           +- libvirt
               |
               +- qemu
               |   |
               |   +- vm1
               |   |   |
               |   |   +- emulator
               |   |   +- vcpu0
               |   |   +- vcpu1
               |   |
               |   +- vm2
               |   |   |
               |   |   +- emulator
               |   |   +- vcpu0
               |   |   +- vcpu1
               |   |
               |   +- vm3
               |       |
               |       +- emulator
               |       +- vcpu0
               |       +- vcpu1
               |
               +- lxc
                   |
                   +- container1
                   |
                   +- container2
                   |
                   +- container3</pre>
<p>Although current releases are much improved, historically the use of deep
hierarchies has had a significant negative impact on the kernel scalability. The
legacy libvirt cgroups layout highlighted these problems, to the detriment of
the performance of virtual machines and containers.</p>
</div>
</div>
    </div>
    <div id="nav">
      <div id="home">
        <a href="index.html">Home</a>
      </div>
      <div id="jumplinks">
        <ul>
          <li>
            <a href="downloads.html">Download</a>
          </li>
          <li>
            <a href="contribute.html">Contribute</a>
          </li>
          <li>
            <a href="docs.html">Docs</a>
          </li>
        </ul>
      </div>
      <div id="search">
        <form id="simplesearch" action="https://www.google.com/search" enctype="application/x-www-form-urlencoded" method="get">
          <div>
            <input id="searchsite" name="sitesearch" type="hidden" value="libvirt.org"/>
            <input id="searchq" name="q" type="text" size="12" value=""/>
            <input name="submit" type="submit" value="Go"/>
          </div>
        </form>
        <div id="advancedsearch">
          <span>
            <input type="radio" name="what" id="whatwebsite" checked="checked" value="website"/>
            <label for="whatwebsite">Website</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatwiki" value="wiki"/>
            <label for="whatwiki">Wiki</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatdevs" value="devs"/>
            <label for="whatdevs">Developers list</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatusers" value="users"/>
            <label for="whatusers">Users list</label>
          </span>
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="contact">
        <h3>Contact</h3>
        <ul>
          <li>
            <a href="contact.html#mailing-lists">email</a>
          </li>
          <li>
            <a href="contact.html#irc">irc</a>
          </li>
        </ul>
      </div>
      <div id="community">
        <h3>Community</h3>
        <ul>
          <li>
            <a href="https://twitter.com/hashtag/libvirt">twitter</a>
          </li>
          <li>
            <a href="https://stackoverflow.com/questions/tagged/libvirt">stackoverflow</a>
          </li>
          <li>
            <a href="https://serverfault.com/questions/tagged/libvirt">serverfault</a>
          </li>
        </ul>
      </div>
      <div id="contribute">
        <h3>Contribute</h3>
        <ul>
          <li>
            <a href="https://gitlab.com/libvirt/libvirt/-/blob/master/docs/cgroups.rst">edit this page</a>
          </li>
        </ul>
      </div>
      <div id="conduct">
            Participants in the libvirt project agree to abide by <a href="governance.html#code-of-conduct">the project code of conduct</a></div>
      <br class="clear"/>
    </div>
  </body>
</html>
