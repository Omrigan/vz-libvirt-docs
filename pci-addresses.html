<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
        This file is autogenerated from docs/pci-addresses.rst
        Do not edit this file. Changes will be lost.
      -->
  <!--
        This page was generated at Wed Apr 19 07:14:27 2023 UTC.
      -->
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="manifest" href="/manifest.json"/>
    <meta name="theme-color" content="#ffffff"/>
    <title>libvirt: PCI addresses in domain XML and guest OS</title>
    <meta name="description" content="libvirt, virtualization, virtualization API"/>
    <script type="text/javascript" src="js/main.js">
      <!--// forces non-empty element-->
    </script>
  </head>
  <body onload="pageload()">
    <div id="body">
      <div class="document" id="pci-addresses-in-domain-xml-and-guest-os">
<h1>PCI addresses in domain XML and guest OS</h1>

<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#simple-cases" id="id1">Simple cases</a></p></li>
<li><p><a class="reference internal" href="#more-complex-cases" id="id2">More complex cases</a></p>
<ul>
<li><p><a class="reference internal" href="#pcie-expander-bus" id="id3">pcie-expander-bus</a></p></li>
<li><p><a class="reference internal" href="#spapr-pci-host-bridge" id="id4">spapr-pci-host-bridge</a></p></li>
<li><p><a class="reference internal" href="#zpci-addresses" id="id5">zPCI addresses</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#device-assignment" id="id6">Device assignment</a></p></li>
<li><p><a class="reference internal" href="#reserved-addresses" id="id7">Reserved addresses</a></p></li>
</ul>
</div>
<p>Looking at the configuration for a guest, it would be reasonable
to expect that each PCI device would show up in the guest OS with
a PCI address that matches the one present in the corresponding
<span class="docutils literal">&lt;address&gt;</span> element of the domain XML, but that's not guaranteed
to happen and will in fact not be the case in all but the simplest
scenarios.</p>
<div class="section" id="simple-cases">
<h1><a class="toc-backref" href="#id1">Simple cases</a><a class="headerlink" href="#simple-cases" title="Link to this headline">¶</a></h1>
<p>When the PCI topology of the VM is very simple, the PCI addresses
will usually match.</p>
<p>For example, the domain XML snippet</p>
<pre class="literal-block">&lt;controller type='pci' index='0' model='pcie-root'/&gt;
&lt;controller type='pci' index='1' model='pcie-root-port'&gt;
  &lt;model name='pcie-root-port'/&gt;
  &lt;target chassis='1' port='0x8'/&gt;
  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x0'/&gt;
&lt;/controller&gt;
&lt;interface type='network'&gt;
  &lt;source network='default'/&gt;
  &lt;model type='virtio'/&gt;
  &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/&gt;
&lt;/interface&gt;</pre>
<p>will result in the PCI topology</p>
<pre class="literal-block">0000:00:00.0 Host bridge: Intel Corporation 82G33/G31/P35/P31 Express DRAM Controller
0000:00:01.0 PCI bridge: Red Hat, Inc. QEMU PCIe Root port
0000:01:00.0 Ethernet controller: Red Hat, Inc. Virtio network device (rev 01)</pre>
<p>showing up in the guest OS.</p>
<p>The PCI address of the <span class="docutils literal"><span class="pre">virtio-net</span></span> adapter, <span class="docutils literal">0000:01:00.0</span>, is
the same in both cases, so there's no confusion.</p>
</div>
<div class="section" id="more-complex-cases">
<h1><a class="toc-backref" href="#id2">More complex cases</a><a class="headerlink" href="#more-complex-cases" title="Link to this headline">¶</a></h1>
<p>In more complex cases, the PCI address visible in the domain XML will
correlate to the one seen by the guest OS in a less obvious way.</p>
<div class="section" id="pcie-expander-bus">
<h2><a class="toc-backref" href="#id3">pcie-expander-bus</a><a class="headerlink" href="#pcie-expander-bus" title="Link to this headline">¶</a></h2>
<p>This fairly uncommon device, which can be used with <span class="docutils literal">x86_64/q35</span>
guests, will help illustrate one such scenario.</p>
<p>For example, the domain XML snippet</p>
<pre class="literal-block">&lt;controller type='pci' index='0' model='pcie-root'/&gt;
&lt;controller type='pci' index='1' model='pcie-expander-bus'&gt;
  &lt;model name='pxb-pcie'/&gt;
  &lt;target busNr='254'/&gt;
  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x0'/&gt;
&lt;/controller&gt;
&lt;controller type='pci' index='2' model='pcie-root-port'&gt;
  &lt;model name='pcie-root-port'/&gt;
  &lt;target chassis='2' port='0x0'/&gt;
  &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/&gt;
&lt;/controller&gt;
&lt;interface type='network'&gt;
  &lt;source network='default'/&gt;
  &lt;model type='virtio'/&gt;
  &lt;address type='pci' domain='0x0000' bus='0x02' slot='0x00' function='0x0'/&gt;
&lt;/interface&gt;</pre>
<p>will result in the PCI topology</p>
<pre class="literal-block">0000:00:00.0 Host bridge: Intel Corporation 82G33/G31/P35/P31 Express DRAM Controller
0000:00:01.0 Host bridge: Red Hat, Inc. QEMU PCIe Expander bridge
0000:fe:00.0 PCI bridge: Red Hat, Inc. QEMU PCIe Root port
0000:ff:00.0 Ethernet controller: Red Hat, Inc. Virtio network device (rev 01)</pre>
<p>showing up in the guest OS.</p>
<p>This time the addresses don't match: this is because the <span class="docutils literal">busNr</span>
property for the <span class="docutils literal"><span class="pre">pcie-expander-bus</span></span> controller causes it to show
up as bus 254 (<span class="docutils literal">0xfe</span> in hexadecimal) instead of bus 1 as one might
expect based on its <span class="docutils literal">index</span> property.</p>
<p>How can the domain XML shown above work at all, then? Surely the
<span class="docutils literal"><span class="pre">pcie-root-port</span></span> controller and the <span class="docutils literal"><span class="pre">virtio-net</span></span> adapter should
use <span class="docutils literal">bus=0xfe</span> and <span class="docutils literal">bus=0xff</span> respectively for the configuration
to be accepted by libvirt?</p>
<p>As it turns out, that's not the case. The reason for this is that
QEMU, and consequently libvirt, uses the <span class="docutils literal">bus</span> property of a
device's PCI address only to match it with the PCI controller that
has the same <span class="docutils literal">index</span> property, and not to set the actual PCI
address, which is decided by the guest OS.</p>
<p>So, by looking at the XML snippet above, we can see that the
<span class="docutils literal"><span class="pre">virtio-net</span></span> adapter plugs into the <span class="docutils literal"><span class="pre">pcie-root-port</span></span> controller,
which plugs into the <span class="docutils literal"><span class="pre">pcie-expander-bus</span></span> controller, which plugs
into <span class="docutils literal"><span class="pre">pcie-root</span></span>: the guest OS sees the same topology, but assigns
different PCI addresses to some of its component.</p>
<p>The takeaway is that the <em>relationship</em> between controllers are the
very same whether you look at the domain XML or at the guest OS, but
the <em>actual PCI addresses</em> are not guaranteed to match and in fact,
except for the very simplest cases, they usually will not.</p>
</div>
<div class="section" id="spapr-pci-host-bridge">
<h2><a class="toc-backref" href="#id4">spapr-pci-host-bridge</a><a class="headerlink" href="#spapr-pci-host-bridge" title="Link to this headline">¶</a></h2>
<p>This device, which is unique to <span class="docutils literal">ppc64/pseries</span> guests, will help
illustrate another scenario.</p>
<p>For example, the domain XML snippet</p>
<pre class="literal-block">&lt;controller type='pci' index='0' model='pci-root'&gt;
   &lt;model name='spapr-pci-host-bridge'/&gt;
   &lt;target index='0'/&gt;
 &lt;/controller&gt;
 &lt;controller type='pci' index='1' model='pci-root'&gt;
   &lt;model name='spapr-pci-host-bridge'/&gt;
   &lt;target index='1'/&gt;
 &lt;/controller&gt;
 &lt;interface type='network'&gt;
   &lt;source network='default'/&gt;
   &lt;model type='virtio'/&gt;
   &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x01' function='0x0'/&gt;
 &lt;/interface&gt;</pre>
<p>will result in the PCI topology</p>
<pre class="literal-block">0001:00:01.0 Ethernet controller: Red Hat, Inc. Virtio network device</pre>
<p>showing up in the guest OS. Note that the two
<span class="docutils literal"><span class="pre">spapr-pci-host-bridge</span></span> controllers are not listed.</p>
<p>This time, in addition to the bus not matching just like in the
previous example, the interesting part is that the domain doesn't
match either: this is because each <span class="docutils literal"><span class="pre">spapr-pci-host-bridge</span></span>
controller creates a separate PCI domain.</p>
<p>Once again, while the PCI addresses seen in the domain XML and those
seen by the guest OS do not match, the relationships between the
various devices are preserved.</p>
</div>
<div class="section" id="zpci-addresses">
<h2><a class="toc-backref" href="#id5">zPCI addresses</a><a class="headerlink" href="#zpci-addresses" title="Link to this headline">¶</a></h2>
<p>For s390x machines, PCI addresses are handled yet differently. No
topology information is relayed in the PCI addresses; instead, the
<span class="docutils literal">fid</span> and <span class="docutils literal">uid</span> elements of the <span class="docutils literal">zpci</span> device convey information.
In the simplest case, the following XML snippet</p>
<pre class="literal-block">&lt;controller type='pci' index='0' model='pci-root'/&gt;
&lt;controller type='pci' index='1' model='pci-bridge'&gt;
  &lt;model name='pci-bridge'/&gt;
  &lt;target chassisNr='1'/&gt;
  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x0'&gt;
    &lt;zpci uid='0x0001' fid='0x00000000'/&gt;
  &lt;/address&gt;
&lt;/controller&gt;
&lt;interface type='bridge'&gt;
  &lt;source bridge='virbr0'/&gt;
  &lt;model type='virtio'/&gt;
  &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x01' function='0x0'&gt;
    &lt;zpci uid='0x0007' fid='0x00000003'/&gt;
  &lt;/address&gt;
&lt;/interface&gt;</pre>
<p>will result in the following in a Linux guest:</p>
<pre class="literal-block">0007:00:00.0 Ethernet controller: Red Hat, Inc. Virtio network device</pre>
<p>Note that the PCI bridge is not visible in the guest; s390x always has a flat
topology. The PCI address in the guest is generated from the information
provided via the <span class="docutils literal">zpci</span> element: more specifically, <span class="docutils literal">uid</span> is used as the
PCI domain. <span class="docutils literal">fid</span> doesn't appear in the PCI address itself, but it will be
used in sysfs (<span class="docutils literal"><span class="pre">/sys/bus/pci/slots/$fid/...</span></span>).</p>
<p>Any changes in the PCI address are not visible in the guest; replacing the PCI
address for the <span class="docutils literal"><span class="pre">virtio-net</span></span> device with</p>
<pre class="literal-block">&lt;address type='pci' domain='0x0000' bus='0x01' slot='0x06' function='0x4'&gt;</pre>
<p>will result in the exactly same view in the guest, as the <span class="docutils literal">fid</span> and <span class="docutils literal">uid</span>
values in the <span class="docutils literal">zpci</span> element remain unchanged.</p>
</div>
</div>
<div class="section" id="device-assignment">
<h1><a class="toc-backref" href="#id6">Device assignment</a><a class="headerlink" href="#device-assignment" title="Link to this headline">¶</a></h1>
<p>When using VFIO to assign host devices to a guest, an additional
caveat to keep in mind that the guest OS will base its decisions upon
the <em>target address</em> (guest side) rather than the <em>source address</em>
(host side).</p>
<p>For example, the domain XML snippet</p>
<pre class="literal-block">&lt;hostdev mode='subsystem' type='pci' managed='yes'&gt;
  &lt;driver name='vfio'/&gt;
  &lt;source&gt;
    &lt;address domain='0x0001' bus='0x08' slot='0x00' function='0x0'/&gt;
  &lt;/source&gt;
  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x0'/&gt;
&lt;/hostdev&gt;</pre>
<p>will result in the device showing up as <span class="docutils literal">0000:00:01.0</span> in the
guest OS rather than as <span class="docutils literal">0001:08:00.1</span>, which is the address of the
device on the host.</p>
<p>Of course, all the rules and behaviors described above still apply.</p>
</div>
<div class="section" id="reserved-addresses">
<h1><a class="toc-backref" href="#id7">Reserved addresses</a><a class="headerlink" href="#reserved-addresses" title="Link to this headline">¶</a></h1>
<p>Due to some historical reasons hypervisors might expect some PCI
devices to appear at certain addresses instead of 'random' ones.
For QEMU this is machine type and guest architecture dependent.
But to give you at least a gist here is list of reserved PCI
addresses:</p>
<p>For the x86_64 architecture's <span class="docutils literal">I440FX</span>-based machine types the following
devices are hard coded into QEMU and can't be moved or eliminated:</p>
<table>
<colgroup>
<col style="width: 21%"/>
<col style="width: 79%"/>
</colgroup>
<tbody>
<tr><td><p>0000:00:00.0</p></td>
<td><p>Host bridge</p></td>
</tr>
<tr><td><p>0000:00:01.0</p></td>
<td><p>ISA bridge</p></td>
</tr>
<tr><td><p>0000:00:01.1</p></td>
<td><p>primary IDE controller</p></td>
</tr>
<tr><td><p>0000:00:01.2</p></td>
<td><p>PIIX3 USB controller</p></td>
</tr>
<tr><td><p>0000:00:01.3</p></td>
<td><p>ACPI (power management) and SMBus controller</p></td>
</tr>
</tbody>
</table>
<p>The following addresses will be used as default ones for the corresponding
devices (if the address is free or a different address wasn't provided for the
device). It is okay to use this address for any other device.</p>
<table>
<colgroup>
<col style="width: 40%"/>
<col style="width: 60%"/>
</colgroup>
<tbody>
<tr><td><p>0000:00:02.0</p></td>
<td><p>primary video card</p></td>
</tr>
</tbody>
</table>
<p>For the x86_64 architecture's <span class="docutils literal">Q35</span>-based machine types the following
devices are hard coded into QEMU and can't be moved or eliminated:</p>
<table>
<colgroup>
<col style="width: 34%"/>
<col style="width: 66%"/>
</colgroup>
<tbody>
<tr><td><p>0000:00:00.0</p></td>
<td><p>Host bridge</p></td>
</tr>
<tr><td><p>0000:00:1f.2</p></td>
<td><p>primary SATA controller</p></td>
</tr>
<tr><td><p>0000:00:1f.0</p></td>
<td><p>ISA bridge</p></td>
</tr>
<tr><td><p>0000:00:1f.3</p></td>
<td><p>SMBus</p></td>
</tr>
</tbody>
</table>
<p>The following addresses will be used as default ones for the corresponding
devices (if the address is free or a different address wasn't provided for the
device) because that's how real <span class="docutils literal">Q35</span> would do it:</p>
<table>
<colgroup>
<col style="width: 44%"/>
<col style="width: 56%"/>
</colgroup>
<tbody>
<tr><td><p>0000:00:1a.0</p></td>
<td><p>USB2 controller</p></td>
</tr>
<tr><td><p>0000:00:1b.0</p></td>
<td><p>ICH9 sound chip</p></td>
</tr>
<tr><td><p>0000:00:1d.0</p></td>
<td><p>USB2 controller</p></td>
</tr>
</tbody>
</table>
</div>
</div>
    </div>
    <div id="nav">
      <div id="home">
        <a href="index.html">Home</a>
      </div>
      <div id="jumplinks">
        <ul>
          <li>
            <a href="downloads.html">Download</a>
          </li>
          <li>
            <a href="contribute.html">Contribute</a>
          </li>
          <li>
            <a href="docs.html">Docs</a>
          </li>
        </ul>
      </div>
      <div id="search">
        <form id="simplesearch" action="https://www.google.com/search" enctype="application/x-www-form-urlencoded" method="get">
          <div>
            <input id="searchsite" name="sitesearch" type="hidden" value="libvirt.org"/>
            <input id="searchq" name="q" type="text" size="12" value=""/>
            <input name="submit" type="submit" value="Go"/>
          </div>
        </form>
        <div id="advancedsearch">
          <span>
            <input type="radio" name="what" id="whatwebsite" checked="checked" value="website"/>
            <label for="whatwebsite">Website</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatwiki" value="wiki"/>
            <label for="whatwiki">Wiki</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatdevs" value="devs"/>
            <label for="whatdevs">Developers list</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatusers" value="users"/>
            <label for="whatusers">Users list</label>
          </span>
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="contact">
        <h3>Contact</h3>
        <ul>
          <li>
            <a href="contact.html#mailing-lists">email</a>
          </li>
          <li>
            <a href="contact.html#irc">irc</a>
          </li>
        </ul>
      </div>
      <div id="community">
        <h3>Community</h3>
        <ul>
          <li>
            <a href="https://twitter.com/hashtag/libvirt">twitter</a>
          </li>
          <li>
            <a href="https://stackoverflow.com/questions/tagged/libvirt">stackoverflow</a>
          </li>
          <li>
            <a href="https://serverfault.com/questions/tagged/libvirt">serverfault</a>
          </li>
        </ul>
      </div>
      <div id="contribute">
        <h3>Contribute</h3>
        <ul>
          <li>
            <a href="https://gitlab.com/libvirt/libvirt/-/blob/master/docs/pci-addresses.rst">edit this page</a>
          </li>
        </ul>
      </div>
      <div id="conduct">
            Participants in the libvirt project agree to abide by <a href="governance.html#code-of-conduct">the project code of conduct</a></div>
      <br class="clear"/>
    </div>
  </body>
</html>
