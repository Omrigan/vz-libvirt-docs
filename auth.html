<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
        This file is autogenerated from docs/auth.rst
        Do not edit this file. Changes will be lost.
      -->
  <!--
        This page was generated at Wed Apr 19 07:14:27 2023 UTC.
      -->
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="manifest" href="/manifest.json"/>
    <meta name="theme-color" content="#ffffff"/>
    <title>libvirt: Connection authentication</title>
    <meta name="description" content="libvirt, virtualization, virtualization API"/>
    <script type="text/javascript" src="js/main.js">
      <!--// forces non-empty element-->
    </script>
  </head>
  <body onload="pageload()">
    <div id="body">
      <div class="document" id="connection-authentication">
<h1>Connection authentication</h1>

<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#client-configuration" id="id1">Client configuration</a></p></li>
<li><p><a class="reference internal" href="#server-configuration" id="id2">Server configuration</a></p>
<ul>
<li><p><a class="reference internal" href="#unix-socket-permissions-group" id="id3">UNIX socket permissions/group</a></p></li>
<li><p><a class="reference internal" href="#unix-socket-policykit-auth" id="id4">UNIX socket PolicyKit auth</a></p></li>
<li><p><a class="reference internal" href="#sasl-pluggable-authentication" id="id5">SASL pluggable authentication</a></p>
<ul>
<li><p><a class="reference internal" href="#username-password-auth" id="id6">Username/password auth</a></p></li>
<li><p><a class="reference internal" href="#gssapi-kerberos-auth" id="id7">GSSAPI/Kerberos auth</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>When connecting to libvirt, some connections may require client
authentication before allowing use of the APIs. The set of possible
authentication mechanisms is administrator controlled, independent
of applications using libvirt. Once authenticated, libvirt can apply
fine grained <a class="reference external" href="acl.html">access control</a> to the operations
performed by a client.</p>
<div class="section" id="client-configuration">
<h1><a class="toc-backref" href="#id1">Client configuration</a><a class="headerlink" href="#client-configuration" title="Link to this headline">¶</a></h1>
<p>When connecting to a remote hypervisor which requires authentication,
most libvirt applications will prompt the user for the credentials. It is
also possible to provide a client configuration file containing all the
authentication credentials, avoiding any interaction. Libvirt will look
for the authentication file using the following sequence:</p>
<ul class="simple">
<li><p>The file path specified by the <span class="docutils literal">$LIBVIRT_AUTH_FILE</span> environment
variable.</p></li>
<li><p>The file path specified by the <span class="docutils literal"><span class="pre">authfile=/some/file</span></span> URI
query parameter</p></li>
<li><p>The file <span class="docutils literal">$XDG_CONFIG_HOME/libvirt/auth.conf</span></p></li>
<li><p>The file <span class="docutils literal">/etc/libvirt/auth.conf</span></p></li>
</ul>
<p>The auth configuration file uses the traditional <span class="docutils literal">.ini</span>
style syntax. There are two types of groups that can be present in
the config. First there are one or more <span class="docutils literal">credential</span>
sets, which provide the actual authentication credentials. The keys
within the group may be:</p>
<ul class="simple">
<li><p><span class="docutils literal">username</span>: the user login name to act as. This
is relevant for ESX, Xen, HyperV and SSH, but probably not
the one you want for libvirtd with SASL.</p></li>
<li><p><span class="docutils literal">authname</span>: the name to authorize as. This is
what is commonly required for libvirtd with SASL.</p></li>
<li><p><span class="docutils literal">password</span>: the secret password.</p></li>
<li><p><span class="docutils literal">realm</span>: the domain realm for SASL, mostly unused.</p></li>
</ul>
<p>Each set of credentials has a name, which is part of the group
entry name. Overall the syntax is</p>
<pre class="literal-block">[credentials-$NAME]
credname1=value1
credname2=value2</pre>
<p>For example, to define two sets of credentials used for production
and test machines, using libvirtd, and a further ESX server for
development:</p>
<pre class="literal-block">[credentials-test]
authname=fred
password=123456

[credentials-prod]
authname=bar
password=letmein

[credentials-dev]
username=joe
password=hello

[credentials-defgrp]
username=defuser
password=defpw</pre>
<p>The second set of groups provide mappings of credentials to
specific machine services. The config file group names compromise
the service type and host:</p>
<pre class="literal-block">[auth-$SERVICE-$HOSTNAME]
credentials=$CREDENTIALS</pre>
<p>For example, following the previous example, here is how to
map some machines. For convenience libvirt supports a default
mapping of credentials to machines:</p>
<pre class="literal-block">[auth-libvirt-test1.example.com]
credentials=test

[auth-libvirt-test2.example.com]
credentials=test

[auth-libvirt-demo3.example.com]
credentials=test

[auth-libvirt-prod1.example.com]
credentials=prod

[auth-libvirt-default]
credentials=defgrp

[auth-esx-dev1.example.com]
credentials=dev

[auth-esx-default]
credentials=defgrp</pre>
<p>The following service types are known to libvirt:</p>
<ul class="simple">
<li><p><span class="docutils literal">esx</span> - used for connections to an ESX or VirtualCenter server</p></li>
<li><p><span class="docutils literal">hyperv</span> - used for connections to an HyperV server</p></li>
<li><p><span class="docutils literal">libvirt</span> - used for connections to a libvirtd
server, which is configured with SASL auth</p></li>
<li><p><span class="docutils literal">ssh</span> - used for connections to a remote QEMU driver over SSH</p></li>
</ul>
<p>Applications using libvirt are free to use this same configuration
file for storing other credentials. For example, it can be used
to storage VNC or SPICE login credentials</p>
</div>
<div class="section" id="server-configuration">
<h1><a class="toc-backref" href="#id2">Server configuration</a><a class="headerlink" href="#server-configuration" title="Link to this headline">¶</a></h1>
<p>The libvirt daemon allows the administrator to choose the authentication
mechanisms used for client connections on each network socket independently.
This is primarily controlled via the libvirt daemon master config file in
<span class="docutils literal">/etc/libvirt/libvirtd.conf</span>. Each of the libvirt sockets can
have its authentication mechanism configured independently. There is
currently a choice of <span class="docutils literal">none</span>, <span class="docutils literal">polkit</span>, and <span class="docutils literal">sasl</span>.
The SASL scheme can be further configured to choose between a large
number of different mechanisms.</p>
<div class="section" id="unix-socket-permissions-group">
<h2><a class="toc-backref" href="#id3">UNIX socket permissions/group</a><a class="headerlink" href="#unix-socket-permissions-group" title="Link to this headline">¶</a></h2>
<p>If libvirt does not contain support for PolicyKit, then access control for
the UNIX domain socket is done using traditional file user/group ownership
and permissions. There are 2 sockets, one for full read-write access, the
other for read-only access. The RW socket will be restricted (mode 0700) to
only allow the <span class="docutils literal">root</span> user to connect. The read-only socket will
be open access (mode 0777) to allow any user to connect.</p>
<p>To allow non-root users greater access, the <span class="docutils literal">libvirtd.conf</span> file
can be edited to change the permissions via the <span class="docutils literal">unix_sock_rw_perms</span>,
config parameter and to set a user group via the <span class="docutils literal">unix_sock_group</span>
parameter. For example, setting the former to mode <span class="docutils literal">0770</span> and the
latter <span class="docutils literal">wheel</span> would let any user in the wheel group connect to
the libvirt daemon.</p>
</div>
<div class="section" id="unix-socket-policykit-auth">
<h2><a class="toc-backref" href="#id4">UNIX socket PolicyKit auth</a><a class="headerlink" href="#unix-socket-policykit-auth" title="Link to this headline">¶</a></h2>
<p>If libvirt contains support for PolicyKit, then access control options are
more advanced. The <span class="docutils literal">auth_unix_rw</span> parameter will default to
<span class="docutils literal">polkit</span>, and the file permissions will default to <span class="docutils literal">0777</span>
even on the RW socket. Upon connecting to the socket, the client application
will be required to identify itself with PolicyKit. The default policy for the
RW daemon socket will require any application running in the current desktop
session to authenticate using the user's password. This is akin to <span class="docutils literal">sudo</span>
auth, but does not require that the client application ultimately run as root.
Default policy will still allow any application to connect to the RO socket.</p>
<p>The default policy can be overridden by creating a new policy file in the
<span class="docutils literal"><span class="pre">/etc/polkit-1/rules.d</span></span> directory. Information on the options
available can be found by reading the <span class="docutils literal">polkit(8)</span> man page. The
two libvirt actions are named <span class="docutils literal">org.libvirt.unix.manage</span> for full
management access, and <span class="docutils literal">org.libvirt.unix.monitor</span> for read-only
access.</p>
<p>As an example, creating <span class="docutils literal"><span class="pre">/etc/polkit-1/rules.d/80-libvirt-manage.rules</span></span>
with the following gives the user <span class="docutils literal">fred</span> full management access
when accessing from an active local session:</p>
<pre class="literal-block">polkit.addRule(function(action, subject) {
  if (action.id == "org.libvirt.unix.manage" &amp;&amp;
      subject.local &amp;&amp; subject.active &amp;&amp; subject.user == "fred") {
    return polkit.Result.YES;
  }
});</pre>
<p>Older versions of PolicyKit used policy files ending with .pkla in the
local override directory <span class="docutils literal"><span class="pre">/etc/polkit-1/localauthority/50-local.d/</span></span>.
Compatibility with this older format is provided by
<a class="reference external" href="https://pagure.io/polkit-pkla-compat">polkit-pkla-compat</a>. As an
example, this gives the user <span class="docutils literal">fred</span> full management access:</p>
<pre class="literal-block">[Allow fred libvirt management permissions]
Identity=unix-user:fred
Action=org.libvirt.unix.manage
ResultAny=yes
ResultInactive=yes
ResultActive=yes</pre>
</div>
<div class="section" id="sasl-pluggable-authentication">
<h2><a class="toc-backref" href="#id5">SASL pluggable authentication</a><a class="headerlink" href="#sasl-pluggable-authentication" title="Link to this headline">¶</a></h2>
<p>Libvirt integrates with the <span class="docutils literal"><span class="pre">cyrus-sasl</span></span> library to provide a pluggable
authentication system using the SASL protocol. SASL can be used in combination
with libvirtd's TLS or TCP socket listeners. When used with the TCP listener,
the SASL mechanism is required to provide session encryption in addition to
authentication. Only a very few SASL mechanisms are able to do this, and of
those that can do it, only the <span class="docutils literal">GSSAPI</span> plugin is considered acceptably secure
by modern standards. <span class="docutils literal">GSSAPI</span> is the default mechanism enabled in the libvirt
SASL configuration. It uses the Kerberos v5 authentication protocol underneath,
and assuming the Kerberos client/server are configured with modern ciphers
(AES), it provides strong session encryption capabilities. All other SASL
mechanisms should only be used with the libvirtd TLS or UNIX socket listeners.</p>
<div class="section" id="username-password-auth">
<h3><a class="toc-backref" href="#id6">Username/password auth</a><a class="headerlink" href="#username-password-auth" title="Link to this headline">¶</a></h3>
<p>To provide a simple username/password auth scheme on the libvirt UNIX socket
or TLS listeners, however, it is possible to use the <span class="docutils literal">SCRAM</span> mechanism, in its
<span class="docutils literal"><span class="pre">SCRAM-SHA-256</span></span> variant. The <span class="docutils literal">auth_unix_ro</span>, <span class="docutils literal">auth_unix_rw</span>, <span class="docutils literal">auth_tls</span>
config params in <span class="docutils literal">libvirtd.conf</span> can be used to turn on SASL auth in these
listeners.</p>
<p>Since the libvirt SASL config file defaults to using <span class="docutils literal">GSSAPI</span> (Kerberos), a
config change is required to enable plain password auth. This is done by
editing <span class="docutils literal">/etc/sasl2/libvirt.conf</span> to set the <span class="docutils literal">mech_list</span>
parameter to <span class="docutils literal"><span class="pre">scram-sha-256</span></span>.</p>
<p><strong>Note:</strong> previous versions of libvirt suggested <span class="docutils literal"><span class="pre">DIGEST-MD5</span></span> and
<span class="docutils literal"><span class="pre">SCRAM-SHA-1</span></span> mechanisms. <strong>Use of these is strongly discouraged as they are
not considered secure by modern standards.</strong> It is possible to replace them with
use of <span class="docutils literal"><span class="pre">SCRAM-SHA-256</span></span>, while still using the same password database.</p>
<p>Out of the box, no user accounts are defined, so no clients will be able to
authenticate on the TCP socket. Adding users and setting their passwords is
done with the <span class="docutils literal">saslpasswd2</span> command. When running this command it is
important to tell it that the appname is <span class="docutils literal">libvirt</span>. As an example, to add
a user <span class="docutils literal">fred</span>, run</p>
<pre class="literal-block"># saslpasswd2 -a libvirt fred
Password: xxxxxx
Again (for verification): xxxxxx</pre>
<p>To see a list of all accounts the <span class="docutils literal">sasldblistusers2</span> command can be used.
This command expects to be given the path to the libvirt user database, which
is kept in <span class="docutils literal">/etc/libvirt/passwd.db</span></p>
<pre class="literal-block"># sasldblistusers2 -f /etc/libvirt/passwd.db
fred@t60wlan.home.berrange.com: userPassword</pre>
<p>Finally, to disable a user's access, the <span class="docutils literal">saslpasswd2</span> command can be used
again:</p>
<pre class="literal-block"># saslpasswd2 -a libvirt -d fred</pre>
<p><strong>Note: the SASL ``passwd.db`` file stores passwords in clear text, so
care should be taken not to let its contents be disclosed to unauthorized
users.</strong></p>
</div>
<div class="section" id="gssapi-kerberos-auth">
<h3><a class="toc-backref" href="#id7">GSSAPI/Kerberos auth</a><a class="headerlink" href="#gssapi-kerberos-auth" title="Link to this headline">¶</a></h3>
<p>The plain TCP listener of the libvirt daemon defaults to using SASL for
authentication. The libvirt SASL config also defaults to <span class="docutils literal">GSSAPI</span>, so there
is no need to edit the SASL config when using <span class="docutils literal">GSSAPI</span>. If the libvirtd TLS
or UNIX listeners are used, then the Kerberos session encryption will be
disabled since it is not required in these scenarios - only the plain TCP
listener needs encryption.</p>
<p>Some operating systems do not install the SASL kerberos plugin by default. It
may be necessary to install a sub-package such as <span class="docutils literal"><span class="pre">cyrus-sasl-gssapi</span></span>.
To check whether the Kerberos plugin is installed run the <span class="docutils literal">pluginviewer</span>
program and verify that <span class="docutils literal">gssapi</span> is listed, e.g.:</p>
<pre class="literal-block"># pluginviewer
...snip...
Plugin "gssapiv2" [loaded],     API version: 4
SASL mechanism: GSSAPI, best SSF: 56
security flags: NO_ANONYMOUS|NO_PLAINTEXT|NO_ACTIVE|PASS_CREDENTIALS|MUTUAL_AUTH
features: WANT_CLIENT_FIRST|PROXY_AUTHENTICATION|NEED_SERVER_FQDN</pre>
<p>Next it is necessary for the administrator of the Kerberos realm to
issue a principal for the libvirt server. There needs to be one
principal per host running the libvirt daemon. The principal should be
named <span class="docutils literal">libvirt/full.hostname@KERBEROS.REALM</span>.  This is
typically done by running the <span class="docutils literal">kadmin.local</span> command on the
Kerberos server, though some Kerberos servers have alternate ways of
setting up service principals.  Once created, the principal should be
exported to a keytab, copied to the host running the libvirt daemon
and placed in <span class="docutils literal">/etc/libvirt/krb5.tab</span></p>
<pre class="literal-block"># kadmin.local
kadmin.local: add_principal libvirt/foo.example.com
Enter password for principal "libvirt/foo.example.com@EXAMPLE.COM":
Re-enter password for principal "libvirt/foo.example.com@EXAMPLE.COM":
Principal "libvirt/foo.example.com@EXAMPLE.COM" created.

kadmin.local:  ktadd -k /root/libvirt-foo-example.tab libvirt/foo.example.com@EXAMPLE.COM
Entry for principal libvirt/foo.example.com@EXAMPLE.COM with kvno 4, encryption type Triple DES cbc mode with HMAC/sha1 added to keytab WRFILE:/root/libvirt-foo-example.tab.
Entry for principal libvirt/foo.example.com@EXAMPLE.COM with kvno 4, encryption type ArcFour with HMAC/md5 added to keytab WRFILE:/root/libvirt-foo-example.tab.
Entry for principal libvirt/foo.example.com@EXAMPLE.COM with kvno 4, encryption type DES with HMAC/sha1 added to keytab WRFILE:/root/libvirt-foo-example.tab.
Entry for principal libvirt/foo.example.com@EXAMPLE.COM with kvno 4, encryption type DES cbc mode with RSA-MD5 added to keytab WRFILE:/root/libvirt-foo-example.tab.

kadmin.local: quit

# scp /root/libvirt-foo-example.tab root@foo.example.com:/etc/libvirt/krb5.tab
# rm /root/libvirt-foo-example.tab</pre>
<p>Any client application wishing to connect to a Kerberos enabled libvirt server
merely needs to run <span class="docutils literal">kinit</span> to gain a user principal. This may well
be done automatically when a user logs into a desktop session, if PAM is set up
to authenticate against Kerberos.</p>
</div>
</div>
</div>
</div>
    </div>
    <div id="nav">
      <div id="home">
        <a href="index.html">Home</a>
      </div>
      <div id="jumplinks">
        <ul>
          <li>
            <a href="downloads.html">Download</a>
          </li>
          <li>
            <a href="contribute.html">Contribute</a>
          </li>
          <li>
            <a href="docs.html">Docs</a>
          </li>
        </ul>
      </div>
      <div id="search">
        <form id="simplesearch" action="https://www.google.com/search" enctype="application/x-www-form-urlencoded" method="get">
          <div>
            <input id="searchsite" name="sitesearch" type="hidden" value="libvirt.org"/>
            <input id="searchq" name="q" type="text" size="12" value=""/>
            <input name="submit" type="submit" value="Go"/>
          </div>
        </form>
        <div id="advancedsearch">
          <span>
            <input type="radio" name="what" id="whatwebsite" checked="checked" value="website"/>
            <label for="whatwebsite">Website</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatwiki" value="wiki"/>
            <label for="whatwiki">Wiki</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatdevs" value="devs"/>
            <label for="whatdevs">Developers list</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatusers" value="users"/>
            <label for="whatusers">Users list</label>
          </span>
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="contact">
        <h3>Contact</h3>
        <ul>
          <li>
            <a href="contact.html#mailing-lists">email</a>
          </li>
          <li>
            <a href="contact.html#irc">irc</a>
          </li>
        </ul>
      </div>
      <div id="community">
        <h3>Community</h3>
        <ul>
          <li>
            <a href="https://twitter.com/hashtag/libvirt">twitter</a>
          </li>
          <li>
            <a href="https://stackoverflow.com/questions/tagged/libvirt">stackoverflow</a>
          </li>
          <li>
            <a href="https://serverfault.com/questions/tagged/libvirt">serverfault</a>
          </li>
        </ul>
      </div>
      <div id="contribute">
        <h3>Contribute</h3>
        <ul>
          <li>
            <a href="https://gitlab.com/libvirt/libvirt/-/blob/master/docs/auth.rst">edit this page</a>
          </li>
        </ul>
      </div>
      <div id="conduct">
            Participants in the libvirt project agree to abide by <a href="governance.html#code-of-conduct">the project code of conduct</a></div>
      <br class="clear"/>
    </div>
  </body>
</html>
