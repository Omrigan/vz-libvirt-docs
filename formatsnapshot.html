<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
        This file is autogenerated from docs/formatsnapshot.rst
        Do not edit this file. Changes will be lost.
      -->
  <!--
        This page was generated at Wed Apr 19 07:14:27 2023 UTC.
      -->
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="manifest" href="/manifest.json"/>
    <meta name="theme-color" content="#ffffff"/>
    <title>libvirt: Snapshot XML format</title>
    <meta name="description" content="libvirt, virtualization, virtualization API"/>
    <script type="text/javascript" src="js/main.js">
      <!--// forces non-empty element-->
    </script>
  </head>
  <body onload="pageload()">
    <div id="body">
      <div class="document" id="snapshot-xml-format">
<h1>Snapshot XML format</h1>

<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#snapshot-xml" id="id1">Snapshot XML</a></p></li>
<li><p><a class="reference internal" href="#examples" id="id2">Examples</a></p></li>
</ul>
</div>
<div class="section" id="snapshot-xml">
<h1><a class="toc-backref" href="#id1">Snapshot XML</a><a class="headerlink" href="#snapshot-xml" title="Link to this headline">¶</a></h1>
<p>Snapshots are one form of <a class="reference external" href="kbase/domainstatecapture.html">domain state
capture</a>. There are several types of
snapshots:</p>
<dl class="simple">
<dt>disk snapshot</dt>
<dd><p>Contents of disks (whether a subset or all disks associated with the domain)
are saved at a given point of time, and can be restored back to that state.
On a running guest, a disk snapshot is likely to be only crash-consistent
rather than clean (that is, it represents the state of the disk on a sudden
power outage, and may need fsck or journal replays to be made consistent); on
an inactive guest, a disk snapshot is clean if the disks were clean when the
guest was last shut down. Disk snapshots exist in two forms: internal (file
formats such as qcow2 track both the snapshot and changes since the snapshot
in a single file) and external (the snapshot is one file, and the changes
since the snapshot are in another file).</p>
</dd>
<dt>memory state (or VM state)</dt>
<dd><p>Tracks only the state of RAM and all other resources in use by the VM. If the
disks are unmodified between the time a VM state snapshot is taken and
restored, then the guest will resume in a consistent state; but if the disks
are modified externally in the meantime, this is likely to lead to data
corruption.</p>
</dd>
<dt>full system</dt>
<dd><p>A combination of disk snapshots for all disks as well as VM memory state,
which can be used to resume the guest from where it left off with symptoms
similar to hibernation (that is, TCP connections in the guest may have timed
out, but no files or processes are lost).</p>
</dd>
</dl>
<p>Libvirt can manage all three types of snapshots. For now, VM state (memory)
snapshots are created only by the <span class="docutils literal">virDomainSave()</span>, <span class="docutils literal">virDomainSaveFlags</span>,
<span class="docutils literal">virDomainSaveParams</span> and <span class="docutils literal">virDomainManagedSave()</span> functions, and restored
via the <span class="docutils literal">virDomainRestore()</span>, <span class="docutils literal">virDomainRestoreFlags()</span>,
<span class="docutils literal">virDomainRestoreParams</span>, <span class="docutils literal">virDomainCreate()</span>, and
<span class="docutils literal">virDomainCreateWithFlags()</span> functions (as well as via domain autostart). With
managed snapshots, libvirt tracks all information internally; with save images,
the user tracks the snapshot file, but libvirt provides functions such as
<span class="docutils literal">virDomainSaveImageGetXMLDesc()</span> to work with those files.</p>
<p>Full system snapshots are created by <span class="docutils literal">virDomainSnapshotCreateXML()</span> with no
flags, while disk snapshots are created by the same function with the
<span class="docutils literal">VIR_DOMAIN_SNAPSHOT_CREATE_DISK_ONLY</span> flag. Regardless of the flags provided,
restoration of the snapshot is handled by the <span class="docutils literal">virDomainRevertToSnapshot()</span>
function. For these types of snapshots, libvirt tracks each snapshot as a
separate <span class="docutils literal">virDomainSnapshotPtr</span> object, and maintains a tree relationship of
which snapshots descended from an earlier point in time. The vzct driver does
not support disk snapshots.</p>
<p>Attributes of libvirt snapshots are stored as child elements of the
<span class="docutils literal">domainsnapshot</span> element. At snapshot creation time, normally only the
<span class="docutils literal">name</span>, <span class="docutils literal">description</span>, and <span class="docutils literal">disks</span> elements are settable; the rest of the
fields are ignored on creation, and will be filled in by libvirt in for
informational purposes by <span class="docutils literal">virDomainSnapshotGetXMLDesc()</span>. However, when
redefining a snapshot ( <span class="since">since 0.9.5</span> ), with the
<span class="docutils literal">VIR_DOMAIN_SNAPSHOT_CREATE_REDEFINE</span> flag of
<span class="docutils literal">virDomainSnapshotCreateXML()</span>, all of the XML described here is relevant on
input, even the fields that are normally described as readonly for output.</p>
<p>Snapshots are maintained in a hierarchy. A domain can have a current snapshot,
which is the most recent snapshot compared to the current state of the domain
(although a domain might have snapshots without a current snapshot, if snapshots
have been deleted in the meantime). Creating or reverting to a snapshot sets
that snapshot as current, and the prior current snapshot is the parent of the
new snapshot. Branches in the hierarchy can be formed by reverting to a snapshot
with a child, then creating another snapshot. For now, the creation of external
snapshots when checkpoints exist is forbidden, although future work will make it
possible to integrate these two concepts.</p>
<p>The top-level <span class="docutils literal">domainsnapshot</span> element may contain the following elements:</p>
<p><span class="docutils literal">name</span></p>
<blockquote>
<p>The optional name for this snapshot. If the name is omitted, libvirt will
create a name based on the time of the creation.</p>
<p>In case of the vzct driver, the name is always generated and cannot
be specified on input. The generated names are not based on snapshot
creation time.</p>
</blockquote>
<p><span class="docutils literal">description</span></p>
<blockquote>
<p>An optional human-readable description of the snapshot. If the description
is omitted when initially creating the snapshot, then this field will be
empty.</p>
</blockquote>
<p><span class="docutils literal">memory</span></p>
<blockquote>
<p>On input, this is an optional request for how to handle VM memory state. For
an offline domain or a disk-only snapshot, attribute <span class="docutils literal">snapshot</span> must be
<span class="docutils literal">no</span>, since there is no VM state saved; otherwise, the attribute can be
<span class="docutils literal">internal</span> if the memory state is piggy-backed with other internal disk
state, or <span class="docutils literal">external</span> along with a second attribute <span class="docutils literal">file</span> giving the
absolute path of the file holding the VM memory state. <span class="since">Since 1.0.1</span></p>
<p>The vzct driver only supports &lt;code&gt;internal&lt;/code&gt; memory snapshots
for active domains</p>
</blockquote>
<p><span class="docutils literal">disks</span></p>
<blockquote>
<p>On input, this is an optional listing of specific instructions for disk
snapshots; it is needed when making a snapshot of only a subset of the disks
associated with a domain, or when overriding the domain defaults for how to
snapshot each disk, or for providing specific control over what file name is
created in an external snapshot. On output, this is fully populated to show
the state of each disk in the snapshot, including any properties that were
generated by the hypervisor defaults. For full system snapshots, this field
is ignored on input and omitted on output (a full system snapshot implies
that all disks participate in the snapshot process). This element has a list
of <span class="docutils literal">disk</span> sub-elements, describing anywhere from zero to all of the disks
associated with the domain. <span class="since">Since 0.9.5</span></p>
<p>The vzct driver does not support selecting disks to snapshot.
All disks are snapshotted.</p>
<p><span class="docutils literal">disk</span></p>
<blockquote>
<p>This sub-element describes the snapshot properties of a specific disk.
The attribute <span class="docutils literal">name</span> is mandatory, and must match either the <span class="docutils literal">&lt;target <span class="pre">dev='name'/&gt;</span></span> (recommended) or an unambiguous <span class="docutils literal">&lt;source <span class="pre">file='name'/&gt;</span></span>
of one of the <a class="reference external" href="formatdomain.html#hard-drives-floppy-disks-cdroms">disk devices</a>
specified for the domain at the time of the snapshot. The attribute
<span class="docutils literal">snapshot</span> is optional, and the possible values are the same as the
<span class="docutils literal">snapshot</span> attribute for <a class="reference external" href="formatdomain.html#hard-drives-floppy-disks-cdroms">disk devices</a> (<span class="docutils literal">no</span>, <span class="docutils literal">internal</span>, or
<span class="docutils literal">external</span>). Some hypervisors like ESX require that if specified, the
snapshot mode must not override any snapshot mode attached to the
corresponding domain disk, while others like qemu allow this field to
override the domain default.</p>
<p><span class="since">Since 8.2.0</span> the <span class="docutils literal">snapshot</span> attribute supports the <span class="docutils literal">manual</span>
value which instructs the hypervisor to create the snapshot and keep a
synchronized state by pausing the VM which allows to snapshot disk
storage from outside of the hypervisor if the storage provider supports
it.  The caller is responsible for resuming a VM paused by requesting a
<span class="docutils literal">manual</span> snapshot. When reverting such snapshot, the expectation is that
the storage is configured in a way where the hypervisor will see the
correct image state.</p>
<p><span class="since">Since 1.2.2</span> the <span class="docutils literal">disk</span> element supports an optional attribute
<span class="docutils literal">type</span> if the <span class="docutils literal">snapshot</span> attribute is set to <span class="docutils literal">external</span>. This
attribute specifies the snapshot target storage type and allows to
overwrite the default <span class="docutils literal">file</span> type. The <span class="docutils literal">type</span> attribute along with
the format of the <span class="docutils literal">source</span> sub-element is identical to the <span class="docutils literal">source</span>
element used in domain disk definitions. See the <a class="reference external" href="formatdomain.html#hard-drives-floppy-disks-cdroms">disk devices</a> section documentation for further
information. Libvirt currently supports the <span class="docutils literal">type</span> element in the qemu
driver and supported values are <span class="docutils literal">file</span>, <span class="docutils literal">block</span> and <span class="docutils literal">network</span>
<span class="since">(since 1.2.2)</span>.</p>
<p><span class="docutils literal">source</span></p>
<blockquote>
<p>If the snapshot mode is external (whether specified or inherited),
then there is an optional sub-element <span class="docutils literal">source</span>, with an attribute
<span class="docutils literal">file</span> giving the name of the new file. If <span class="docutils literal">source</span> is not given
and the disk is backed by a local image file (not a block device or
remote storage), a file name is generated that consists of the
existing file name with anything after the trailing dot replaced by
the snapshot name. Remember that with external snapshots, the original
file name becomes the read-only snapshot, and the new file name
contains the read-write delta of all disk changes since the snapshot.</p>
<p>The <span class="docutils literal">source</span> element also may contain the <span class="docutils literal">seclabel</span> element
(described in the <a class="reference external" href="formatdomain.html#security-label">domain XML documentation</a>) which can be used to override the
domain security labeling policy for <span class="docutils literal">source</span>.</p>
</blockquote>
<p><span class="docutils literal">driver</span></p>
<blockquote>
<p>An optional sub-element <span class="docutils literal">driver</span>, with an attribute <span class="docutils literal">type</span> giving
the driver type (such as qcow2), of the new file created by the
external snapshot of the new file. Optionally <span class="docutils literal">metadata_cache</span>
sub-element can be used with same semantics as the identically named
subelement of the domain definition disk's driver.</p>
</blockquote>
</blockquote>
</blockquote>
<p><span class="docutils literal">creationTime</span></p>
<blockquote>
<p>A readonly representation of the time this snapshot was created. The time is
specified in seconds since the Epoch, UTC (i.e. Unix time).</p>
</blockquote>
<p><span class="docutils literal">state</span></p>
<blockquote>
<p>A readonly representation of the state of the domain at the time this
snapshot was taken. If a full system snapshot was created, then this is the
state of the domain at that time. When the domain is reverted to this
snapshot, the domain's state will default to this state, unless overridden
by <span class="docutils literal">virDomainRevertToSnapshot()</span> flags to revert to a running or paused
state.  Additionally, this field can be the value "disk-snapshot" (
<span class="since">since 0.9.5</span>) when it represents only a disk snapshot (no VM memory
state), and reverting to this snapshot will default to an inactive guest.</p>
<p>The vzct driver only provides &lt;code&gt;state&lt;/code&gt; information
for snapshots created via libvirt and not by vzctl/prlctl/vzsdk.</p>
</blockquote>
<p><span class="docutils literal">parent</span></p>
<blockquote>
<p>Readonly, present only if this snapshot has a parent. The parent name is
given by the sub-element <span class="docutils literal">name</span>. The parent relationship allows tracking a
tree of related snapshots.</p>
</blockquote>
<p><span class="docutils literal">domain</span></p>
<blockquote>
<p>A readonly representation of the domain that this snapshot was taken
against.  Older versions of libvirt stored only a single child element,
uuid; reverting to a snapshot like this is risky if the current state of the
domain differs from the state that the domain was created in, and requires
the use of the <span class="docutils literal">VIR_DOMAIN_SNAPSHOT_REVERT_FORCE</span> flag in
<span class="docutils literal">virDomainRevertToSnapshot()</span>.  Newer versions of libvirt ( <span class="since">since
0.9.5</span> ) store the entire inactive <a class="reference external" href="formatdomain.html">domain configuration</a> at the time of the snapshot ( <span class="since">since 0.9.5</span> ).
The domain will have security-sensitive information omitted unless the flag
<span class="docutils literal">VIR_DOMAIN_SNAPSHOT_XML_SECURE</span> is provided on a read-write connection.</p>
<p>The vzct driver provides domain XML when a snapshot is taken only if
the snapshot is taken via libvirt and not by vzctl/prlctl/vzsdk. In the
latter case, only the UUID is provided but there is no risk in reverting
to the snapshot as described above for the qemu driver.</p>
</blockquote>
<dl>
<dt><span class="docutils literal">inactiveDomain</span></dt>
<dd><blockquote>
<p>Inactive domain configuration of an active persistent domain. Such domains
have two distinct configs, and the inactive one is stored here. It is
different from <cite>domain</cite> that, more presisely, keeps the "inactive portion"
of an active config ( <span class="since">since 5.0.0</span> ).</p>
</blockquote>
<p>The vzct driver provides inactive domain XML when a snapshot is taken
only if the snapshot is taken via libvirt and not by
vzctl/prlctl/vzsdk.</p>
</dd>
</dl>
<p><span class="docutils literal">cookie</span></p>
<blockquote>
<p>An optional readonly representation of a save image cookie containing
additional data libvirt may need to properly restore a domain from an active
snapshot when such data cannot be stored directly in the <span class="docutils literal">domain</span> to
maintain compatibility with older libvirt or hypervisor.</p>
</blockquote>
</div>
<div class="section" id="examples">
<h1><a class="toc-backref" href="#id2">Examples</a><a class="headerlink" href="#examples" title="Link to this headline">¶</a></h1>
<p>Using this XML to create a disk snapshot of just vda on a qemu domain with two
disks:</p>
<pre class="literal-block">&lt;domainsnapshot&gt;
  &lt;description&gt;Snapshot of OS install and updates&lt;/description&gt;
  &lt;disks&gt;
    &lt;disk name='vda'&gt;
      &lt;source file='/path/to/new'/&gt;
    &lt;/disk&gt;
    &lt;disk name='vdb' snapshot='no'/&gt;
    &lt;disk name='vdc'&gt;
      &lt;source file='/path/to/newc'&gt;
        &lt;seclabel model='dac' relabel='no'/&gt;
      &lt;/source&gt;
    &lt;/disk&gt;
  &lt;/disks&gt;
&lt;/domainsnapshot&gt;</pre>
<p>will result in XML similar to this from <span class="docutils literal">virDomainSnapshotGetXMLDesc()</span>:</p>
<pre class="literal-block">&lt;domainsnapshot&gt;
  &lt;name&gt;1270477159&lt;/name&gt;
  &lt;description&gt;Snapshot of OS install and updates&lt;/description&gt;
  &lt;state&gt;running&lt;/state&gt;
  &lt;creationTime&gt;1270477159&lt;/creationTime&gt;
  &lt;parent&gt;
    &lt;name&gt;bare-os-install&lt;/name&gt;
  &lt;/parent&gt;
  &lt;memory snapshot='no'/&gt;
  &lt;disks&gt;
    &lt;disk name='vda' snapshot='external'&gt;
      &lt;driver type='qcow2'/&gt;
      &lt;source file='/path/to/new'/&gt;
    &lt;/disk&gt;
    &lt;disk name='vdb' snapshot='no'/&gt;
  &lt;/disks&gt;
  &lt;domain&gt;
    &lt;name&gt;fedora&lt;/name&gt;
    &lt;uuid&gt;93a5c045-6457-2c09-e56c-927cdf34e178&lt;/uuid&gt;
    &lt;memory&gt;1048576&lt;/memory&gt;
    ...
    &lt;devices&gt;
      &lt;disk type='file' device='disk'&gt;
        &lt;driver name='qemu' type='raw'/&gt;
        &lt;source file='/path/to/old'/&gt;
        &lt;target dev='vda' bus='virtio'/&gt;
      &lt;/disk&gt;
      &lt;disk type='file' device='disk' snapshot='external'&gt;
        &lt;driver name='qemu' type='raw'/&gt;
        &lt;source file='/path/to/old2'/&gt;
        &lt;target dev='vdb' bus='virtio'/&gt;
      &lt;/disk&gt;
      ...
    &lt;/devices&gt;
  &lt;/domain&gt;
&lt;/domainsnapshot&gt;</pre>
<p>With that snapshot created, <span class="docutils literal">/path/to/old</span> is the read-only backing file to
the new active file <span class="docutils literal">/path/to/new</span>. The <span class="docutils literal">&lt;domain&gt;</span> element within the
snapshot xml records the state of the domain just before the snapshot; a call to
<span class="docutils literal">virDomainGetXMLDesc()</span> will show that the domain has been changed to reflect
the snapshot:</p>
<pre class="literal-block">&lt;domain&gt;
  &lt;name&gt;fedora&lt;/name&gt;
  &lt;uuid&gt;93a5c045-6457-2c09-e56c-927cdf34e178&lt;/uuid&gt;
  &lt;memory&gt;1048576&lt;/memory&gt;
  ...
  &lt;devices&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='qcow2'/&gt;
      &lt;source file='/path/to/new'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
    &lt;/disk&gt;
    &lt;disk type='file' device='disk' snapshot='external'&gt;
      &lt;driver name='qemu' type='raw'/&gt;
      &lt;source file='/path/to/old2'/&gt;
      &lt;target dev='vdb' bus='virtio'/&gt;
    &lt;/disk&gt;
    ...
  &lt;/devices&gt;
&lt;/domain&gt;</pre>
</div>
</div>
    </div>
    <div id="nav">
      <div id="home">
        <a href="index.html">Home</a>
      </div>
      <div id="jumplinks">
        <ul>
          <li>
            <a href="downloads.html">Download</a>
          </li>
          <li>
            <a href="contribute.html">Contribute</a>
          </li>
          <li>
            <a href="docs.html">Docs</a>
          </li>
        </ul>
      </div>
      <div id="search">
        <form id="simplesearch" action="https://www.google.com/search" enctype="application/x-www-form-urlencoded" method="get">
          <div>
            <input id="searchsite" name="sitesearch" type="hidden" value="libvirt.org"/>
            <input id="searchq" name="q" type="text" size="12" value=""/>
            <input name="submit" type="submit" value="Go"/>
          </div>
        </form>
        <div id="advancedsearch">
          <span>
            <input type="radio" name="what" id="whatwebsite" checked="checked" value="website"/>
            <label for="whatwebsite">Website</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatwiki" value="wiki"/>
            <label for="whatwiki">Wiki</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatdevs" value="devs"/>
            <label for="whatdevs">Developers list</label>
          </span>
          <span>
            <input type="radio" name="what" id="whatusers" value="users"/>
            <label for="whatusers">Users list</label>
          </span>
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="contact">
        <h3>Contact</h3>
        <ul>
          <li>
            <a href="contact.html#mailing-lists">email</a>
          </li>
          <li>
            <a href="contact.html#irc">irc</a>
          </li>
        </ul>
      </div>
      <div id="community">
        <h3>Community</h3>
        <ul>
          <li>
            <a href="https://twitter.com/hashtag/libvirt">twitter</a>
          </li>
          <li>
            <a href="https://stackoverflow.com/questions/tagged/libvirt">stackoverflow</a>
          </li>
          <li>
            <a href="https://serverfault.com/questions/tagged/libvirt">serverfault</a>
          </li>
        </ul>
      </div>
      <div id="contribute">
        <h3>Contribute</h3>
        <ul>
          <li>
            <a href="https://gitlab.com/libvirt/libvirt/-/blob/master/docs/formatsnapshot.rst">edit this page</a>
          </li>
        </ul>
      </div>
      <div id="conduct">
            Participants in the libvirt project agree to abide by <a href="governance.html#code-of-conduct">the project code of conduct</a></div>
      <br class="clear"/>
    </div>
  </body>
</html>
